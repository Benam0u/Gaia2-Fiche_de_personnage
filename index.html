<!--
  Créé par Benam0u - 2025/07/08
  GAIA 2 - Fiche de personnage
-->

<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Fiche de personnage</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    /* ========== WIZARD DE CRÉATION ========== */
    .wizard-container {
      max-width: 1000px;
      margin: 2rem auto;
      padding: 1rem;
      overflow: hidden;
    }
    
    .wizard-header {
      text-align: center;
      margin-bottom: 2rem;
    }
    
    .wizard-title {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      font-size: 28px;
      color: #2c3e50;
      margin-bottom: 0.5rem;
    }
    
    .wizard-subtitle {
      color: #7f8c8d;
      font-size: 16px;
    }
    
    .btn-start-wizard {
      display: block;
      width: 100%;
      background: #8b0000;
      color: #fff;
      font-size: 18px;
      font-weight: bold;
      padding: 1.25rem 2rem;
      border: 2px solid #8b0000;
      border-radius: 1rem;
      cursor: pointer;
      transition: all 0.2s ease;
      box-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
      text-align: center;
    }
    
    .btn-start-wizard:hover {
      background: #a52a2a;
      border-color: #a52a2a;
      transform: translateY(-2px);
      box-shadow: 4px 4px 8px rgba(0, 0, 0, 0.15);
    }
    
    .btn-skip-wizard {
      display: none; /* Plus utilisé */
    }
    
    .main-menu-buttons {
      display: flex;
      flex-direction: column;
      gap: 1rem;
      align-items: center;
      max-width: 600px;
      margin: 0 auto;
    }
    
    .btn-menu-option {
      display: block;
      width: 100%;
      background: #fff;
      color: #333;
      font-size: 16px;
      font-weight: bold;
      padding: 1rem 1.5rem;
      border: 2px solid #333;
      border-radius: 1rem;
      cursor: pointer;
      transition: all 0.2s ease;
      box-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
      text-align: center;
    }
    
    .btn-menu-option:hover {
      background: #8b0000;
      color: #fff;
      border-color: #8b0000;
      transform: translateY(-2px);
      box-shadow: 4px 4px 8px rgba(0, 0, 0, 0.15);
    }
    
    .btn-menu-option .btn-icon {
      display: block;
      font-size: 24px;
      margin-bottom: 0.25rem;
    }
    
    /* Bouton retour au menu */
    .btn-back-menu {
      display: block;
      margin: 1rem auto;
      background: #fff;
      color: #8b0000;
      font-size: 14px;
      font-weight: bold;
      padding: 0.75rem 1.5rem;
      border: 2px solid #8b0000;
      border-radius: 1rem;
      cursor: pointer;
      transition: all 0.2s ease;
      box-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
    }
    
    .btn-back-menu:hover {
      background: #8b0000;
      color: #fff;
    }
    
    /* Bouton Level Up depuis fiche libre */
    .btn-levelup-free {
      display: block;
      margin: 0.5rem auto;
      background: #fff;
      color: #8b0000;
      font-size: 14px;
      font-weight: bold;
      padding: 0.75rem 1.5rem;
      border: 2px solid #8b0000;
      border-radius: 1rem;
      cursor: pointer;
      transition: all 0.2s ease;
      box-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
    }
    
    .btn-levelup-free:hover {
      background: #8b0000;
      color: #fff;
      transform: translateY(-2px);
      box-shadow: 4px 4px 8px rgba(0, 0, 0, 0.15);
    }
    
    /* Wizard Steps Container */
    .wizard-steps {
      display: none;
    }
    
    .wizard-steps.active {
      display: block;
    }
    
    /* Progress Bar */
    .wizard-progress {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 2rem;
      padding: 0 1rem;
      position: relative;
    }
    
    .wizard-progress::before {
      content: '';
      position: absolute;
      top: 18px;
      left: 2rem;
      right: 2rem;
      height: 3px;
      background: #ecf0f1;
      z-index: 0;
    }
    
    .progress-step {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      z-index: 1;
      cursor: pointer;
      min-height: 70px;
    }
    
    .progress-step .step-number {
      width: 36px;
      height: 36px;
      min-height: 36px;
      border-radius: 50%;
      background: #ecf0f1;
      color: #95a5a6;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      font-weight: bold;
      font-size: 14px;
      transition: all 0.3s ease;
      border: 3px solid #ecf0f1;
    }
    
    .progress-step.active .step-number {
      background: #8b0000;
      color: #fff;
      border-color: #8b0000;
    }
    
    .progress-step.completed .step-number {
      background: #27ae60;
      color: #fff;
      border-color: #27ae60;
    }
    
    .progress-step .step-label {
      font-size: 11px;
      color: #95a5a6;
      margin-top: 0.5rem;
      text-align: center;
      max-width: 80px;
    }
    
    .progress-step.active .step-label,
    .progress-step.completed .step-label {
      color: #2c3e50;
      font-weight: bold;
    }
    
    /* Step Content */
    .step-content {
      display: none;
      background: #fff;
      border: 2px solid #333;
      border-radius: 1rem;
      padding: 1.5rem;
      box-shadow: 2px 2px 8px rgba(0,0,0,0.1);
      margin-bottom: 1rem;
      overflow-x: auto;
      max-width: 100%;
      box-sizing: border-box;
    }
    
    .step-content.active {
      display: block;
      animation: fadeIn 0.3s ease;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .step-title {
      font-size: 22px;
      color: #8b0000;
      margin: 0 0 0.5rem 0;
      text-align: center;
    }
    
    .step-description {
      color: #666;
      text-align: center;
      margin-bottom: 1.5rem;
      font-size: 14px;
    }
    
    /* Options Grid */
    .options-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 1rem;
    }
    
    /* Grille 4 colonnes pour les avantages */
    .options-grid-4col {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 1rem;
      max-width: 100%;
      overflow: hidden;
    }
    
    /* Responsive: réduire les colonnes sur petits écrans */
    @media (max-width: 1200px) {
      .options-grid-4col {
        grid-template-columns: repeat(3, 1fr);
      }
    }
    
    @media (max-width: 900px) {
      .options-grid-4col {
        grid-template-columns: repeat(2, 1fr);
      }
    }
    
    /* Carte simple sans image */
    .option-card-simple {
      border: 2px solid #ddd;
      border-radius: 0.75rem;
      padding: 1rem;
      cursor: pointer;
      transition: all 0.2s ease;
      background: #fafafa;
    }
    
    .option-card-simple:hover {
      border-color: #8b0000;
      background: #fff;
      transform: translateY(-2px);
    }
    
    .option-card-simple.selected {
      border-color: #8b0000;
      background: #fff5f5;
      box-shadow: 0 0 0 3px rgba(139, 0, 0, 0.1);
    }
    
    .option-card-simple .option-name {
      font-weight: bold;
      font-size: 14px;
      color: #2c3e50;
      margin-bottom: 0.25rem;
    }
    
    .option-card-simple .option-desc {
      font-size: 12px;
      color: #333;
    }
    
    /* Checkbox simple pour grille 4 colonnes */
    .option-checkbox-simple {
      display: flex;
      align-items: flex-start;
      gap: 0.5rem;
      border: 2px solid #ddd;
      border-radius: 0.5rem;
      padding: 0.75rem;
      cursor: pointer;
      transition: all 0.2s ease;
      background: #fafafa;
      overflow: hidden;
      word-wrap: break-word;
      min-width: 0;
    }
    
    .option-checkbox-simple > div {
      min-width: 0;
      overflow: hidden;
    }
    
    .option-checkbox-simple:hover {
      border-color: #8b0000;
      background: #fff;
    }
    
    .option-checkbox-simple.selected {
      border-color: #8b0000;
      background: #fff5f5;
    }
    
    .option-checkbox-simple .checkbox-mark {
      width: 18px;
      height: 18px;
      border: 2px solid #8b0000;
      border-radius: 3px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      font-size: 12px;
    }
    
    .option-checkbox-simple.selected .checkbox-mark::after {
      content: '✓';
      color: #8b0000;
      font-weight: bold;
    }
    
    .option-checkbox-simple .option-name {
      font-weight: bold;
      font-size: 13px;
      color: #2c3e50;
      margin-bottom: 0.15rem;
      word-wrap: break-word;
      overflow-wrap: break-word;
    }
    
    .option-checkbox-simple .option-desc {
      font-size: 11px;
      color: #333;
      word-wrap: break-word;
      overflow-wrap: break-word;
    }
    
    /* Section titles for advantages */
    .advantages-section-title {
      font-size: 1rem;
      font-weight: bold;
      color: #8b0000;
      margin: 1.5rem 0 0.75rem 0;
      padding-bottom: 0.5rem;
      border-bottom: 2px solid #8b0000;
    }
    
    .advantages-section-title:first-child {
      margin-top: 0;
    }
    
    /* Custom advantages */
    .custom-advantages-container {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      margin-top: 0.5rem;
    }
    
    .custom-advantage-card {
      flex: 1;
      min-width: 280px;
      max-width: calc(50% - 0.5rem);
      border: 2px solid #8b0000;
      border-radius: 0.5rem;
      padding: 0.75rem;
      background: #fff5f5;
    }
    
    .custom-advantage-header {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 0.5rem;
    }
    
    .custom-advantage-name {
      flex: 1;
      padding: 0.5rem;
      border: 1px solid #ddd;
      border-radius: 0.25rem;
      font-weight: bold;
      font-size: 13px;
    }
    
    .custom-advantage-name:focus {
      outline: none;
      border-color: #8b0000;
    }
    
    .custom-advantage-remove {
      width: 28px;
      height: 28px;
      border: none;
      background: #e74c3c;
      color: white;
      border-radius: 0.25rem;
      cursor: pointer;
      font-size: 18px;
      line-height: 1;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .custom-advantage-remove:hover {
      background: #c0392b;
    }
    
    .custom-advantage-desc {
      width: 100%;
      min-height: 60px;
      padding: 0.5rem;
      border: 1px solid #ddd;
      border-radius: 0.25rem;
      resize: vertical;
      font-size: 11px;
      font-family: inherit;
    }
    
    .custom-advantage-desc:focus {
      outline: none;
      border-color: #8b0000;
    }
    
    .custom-advantage-add {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-width: 280px;
      max-width: calc(50% - 0.5rem);
      min-height: 120px;
      border: 2px dashed #bbb;
      border-radius: 0.5rem;
      padding: 1rem;
      cursor: pointer;
      transition: all 0.2s ease;
      background: #fafafa;
    }
    
    .custom-advantage-add:hover {
      border-color: #8b0000;
      background: #fff5f5;
    }
    
    .custom-advantage-add .add-icon {
      font-size: 2.5rem;
      color: #8b0000;
      line-height: 1;
    }
    
    .custom-advantage-add .add-text {
      margin-top: 0.5rem;
      font-size: 0.85rem;
      color: #666;
    }
    
    /* Level Up System */
    .levelup-points-display {
      text-align: center;
      margin-bottom: 1.5rem;
      padding: 1rem;
      background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
      border-radius: 0.75rem;
      border: 2px solid #ddd;
    }
    
    .levelup-points-remaining {
      font-size: 2rem;
      font-weight: bold;
      color: #27ae60;
    }
    
    .levelup-points-remaining.warning {
      color: #f39c12;
    }
    
    .levelup-points-remaining.spent {
      color: #8b0000;
    }
    
    .levelup-options-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 1rem;
      margin-bottom: 1.5rem;
    }
    
    @media (max-width: 900px) {
      .levelup-options-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }
    
    .levelup-option-card {
      border: 2px solid #ddd;
      border-radius: 0.75rem;
      padding: 1rem;
      cursor: pointer;
      transition: all 0.2s ease;
      background: #fafafa;
      text-align: center;
    }
    
    .levelup-option-card:hover:not(.disabled) {
      border-color: #8b0000;
      background: #fff;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    
    .levelup-option-card.selected {
      border-color: #8b0000;
      background: #fff5f5;
      box-shadow: 0 0 0 3px rgba(139, 0, 0, 0.1);
    }
    
    .levelup-option-card.disabled {
      opacity: 0.5;
      cursor: not-allowed;
      background: #eee;
    }
    
    .levelup-option-cost {
      display: inline-block;
      background: #8b0000;
      color: #fff;
      font-weight: bold;
      font-size: 14px;
      padding: 0.25rem 0.75rem;
      border-radius: 1rem;
      margin-bottom: 0.5rem;
    }
    
    .levelup-option-name {
      font-weight: bold;
      font-size: 14px;
      color: #2c3e50;
      margin-bottom: 0.25rem;
    }
    
    .levelup-option-desc {
      font-size: 11px;
      color: #666;
    }
    
    .levelup-selection-panel {
      border: 2px solid #8b0000;
      border-radius: 0.75rem;
      padding: 1rem;
      margin-top: 1rem;
      background: #fff5f5;
    }
    
    .levelup-selection-title {
      font-weight: bold;
      font-size: 16px;
      color: #8b0000;
      margin-bottom: 1rem;
      padding-bottom: 0.5rem;
      border-bottom: 2px solid #8b0000;
    }
    
    .levelup-choices-list {
      margin-top: 1rem;
      padding: 0.75rem;
      background: #f8f9fa;
      border-radius: 0.5rem;
      border: 1px solid #ddd;
    }
    
    .levelup-choice-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.5rem;
      margin-bottom: 0.5rem;
      background: #fff;
      border-radius: 0.25rem;
      border: 1px solid #ddd;
    }
    
    .levelup-choice-item:last-child {
      margin-bottom: 0;
    }
    
    .levelup-choice-remove {
      background: #e74c3c;
      color: #fff;
      border: none;
      border-radius: 0.25rem;
      padding: 0.25rem 0.5rem;
      cursor: pointer;
      font-size: 12px;
    }
    
    .levelup-choice-remove:hover {
      background: #c0392b;
    }

    .option-card {
      display: flex;
      flex-direction: row;
      align-items: stretch;
      border: 2px solid #ddd;
      border-radius: 0.75rem;
      overflow: hidden;
      cursor: pointer;
      transition: all 0.2s ease;
      background: #fafafa;
    }
    
    .option-card .option-img {
      width: 50%;
      min-height: 150px;
      object-fit: contain;
      background: #f0f0f0;
      flex-shrink: 0;
    }
    
    .option-card .option-content {
      width: 50%;
      padding: 1rem;
    }
    
    .option-card:hover {
      border-color: #8b0000;
      background: #fff;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    
    .option-card.selected {
      border-color: #8b0000;
      background: linear-gradient(135deg, #fff5f5 0%, #fff 100%);
      box-shadow: 0 0 0 3px rgba(139, 0, 0, 0.2);
    }
    
    .option-card .option-name,
    .option-checkbox .option-name {
      font-weight: bold;
      font-size: 16px;
      color: #2c3e50;
      margin-bottom: 0.25rem;
    }
    
    .option-card .option-desc,
    .option-checkbox .option-desc {
      font-size: 13px;
      color: #333;
      margin-bottom: 0.5rem;
    }
    
    .option-card .option-bonuses {
      font-size: 12px;
      color: #333;
      list-style: disc;
      padding-left: 1.2rem;
      margin: 0.5rem 0 0 0;
    }
    
    .option-card .option-bonuses li {
      margin-bottom: 0.15rem;
    }
    
    .option-card .option-maluses {
      font-size: 12px;
      color: #333;
      list-style: disc;
      padding-left: 1.2rem;
      margin: 0.25rem 0 0 0;
    }
    
    .option-card .option-maluses li {
      margin-bottom: 0.15rem;
    }
    
    /* Dice System for Attributes */
    .dice-pool {
      display: flex;
      justify-content: center;
      gap: 0.5rem;
      flex-wrap: wrap;
      margin-bottom: 1.5rem;
      background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
      padding: 1rem;
      border-radius: 0.75rem;
      border: 2px dashed #bdc3c7;
    }
    
    /* Attribute distribution grid */
    .attr-distribute {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 0.75rem;
    }
    
    /* Name and alignment layout */
    .name-alignment-grid {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 1rem;
      margin-bottom: 1.5rem;
    }
    
    /* Stats recap grid */
    .stats-recap-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 1rem;
    }
    
    /* Level up controls */
    .levelup-controls {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 1rem;
      margin-bottom: 1.5rem;
      flex-wrap: wrap;
      padding: 0 0.5rem;
    }
    
    .dice-item {
      width: 60px;
      height: 60px;
      border: 3px solid #8b0000;
      border-radius: 0.5rem;
      background: linear-gradient(135deg, #fff 0%, #f8f9fa 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      font-size: 18px;
      color: #8b0000;
      cursor: grab;
      transition: all 0.2s ease;
      box-shadow: 2px 2px 8px rgba(0,0,0,0.1);
    }
    
    .dice-item:hover {
      transform: scale(1.1);
      box-shadow: 0 4px 15px rgba(139, 0, 0, 0.3);
    }
    
    .dice-item.selected {
      background: #8b0000;
      color: #fff;
      transform: scale(1.15);
    }
    
    .dice-item.used {
      opacity: 0.3;
      cursor: not-allowed;
      border-style: dashed;
    }
    
    .attr-item {
      text-align: center;
      padding: 1rem 0.5rem;
      border: 2px solid #ddd;
      border-radius: 0.75rem;
      background: #fafafa;
      cursor: pointer;
      transition: all 0.2s ease;
      min-height: 120px;
      display: flex;
      flex-direction: column;
      justify-content: center;
    }
    
    .attr-item:hover {
      border-color: #8b0000;
      background: #fff;
    }
    
    .attr-item.has-dice {
      border-color: #27ae60;
      background: linear-gradient(135deg, #f0fff4 0%, #fff 100%);
    }
    
    .attr-item.selected-target {
      border-color: #8b0000;
      border-width: 3px;
      background: #fff5f5;
      box-shadow: 0 0 0 4px rgba(139, 0, 0, 0.2);
    }
    
    .attr-item label {
      display: block;
      font-weight: bold;
      color: #666;
      margin-bottom: 0.5rem;
      font-size: 14px;
      pointer-events: none;
    }
    
    .attr-item .attr-dice-display {
      font-size: 24px;
      font-weight: bold;
      color: #8b0000;
      margin: 0.25rem 0;
    }
    
    .attr-item .attr-value-display {
      font-size: 14px;
      color: #666;
    }
    
    .attr-item .attr-empty {
      font-size: 14px;
      color: #999;
      font-style: italic;
    }
    
    .dice-instructions {
      text-align: center;
      font-size: 13px;
      color: #666;
      margin-bottom: 1rem;
      padding: 0.5rem;
      background: #fff3cd;
      border-radius: 0.5rem;
    }
    
    /* Competences Distribution */
    .comp-distribute {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 0.5rem;
    }
    
    .comp-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0.5rem 0.75rem;
      border: 1px solid #ddd;
      border-radius: 0.5rem;
      background: #fafafa;
      font-size: 14px;
    }
    
    .comp-item .comp-info {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    .comp-item .comp-attr {
      background: #eee;
      padding: 0.15rem 0.4rem;
      border-radius: 0.25rem;
      font-size: 11px;
      color: #666;
    }
    
    .comp-item .comp-controls {
      display: flex;
      align-items: center;
      gap: 0.25rem;
    }
    
    .comp-item .comp-controls button {
      width: 22px;
      height: 22px;
      border: none;
      border-radius: 50%;
      background: #8b0000;
      color: #fff;
      font-size: 12px;
      cursor: pointer;
    }
    
    .comp-item .comp-controls button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    
    .comp-item .comp-value {
      font-weight: bold;
      min-width: 30px;
      text-align: center;
    }
    
    .comp-item.has-points {
      background: linear-gradient(135deg, #f0fff4 0%, #fff 100%);
      border-color: #27ae60;
    }
    
    .comp-item .comp-controls button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    
    /* Level Up Section */
    .level-up-section {
      margin-bottom: 1rem;
      padding: 1rem;
      background: #f8f9fa;
      border-radius: 0.5rem;
    }
    
    .level-up-section h4 {
      margin: 0 0 0.75rem 0;
      color: #8b0000;
    }
    
    .level-options {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
    }
    
    .level-option {
      padding: 0.5rem 1rem;
      border: 2px solid #ddd;
      border-radius: 0.5rem;
      cursor: pointer;
      background: #fff;
      font-size: 14px;
      transition: all 0.2s ease;
    }
    
    .level-option:hover {
      border-color: #8b0000;
    }
    
    .level-option.selected {
      border-color: #8b0000;
      background: #fff5f5;
    }
    
    /* Navigation Buttons */
    .step-navigation {
      display: flex;
      justify-content: space-between;
      margin-top: 1.5rem;
      padding-top: 1rem;
      border-top: 1px solid #eee;
    }
    
    .btn-prev, .btn-next, .btn-confirm {
      padding: 0.75rem 1.5rem;
      border-radius: 0.5rem;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .btn-prev {
      background: #fff;
      border: 2px solid #bdc3c7;
      color: #7f8c8d;
    }
    
    .btn-prev:hover {
      border-color: #8b0000;
      color: #8b0000;
    }
    
    .btn-next, .btn-confirm {
      background: #8b0000;
      border: none;
      color: #fff;
    }
    
    .btn-next:hover, .btn-confirm:hover {
      background: #a52a2a;
    }
    
    .btn-next:disabled, .btn-confirm:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    
    /* Checkbox styles for multi-select */
    .option-checkbox {
      display: flex;
      align-items: flex-start;
      gap: 0.75rem;
      padding: 0.75rem;
      border: 2px solid #ddd;
      border-radius: 0.5rem;
      cursor: pointer;
      transition: all 0.2s ease;
      background: #fafafa;
    }
    
    .option-checkbox:hover {
      border-color: #8b0000;
      background: #fff;
    }
    
    .option-checkbox.selected {
      border-color: #8b0000;
      background: #fff5f5;
    }
    
    .option-checkbox input[type="checkbox"] {
      display: none;
    }
    
    .option-checkbox .checkbox-mark {
      width: 20px;
      height: 20px;
      border: 2px solid #8b0000;
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }
    
    .option-checkbox.selected .checkbox-mark::after {
      content: '✓';
      color: #8b0000;
      font-weight: bold;
    }
    
    .selection-count {
      text-align: center;
      font-size: 14px;
      color: #666;
      margin-bottom: 1rem;
    }
    
    .selection-count strong {
      color: #8b0000;
    }
    
    /* Separator before sheet */
    .wizard-separator {
      max-width: 1000px;
      margin: 0 auto 2rem;
      padding: 1rem;
      text-align: center;
      border-top: 3px dashed #8b0000;
    }
    
    .wizard-separator span {
      background: #fdfdfd;
      padding: 0 1rem;
      color: #8b0000;
      font-weight: bold;
      font-size: 18px;
      position: relative;
      top: -1.75rem;
    }
    
    /* Reference Panel Styles */
    .reference-panel {
      max-width: 1000px;
      margin: 0 auto 2rem;
      padding: 1rem;
    }
    
    .reference-buttons {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 0.75rem;
      margin-bottom: 1rem;
    }
    
    .reference-btn {
      padding: 0.75rem 1.25rem;
      border: 2px solid #8b0000;
      border-radius: 2rem;
      background: #fff;
      color: #8b0000;
      font-weight: bold;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    .reference-btn:hover {
      background: #8b0000;
      color: #fff;
    }
    
    .reference-btn.active {
      background: #8b0000;
      color: #fff;
      box-shadow: 0 4px 12px rgba(139, 0, 0, 0.3);
    }
    
    .reference-content {
      display: none;
      background: #fff;
      border: 2px solid #333;
      border-radius: 1rem;
      padding: 1.5rem;
      max-height: 60vh;
      overflow-y: auto;
      box-shadow: 2px 2px 8px rgba(0, 0, 0, 0.1);
    }
    
    .reference-content.active {
      display: block;
      animation: fadeIn 0.3s ease;
    }
    
    .reference-content h3 {
      color: #8b0000;
      text-align: center;
      margin-bottom: 1rem;
      padding-bottom: 0.5rem;
      border-bottom: 2px solid #8b0000;
    }
    
    .reference-close-btn {
      display: block;
      margin: 1rem auto 0;
      padding: 0.5rem 2rem;
      background: #666;
      color: #fff;
      border: none;
      border-radius: 0.5rem;
      font-weight: bold;
      cursor: pointer;
    }
    
    .reference-close-btn:hover {
      background: #8b0000;
    }
    
    /* Styles pour les grilles dans le panneau de référence */
    .reference-content .options-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 1rem;
    }
    
    .reference-content .options-grid-4col {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 1rem;
      margin-bottom: 1.5rem;
    }
    
    .reference-content .comp-distribute {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 0.5rem;
    }
    
    .reference-content .comp-item {
      cursor: default;
    }
    
    .reference-content .comp-item:hover {
      border-color: #ddd;
      background: #fafafa;
    }
    
    .reference-content .option-card,
    .reference-content .option-card-simple {
      cursor: default;
    }
    
    .reference-content .option-card:hover,
    .reference-content .option-card-simple:hover {
      transform: none;
      box-shadow: none;
      border-color: #ddd;
    }
    
    .reference-content .advantages-section-title {
      margin-top: 1.5rem;
    }
    
    .reference-content .advantages-section-title:first-of-type {
      margin-top: 0;
    }
    
    @media screen and (max-width: 768px) {
      .reference-buttons {
        flex-direction: column;
        align-items: stretch;
      }
      
      .reference-btn {
        justify-content: center;
        font-size: 12px;
        padding: 0.6rem 1rem;
      }
      
      .reference-content {
        padding: 0.75rem;
        max-height: 60vh;
      }
      
      .reference-content .options-grid {
        grid-template-columns: 1fr !important;
        gap: 0.75rem !important;
      }
      
      .reference-content .options-grid-4col {
        grid-template-columns: 1fr !important;
        gap: 0.75rem !important;
      }
      
      .reference-content .comp-distribute {
        grid-template-columns: repeat(2, 1fr) !important;
        gap: 0.3rem !important;
      }
    }
    
    @media screen and (max-width: 1024px) {
      .reference-content .options-grid-4col {
        grid-template-columns: repeat(2, 1fr);
      }
      
      .reference-content .comp-distribute {
        grid-template-columns: repeat(2, 1fr);
      }
    }
    
    /* ============================================
       STYLES RESPONSIVES MOBILE
       ============================================ */
    
    /* Tablettes */
    @media screen and (max-width: 1024px) {
      .options-grid {
        grid-template-columns: 1fr !important;
        gap: 1rem !important;
      }
      
      .options-grid-4col {
        grid-template-columns: repeat(2, 1fr) !important;
      }
    }
    
    /* Mobile - Tous les téléphones */
    @media screen and (max-width: 768px) {
      /* Reset global */
      html, body {
        overflow-x: hidden !important;
        width: 100% !important;
        max-width: 100vw !important;
      }
      
      * {
        box-sizing: border-box !important;
      }
      
      /* Wizard container */
      .wizard-container {
        padding: 0.5rem !important;
        margin: 0.5rem auto !important;
        max-width: 100% !important;
        overflow-x: hidden !important;
      }
      
      .wizard-header h1 {
        font-size: 1.3rem !important;
      }
      
      .wizard-header p {
        font-size: 0.85rem !important;
      }
      
      .btn-start-wizard {
        font-size: 14px !important;
        padding: 0.75rem 1rem !important;
      }
      
      .main-menu-buttons {
        padding: 0 1rem !important;
        gap: 0.75rem !important;
      }
      
      .btn-menu-option {
        font-size: 13px !important;
        padding: 0.75rem 1rem !important;
      }
      
      .btn-back-menu, .btn-levelup-free {
        font-size: 12px !important;
        padding: 0.5rem 1rem !important;
      }
      
      /* Progress bar - Version compacte */
      .wizard-progress {
        display: flex !important;
        flex-wrap: wrap !important;
        gap: 0.25rem !important;
        justify-content: center !important;
        align-items: center !important;
        padding: 0.5rem !important;
      }
      
      .wizard-progress::before {
        top: 50% !important;
        transform: translateY(-50%) !important;
      }
      
      .progress-step {
        min-width: auto !important;
        min-height: auto !important;
        padding: 0.2rem !important;
        flex: 0 0 auto !important;
      }
      
      .step-number {
        width: 26px !important;
        height: 26px !important;
        min-height: 26px !important;
        font-size: 11px !important;
        border-radius: 50% !important;
      }
      
      .step-label {
        display: none !important;
      }
      
      /* Step content */
      .step-content {
        padding: 0.75rem !important;
        margin: 0 !important;
        border-radius: 0.5rem !important;
        max-width: 100% !important;
        overflow-x: hidden !important;
      }
      
      .step-title {
        font-size: 1.1rem !important;
        margin-bottom: 0.5rem !important;
      }
      
      .step-description {
        font-size: 0.8rem !important;
        margin-bottom: 0.75rem !important;
      }
      
      /* GRILLES - Forcer 1 colonne */
      .options-grid,
      .options-grid-4col,
      .levelup-options-grid {
        display: flex !important;
        flex-direction: column !important;
        gap: 0.75rem !important;
        width: 100% !important;
      }
      
      /* CARTES DE RACE/CLASSE avec images - Layout horizontal */
      .option-card {
        display: flex !important;
        flex-direction: row !important;
        flex-wrap: nowrap !important;
        align-items: flex-start !important;
        width: 100% !important;
        max-width: 100% !important;
        border-radius: 0.75rem !important;
        overflow: hidden !important;
      }
      
      .option-card .option-img,
      .option-card > img {
        width: 40% !important;
        min-width: 40% !important;
        max-width: 40% !important;
        height: auto !important;
        min-height: 120px !important;
        max-height: none !important;
        object-fit: cover !important;
        flex-shrink: 0 !important;
        align-self: stretch !important;
      }
      
      .option-card-text-content,
      .option-card .option-content,
      .option-card > div:not(img) {
        width: 60% !important;
        min-width: 60% !important;
        max-width: 60% !important;
        max-height: none !important;
        height: auto !important;
        padding: 0.5rem !important;
        overflow: visible !important;
        box-sizing: border-box !important;
      }
      
      .option-card .option-name {
        font-size: 14px !important;
        font-weight: bold !important;
        margin-bottom: 0.3rem !important;
      }
      
      .option-card .option-desc {
        font-size: 11px !important;
        line-height: 1.35 !important;
      }
      
      .option-bonuses,
      .option-maluses {
        font-size: 10px !important;
        margin-top: 0.4rem !important;
        padding-left: 1rem !important;
      }
      
      .option-bonuses li,
      .option-maluses li {
        font-size: 10px !important;
        margin-bottom: 0.15rem !important;
        line-height: 1.3 !important;
      }
      
      /* CARTES SIMPLES (avantages) */
      .option-checkbox-simple {
        padding: 0.75rem !important;
        width: 100% !important;
      }
      
      .option-checkbox-simple .option-name {
        font-size: 14px !important;
      }
      
      .option-checkbox-simple .option-desc {
        font-size: 12px !important;
      }
      
      /* Navigation buttons */
      .step-navigation {
        display: flex !important;
        flex-direction: column !important;
        gap: 0.5rem !important;
        margin-top: 1rem !important;
      }
      
      .step-navigation button,
      .btn-prev, .btn-next, .btn-confirm {
        width: 100% !important;
        padding: 0.75rem 1rem !important;
        font-size: 14px !important;
        min-height: 44px !important;
      }
      
      /* Attributes distribution */
      #attr-distribute,
      .attr-distribute {
        display: grid !important;
        grid-template-columns: 1fr !important;
        gap: 0.5rem !important;
      }
      
      .attr-item {
        min-height: 80px !important;
        padding: 0.5rem !important;
      }
      
      .attr-item label {
        font-size: 14px !important;
      }
      
      .attr-item .attr-dice-display {
        font-size: 20px !important;
      }
      
      .attr-item .attr-value-display {
        font-size: 12px !important;
      }
      
      /* Dice pool */
      .dice-pool {
        display: flex !important;
        flex-wrap: wrap !important;
        justify-content: center !important;
        gap: 0.5rem !important;
        padding: 0.75rem !important;
      }
      
      .dice-item {
        width: 50px !important;
        height: 50px !important;
        font-size: 14px !important;
      }
      
      /* Level up */
      .levelup-option-card {
        padding: 0.75rem !important;
        width: 100% !important;
      }
      
      .levelup-controls {
        flex-direction: column !important;
        align-items: center !important;
        gap: 0.5rem !important;
      }
      
      .levelup-selection-panel {
        padding: 0.75rem !important;
        overflow-x: hidden !important;
      }
      
      .levelup-selection-panel > div {
        overflow-x: hidden !important;
      }
      
      /* Level up characteristic selection - responsive grid */
      .levelup-carac-grid {
        grid-template-columns: repeat(2, 1fr) !important;
        gap: 0.4rem !important;
      }
      
      .levelup-carac-grid button {
        font-size: 10px !important;
        padding: 0.3rem !important;
      }
      
      /* Level up competence/advantage selection - no scroll, full list */
      .levelup-comp-grid,
      .levelup-adv-grid {
        max-height: none !important;
        overflow-y: visible !important;
        grid-template-columns: 1fr !important;
      }
      
      .levelup-choice-item {
        flex-direction: column !important;
        align-items: flex-start !important;
        gap: 0.5rem !important;
      }
      
      /* Competences step - 1 column on mobile */
      #comp-list {
        display: grid !important;
        grid-template-columns: 1fr !important;
        gap: 0.4rem !important;
      }
      
      .comp-distribute {
        grid-template-columns: repeat(2, 1fr) !important;
        gap: 0.3rem !important;
        overflow: hidden !important;
      }
      
      .comp-item {
        font-size: 10px !important;
        padding: 0.3rem 0.4rem !important;
        display: flex !important;
        justify-content: space-between !important;
        align-items: center !important;
        overflow: hidden !important;
      }
      
      .comp-item .comp-info {
        gap: 0.2rem !important;
        flex-shrink: 1 !important;
        min-width: 0 !important;
        overflow: hidden !important;
      }
      
      .comp-item .comp-name {
        white-space: nowrap !important;
        overflow: hidden !important;
        text-overflow: ellipsis !important;
        max-width: 70px !important;
      }
      
      .comp-item .comp-attr {
        font-size: 8px !important;
        padding: 0.1rem 0.2rem !important;
        flex-shrink: 0 !important;
      }
      
      .comp-item .comp-controls {
        flex-shrink: 0 !important;
        gap: 0.15rem !important;
      }
      
      .comp-item .comp-controls button {
        width: 18px !important;
        height: 18px !important;
        font-size: 12px !important;
      }
      
      .comp-item .comp-value {
        min-width: 20px !important;
        font-size: 10px !important;
      }
      
      /* Custom advantages */
      .custom-advantages-container {
        display: flex !important;
        flex-direction: column !important;
        gap: 0.5rem !important;
      }
      
      .custom-advantage-card,
      .custom-advantage-add {
        width: 100% !important;
        min-width: 100% !important;
        max-width: 100% !important;
      }
      
      /* Name and stats step */
      .name-alignment-grid {
        display: block !important;
      }
      
      .name-alignment-grid > div {
        margin-bottom: 1rem !important;
      }
      
      .stats-recap-grid {
        display: block !important;
      }
      
      .stats-recap-grid > div {
        margin-bottom: 0.75rem !important;
      }
      
      /* Selection count */
      .selection-count {
        font-size: 0.85rem !important;
        margin-bottom: 0.75rem !important;
      }
      
      /* Input zoom prevention on iOS */
      input[type="text"],
      input[type="number"],
      select,
      textarea {
        font-size: 16px !important;
      }
      
      /* ========== CHARACTER SHEET - Même layout, polices réduites de 50% ========== */
      .container {
        padding: 0.5rem !important;
        margin: 0.5rem auto !important;
        max-width: 100% !important;
      }
      
      .title-box {
        font-size: 12px !important;
        padding: 0.25rem !important;
      }
      
      .title-row {
        margin-bottom: 0.5rem !important;
      }
      
      /* Garder la grille 4 colonnes comme desktop */
      .attributes-and-vitals {
        gap: 0.5rem !important;
      }
      
      .attr-box {
        padding: 0.25rem !important;
        border-radius: 0.5rem !important;
      }
      
      .attr-box label {
        font-size: 9px !important;
      }
      
      .attr-box .value-wrap {
        display: flex !important;
        flex-wrap: nowrap !important;
        align-items: center !important;
        justify-content: center !important;
        gap: 0.1rem !important;
        white-space: nowrap !important;
      }
      
      .attr-box input[type="number"] {
        width: 24px !important;
        font-size: 12px !important;
      }
      
      .attr-dice {
        font-size: 7px !important;
        white-space: nowrap !important;
      }
      
      .attr-box input[type="text"] {
        width: 18px !important;
        font-size: 8px !important;
      }
      
      .vital-box {
        padding: 0.25rem !important;
      }
      
      .vital-box label {
        font-size: 7px !important;
      }
      
      .vital-box input {
        font-size: 12px !important;
      }
      
      .portrait {
        min-height: 100px !important;
      }
      
      .portrait h3 {
        font-size: 11px !important;
      }
      
      .print-box {
        font-size: 10px !important;
        padding: 0.5rem !important;
      }
      
      .grid-top {
        gap: 0.25rem !important;
        margin-bottom: 0.5rem !important;
      }
      
      .grid-top .field {
        padding: 0.2rem !important;
        overflow: hidden !important;
      }
      
      .grid-top .field label {
        font-size: 9px !important;
        display: block !important;
        margin-bottom: 0.1rem !important;
      }
      
      .grid-top .field input {
        font-size: 10px !important;
        padding: 0.15rem !important;
        width: 100% !important;
        background: transparent !important;
      }
      
      .row-two-col {
        gap: 0.5rem !important;
      }
      
      .section {
        padding: 0.4rem !important;
        margin-bottom: 0.5rem !important;
      }
      
      .section h3 {
        font-size: 11px !important;
      }
      
      .skill-table {
        font-size: 12px !important;
      }
      
      .skill-table th {
        font-size: 12px !important;
      }
      
      .skill-table th,
      .skill-table td {
        padding: 0.15rem !important;
      }
      
      .skill-table input {
        font-size: 12px !important;
      }
      
      .skill-table tbody tr td:first-child {
        padding-left: 1rem !important;
      }
      
      .skill-table tbody tr td:first-child::before {
        font-size: 12px !important;
        top: 0.15rem !important;
        left: 0 !important;
      }
      
      .abilities-list {
        font-size: 12px !important;
        padding-left: 1.2rem !important;
      }
      
      .abilities-list li {
        padding: 0.2rem 0 !important;
        font-size: 12px !important;
        line-height: 1.4 !important;
      }
      
      .abilities-list li::marker {
        font-size: 12px !important;
      }
      
      /* Bonus de race */
      .bonus-race-content {
        font-size: 12px !important;
        padding-left: 1.2rem !important;
      }
      
      .bonus-race-content li {
        font-size: 12px !important;
        padding: 0.2rem 0 !important;
        line-height: 1.4 !important;
      }
      
      .bonus-race-content li::marker {
        font-size: 12px !important;
      }
      
      /* Half sections */
      .half-section {
        padding: 0.4rem !important;
        overflow: hidden !important;
      }
      
      .half-section h3 {
        font-size: 11px !important;
      }
      
      .half-section textarea {
        font-size: 12px !important;
      }
      
      .half-section input[type="file"] {
        font-size: 9px !important;
        max-width: 100% !important;
        overflow: hidden !important;
      }
      
      /* Textarea et notes (inventaire) */
      textarea {
        font-size: 12px !important;
      }
      
      .portrait textarea {
        font-size: 12px !important;
      }
      
      /* Textareas auto-grow (Notes, Description, Histoire, Relations) */
      textarea.auto-grow {
        font-size: 12px !important;
        line-height: 1.4 !important;
      }
      
      /* Inputs source dans Dégâts et RD */
      .damage-entry input[type="text"],
      .damage-entry select,
      .damage-entry input[type="number"] {
        font-size: 10px !important;
      }
    }
    
    /* Très petits écrans (iPhone SE, etc.) */
    @media screen and (max-width: 375px) {
      .wizard-header h1 {
        font-size: 1.1rem !important;
      }
      
      .step-title {
        font-size: 1rem !important;
      }
      
      /* Cartes race/classe sur très petits écrans */
      .option-card .option-img,
      .option-card > img {
        width: 35% !important;
        min-width: 35% !important;
        max-width: 35% !important;
      }
      
      .option-card-text-content,
      .option-card .option-content,
      .option-card > div:not(img) {
        width: 65% !important;
        min-width: 65% !important;
        max-width: 65% !important;
        padding: 0.4rem !important;
      }
      
      .option-card .option-name {
        font-size: 12px !important;
      }
      
      .option-card .option-desc {
        font-size: 10px !important;
      }
      
      .option-bonuses,
      .option-maluses {
        font-size: 9px !important;
      }
      
      .option-bonuses li,
      .option-maluses li {
        font-size: 9px !important;
      }
      
      .attributes {
        grid-template-columns: repeat(3, 1fr) !important;
      }
      
      #comp-list {
        grid-template-columns: 1fr !important;
      }
      
      .dice-item {
        width: 42px !important;
        height: 42px !important;
        font-size: 12px !important;
      }
      
      /* Level up - 1 column for characteristics on very small screens */
      .levelup-carac-grid {
        grid-template-columns: 1fr !important;
      }
      
      /* Textareas et inputs plus petits sur très petits écrans */
      textarea.auto-grow {
        font-size: 11px !important;
      }
      
      .damage-entry input[type="text"],
      .damage-entry select,
      .damage-entry input[type="number"] {
        font-size: 9px !important;
      }
    }
    
    /* Touch device improvements */
    @media (hover: none) and (pointer: coarse) {
      .option-card,
      .option-checkbox-simple,
      .levelup-option-card,
      .custom-advantage-add,
      .dice-item,
      .attr-item,
      .comp-item,
      button {
        cursor: pointer;
        -webkit-tap-highlight-color: rgba(139, 0, 0, 0.2);
      }
      
      .btn-next,
      .btn-prev,
      .btn-confirm {
        min-height: 48px !important;
      }
    }
    
    /* Save / Load buttons */
    .save-load-container {
      grid-column: span 4;
      display: flex;
      gap: 1rem;
      justify-content: center;
      margin-bottom: 1rem;
      flex-wrap: wrap;
    }
    
    .save-btn, .load-btn {
      padding: 0.6rem 1.5rem;
      border: 2px solid #333;
      border-radius: 0.5rem;
      background: #fff;
      font-size: 14px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.2s;
      color: #333;
    }
    
    .save-btn:hover {
      background: #2ecc71;
      color: #fff;
      border-color: #27ae60;
    }
    
    .load-btn:hover {
      background: #3498db;
      color: #fff;
      border-color: #2980b9;
    }
    
    /* Reference panel interactive items */
    .ref-item-interactive {
      position: relative;
    }
    
    .ref-add-btn, .ref-remove-btn {
      position: absolute;
      top: 0.5rem;
      right: 0.5rem;
      width: 28px;
      height: 28px;
      border-radius: 50%;
      border: none;
      font-size: 18px;
      font-weight: bold;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
      z-index: 10;
    }
    
    .ref-add-btn {
      background: #27ae60;
      color: #fff;
    }
    
    .ref-add-btn:hover {
      background: #2ecc71;
      transform: scale(1.1);
    }
    
    .ref-remove-btn {
      background: #e74c3c;
      color: #fff;
    }
    
    .ref-remove-btn:hover {
      background: #c0392b;
      transform: scale(1.1);
    }
    
    .ref-item-added {
      border-color: #27ae60 !important;
      background: linear-gradient(135deg, #f0fff4 0%, #fff 100%) !important;
    }
    
    .ref-comp-item {
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .ref-comp-item:hover {
      border-color: #27ae60 !important;
      background: #f0fff4 !important;
    }
    
    .ref-comp-item.added {
      border-color: #27ae60 !important;
      background: linear-gradient(135deg, #f0fff4 0%, #fff 100%) !important;
    }
    
    .ref-comp-item .comp-value {
      font-weight: bold;
      color: #27ae60;
      min-width: 30px;
      text-align: center;
    }
    
    .ref-comp-item .comp-controls {
      display: flex;
      align-items: center;
      gap: 0.25rem;
    }
    
    .ref-comp-item .comp-controls button {
      width: 22px;
      height: 22px;
      border: none;
      border-radius: 50%;
      background: #8b0000;
      color: #fff;
      font-size: 14px;
      font-weight: bold;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }
    
    .ref-comp-item .comp-controls button:hover:not(:disabled) {
      transform: scale(1.1);
      background: #a52a2a;
    }
    
    .ref-comp-item .comp-controls button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    
    .ref-comp-item .comp-controls button:first-child {
      background: #e74c3c;
    }
    
    .ref-comp-item .comp-controls button:first-child:hover:not(:disabled) {
      background: #c0392b;
    }
    
    .ref-comp-item .comp-controls button:last-child {
      background: #27ae60;
    }
    
    .ref-comp-item .comp-controls button:last-child:hover:not(:disabled) {
      background: #2ecc71;
    }
    
    @media screen and (max-width: 768px) {
      .save-load-container {
        flex-direction: column !important;
        gap: 0.5rem !important;
        padding: 0 0.5rem !important;
      }
      
      .save-btn, .load-btn {
        font-size: 12px !important;
        padding: 0.5rem 1rem !important;
        width: 100% !important;
      }
      
      .ref-add-btn, .ref-remove-btn {
        width: 24px !important;
        height: 24px !important;
        font-size: 14px !important;
      }
    }
    
    /* Damage and RD boxes - compact version */
    .damage-rd-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
      margin-bottom: 1rem;
    }
    
    .damage-box, .rd-box {
      border: 2px solid #333;
      border-radius: 0.75rem;
      background: #fff;
      padding: 0.4rem 0.5rem;
      box-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
    }
    
    .damage-box h3, .rd-box h3 {
      margin: 0;
      font-size: 18px;
      font-weight: bold;
      color: #666;
      text-align: center;
    }
    
    .damage-formula {
      font-size: 16px;
      font-weight: normal;
      color: #333;
      text-align: center;
      border: none;
    }
    
    .damage-header {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 0.25rem;
      min-height: 50px;
    }
    
    .damage-toggle-btn {
      background: none;
      border: 1px solid #8b0000;
      border-radius: 4px;
      color: #8b0000;
      font-size: 9px;
      padding: 1px 5px;
      cursor: pointer;
      margin-left: auto;
    }
    
    .damage-toggle-btn:hover {
      background: #8b0000;
      color: white;
    }
    
    .damage-entries {
      display: none;
      flex-direction: column;
      gap: 0.3rem;
      margin-top: 0.3rem;
    }
    
    .damage-entries.show {
      display: flex;
    }
    
    .damage-entry {
      display: flex;
      align-items: center;
      gap: 0.25rem;
      padding: 0.2rem;
      background: #fafafa;
      border: 1px solid #ddd;
      border-radius: 0.25rem;
      flex-wrap: wrap;
    }
    
    .damage-entry select {
      padding: 0.1rem;
      border: 1px solid #ddd;
      border-radius: 0.2rem;
      font-size: 11px;
    }
    
    .damage-entry input[type="number"] {
      width: 35px;
      padding: 0.1rem;
      border: 1px solid #ddd;
      border-radius: 0.2rem;
      text-align: center;
      font-size: 11px;
    }
    
    .damage-entry input[type="text"] {
      flex: 1;
      padding: 0.1rem;
      border: 1px solid #ddd;
      border-radius: 0.2rem;
      font-size: 10px;
      min-width: 50px;
    }
    
    .damage-entry .remove-damage-btn {
      width: 16px;
      height: 16px;
      border: none;
      border-radius: 50%;
      background: #e74c3c;
      color: #fff;
      font-size: 11px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .damage-entry .remove-damage-btn:hover {
      background: #c0392b;
    }
    
    .add-damage-btn {
      width: 100%;
      padding: 0.2rem;
      border: 1px dashed #8b0000;
      border-radius: 0.25rem;
      background: #fff;
      color: #8b0000;
      font-size: 9px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.2s;
      margin-top: 0.2rem;
    }
    
    .add-damage-btn:hover {
      background: #8b0000;
      color: #fff;
    }
    
    @media screen and (max-width: 768px) {
      .damage-rd-row {
        grid-template-columns: 1fr 1fr !important;
        gap: 0.25rem !important;
      }
      
      .damage-box, .rd-box {
        padding: 0.25rem !important;
      }
      
      .damage-box h3, .rd-box h3 {
        font-size: 9px !important;
      }
      
      .damage-formula {
        font-size: 12px !important;
      }
      
      .damage-header {
        min-height: 35px !important;
        gap: 0.15rem !important;
      }
      
      .damage-toggle-btn {
        font-size: 7px !important;
        padding: 1px 3px !important;
      }
      
      .damage-entry {
        flex-wrap: wrap;
      }
      
      .damage-entry input[type="text"] {
        width: 100%;
        margin-top: 0.25rem;
      }
    }
    
    @media print {
      .wizard-container, .wizard-separator, .reference-panel, .save-load-container, .free-mode-buttons { display: none !important; }
      .add-damage-btn, .remove-damage-btn, .damage-toggle-btn, .damage-entries { display: none !important; }
      .damage-rd-row { margin-bottom: 1rem !important; gap: 1rem !important; }
      .damage-box, .rd-box { padding: 0.2rem 0.4rem !important; }
      .page-break-before { page-break-before: always !important; break-before: page !important; margin-top: 0 !important; }
      #character-sheet { display: block !important; }
    }
    /* titre principal */
    .title-row{display:grid;grid-template-columns:repeat(4,1fr);margin-bottom:1rem;}
    .title-box{grid-column:1/span 4;border:2px solid #333;border-radius:1rem;background:#fff;padding:.5rem;text-align:center;font-size:24px;font-weight:bold;color:#8b0000;box-shadow:2px 2px 4px rgba(0,0,0,.1);}
    /* supprimer les flèches +/- des champs number et centrer */
    input[type="number"]::-webkit-inner-spin-button,
    input[type="number"]::-webkit-outer-spin-button{ -webkit-appearance:none; margin:0; }
    input[type="number"]{ -moz-appearance:textfield; appearance:textfield; text-align:center; }

    * { box-sizing: border-box; }
    body {
      font-family: Arial, Helvetica, sans-serif;
      margin: 0;
      padding: 0;
      background: #fdfdfd;
    }
    .container { max-width: 1000px; margin: 2rem auto; padding: 1rem; position: relative; }

    /* couleurs */
    label, .section h3, .skill-table th { color: #666; }
    .attr-dice { color: #8b0000; }
    input, textarea, .abilities-list, .skill-table input { color: #000; }

    /* grille 4 colonnes principale */
    .attributes-and-vitals {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 1rem;
      margin-bottom: 1rem;
      align-items: stretch;
    }
    .attributes, .vitals, .portrait {
      display: flex;
      flex-direction: column;
      height: 100%;
    }
    .attributes { grid-column: span 1; gap: 0.5rem; }
    .vitals { grid-column: span 1; gap: 0.5rem; flex: 1; }
    .portrait { grid-column: span 2; flex: 1; }

    /* champs généraux (ligne top) */
    .grid-top {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 1rem;
      margin-bottom: 1rem;
    }
    .field {
      border: 2px solid #333;
      border-radius: 1rem;
      padding: 0.5rem;
      background: #fff;
      box-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
    }
    .field label {
      font-weight: bold;
      font-size: 18px;
      text-align: center;
      display: block;
    }
    .field input {
      width: 100%;
      border: none;
      padding: 0.25rem;
      font-size: 16px;
      text-align: center;
    }

    /* caractéristiques */
    .attr-box { flex: 1; border: 2px solid #333; border-radius: 1rem; background: #fff; padding: 0.5rem; box-shadow: 2px 2px 4px rgba(0,0,0,.1); display:flex; flex-direction:column; justify-content:center; align-items:center; }
    .attr-box label { font-weight: bold; font-size: 22px; text-align: center; margin-bottom: 0.25rem; display: block;
      text-align: center;
      margin-bottom: 0.25rem;
      display: block;
    }
    .value-wrap { display: flex; justify-content: center; align-items: center; gap: 0.25rem; }
    .attr-box input[type="number"] { width: 40px; border: none; text-align: center; font-size: 18px; }
    .attr-dice { font-size: 10px; }

    /* vitaux */
    .vital-sep{border:none;border-top:1px solid #666;margin:0.25rem 0;}
    .vital-box {
      border: 2px solid #333;
      border-radius: 1rem;
      background: #fff;
      padding: 0.5rem;
      box-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
      flex-basis: 0;
    }
    .vital-box label {
      font-weight: bold;
      font-size: 18px;
      text-align: center;
      margin-bottom: 0.25rem;
      display: block;
    }
    .vital-box input { width: 100%; border: none; text-align: center; font-size: 16px; }
    .vital-box:nth-child(1), .vital-box:nth-child(2) { flex: 0 1 40%; }
    .vital-box:nth-child(3) { flex: 0 1 20%; }

    /* portrait / notes */
    .portrait{grid-column:span 2;border:2px solid #333;border-radius:1rem;background:#fff;padding:.75rem;box-shadow:2px 2px 4px rgba(0,0,0,.1);display:flex;flex-direction:column;gap:0.5rem;}
    .portrait h3{margin:0;font-size:22px;text-align:center;color:#666;}
    .portrait textarea{width:100%;border:none;border-radius:0.5rem;padding:0.5rem;background:#fff;font-size:16px;overflow:hidden;resize:none;}

    /* sections pleine largeur (4 col) */
    .section {
      border: 2px solid #333;
      border-radius: 1rem;
      padding: 0.75rem;
      margin-bottom: 1rem;
      background: #fff;
      box-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
      grid-column: span 4;
    }
    .section h3 { margin-top: 0; font-size: 22px; text-align: center; }
    /* bouton impression */
    .print-box{border:2px solid #333;border-radius:1rem;background:#fff;padding:.75rem;margin-bottom:1rem;grid-column:span 4;text-align:center;font-size:18px;font-weight:bold;color:#666;cursor:pointer;box-shadow:2px 2px 4px rgba(0,0,0,.1);}
    /* rangées deux‑colonnes supplémentaires */
    .row-two-col{display:grid;grid-template-columns:repeat(4,1fr);gap:1rem;margin-bottom:1rem;}
    .half-section{border:2px solid #333;border-radius:1rem;background:#fff;padding:.75rem;box-shadow:2px 2px 4px rgba(0,0,0,.1);grid-column:span 2;}
    .half-section h3{margin-top:0;font-size:22px;text-align:center;color:#666;}
    /* aperçu image */
    .image-preview{display:none;width:100%;max-width:100%;height:auto;max-height:100%;border:1px dashed #999;border-radius:0.5rem;object-fit:contain;cursor:pointer;box-sizing:border-box;}

    /* tableau compétences */
    .skill-table { width: 100%; border-collapse: collapse; table-layout: fixed; }
    .skill-table th, .skill-table td { border-bottom: 1px solid #ccc; padding: 0.25rem; text-align: left; }
    .skill-table th { font-size: 18px; }
    .skill-table th:nth-child(1), .skill-table td:nth-child(1) { width: 50%; }
    .skill-table th:nth-child(2), .skill-table td:nth-child(2) { width: 25%; }
    .skill-table th:nth-child(3), .skill-table td:nth-child(3) { width: 25%; text-align: center; }
    .skill-table input { width: 100%; border: none; font-size: 16px; }
    .skill-table tbody tr td:first-child { position: relative; padding-left: 1.25rem; }
    .skill-table tbody tr td:first-child::before { content: '•'; position: absolute; left: 0; font-size: 16px; line-height: 1; top: 0.3rem; line-height: 1; top: 0.3rem; }

    /* ajuster largeur des textareas des demi‑sections */
    .half-section textarea{width:100%;box-sizing:border-box;border:none;border-radius:0.5rem;padding:0.5rem;background:#fff;font-size:16px;overflow:hidden;resize:none;}

    /* listes à puces éditables */
    .abilities-list { list-style-type: disc; padding-left: 1.2rem; margin: 0; font-size: 16px; }
    .abilities-list li{ margin-bottom:0.25rem; border-bottom:1px solid #ccc; padding:0.25rem 0; }
    .abilities-list li:first-child{border-top:1px solid #ccc;}

    @media print {
      /* forcer le zoom 100 % et conserver les couleurs/polices du web */
      *{-webkit-print-color-adjust:exact;print-color-adjust:exact;font-size:inherit;}
      html,body{zoom:100%;}
      .container{margin:0;width:1000px;}
      .section, .attributes-and-vitals, .row-two-col, .grid-top, .title-row{break-inside:avoid;page-break-inside:avoid;}
    }
    
      /* auto‑grow textarea */
    .auto-grow{overflow:hidden;resize:none;width:100%;border:none;font-size:16px;}
    
    /* Modal popup */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.6);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 10000;
    }
    
    .modal-content {
      background: #fff;
      border-radius: 1rem;
      padding: 1.5rem;
      max-width: 400px;
      width: 90%;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
      text-align: center;
    }
    
    .modal-content h3 {
      margin: 0 0 1rem 0;
      color: #333;
      font-size: 1.2rem;
    }
    
    .modal-content p {
      margin: 0 0 1.5rem 0;
      color: #666;
      font-size: 0.9rem;
    }
    
    .modal-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      justify-content: center;
    }
    
    .modal-btn {
      padding: 0.75rem 1.25rem;
      border: 2px solid #333;
      border-radius: 0.5rem;
      background: #fff;
      cursor: pointer;
      font-size: 0.9rem;
      font-weight: bold;
      transition: all 0.2s;
    }
    
    .modal-btn:hover {
      background: #8b0000;
      color: #fff;
      border-color: #8b0000;
    }
    
    .modal-btn-cancel {
      background: #eee;
      color: #666;
      border-color: #ccc;
    }
    
    .modal-btn-cancel:hover {
      background: #ddd;
      color: #333;
      border-color: #999;
    }
  </style>
</head>
<body>
  <!-- ========== WIZARD DE CRÉATION DE PERSONNAGE ========== -->
  <div class="wizard-container" id="wizard-container">
    <div class="wizard-header" id="wizard-intro">
      <h1 class="wizard-title">🎲 Gaïa 2 - Fiche de Personnage</h1>
      <p class="wizard-subtitle">Bienvenue, que souhaitez-vous faire ?</p>
      <div class="main-menu-buttons">
        <button class="btn-start-wizard" id="btn-start-wizard">Démarrer la création de Personnage</button>
        <button class="btn-menu-option" id="btn-consult-ref">Consulter les Races / Classes / Avantages-Capacités / Compétences</button>
        <button class="btn-menu-option" id="btn-fill-free">Remplir la fiche de personnage librement</button>
        <button class="btn-menu-option" id="btn-import-json">Importer sa fiche de personnage (format JSON)</button>
        <input type="file" id="import-json-input" accept=".json" style="display:none;">
      </div>
    </div>

    <div class="wizard-steps" id="wizard-steps">
      <!-- Progress Bar -->
      <div class="wizard-progress">
        <div class="progress-step active" data-step="1">
          <span class="step-number">1</span>
          <span class="step-label">Race</span>
        </div>
        <div class="progress-step" data-step="2">
          <span class="step-number">2</span>
          <span class="step-label">Caractéristiques</span>
        </div>
        <div class="progress-step" data-step="3">
          <span class="step-number">3</span>
          <span class="step-label">Classe</span>
        </div>
        <div class="progress-step" data-step="4">
          <span class="step-number">4</span>
          <span class="step-label">Avantage de Classe</span>
        </div>
        <div class="progress-step" data-step="5">
          <span class="step-number">5</span>
          <span class="step-label">Compétences</span>
        </div>
        <div class="progress-step" data-step="6">
          <span class="step-number">6</span>
          <span class="step-label">Avantages</span>
        </div>
        <div class="progress-step" data-step="7">
          <span class="step-number">7</span>
          <span class="step-label">Nom & Stats</span>
        </div>
        <div class="progress-step" data-step="8">
          <span class="step-number">8</span>
          <span class="step-label">Level Up</span>
        </div>
        <div class="progress-step" data-step="9" style="display: none;">
          <span class="step-number">✓</span>
          <span class="step-label">Terminée</span>
        </div>
      </div>

      <!-- Étape 1: Choix de la race -->
      <div class="step-content active" data-step="1">
        <h2 class="step-title">Choisissez votre Race</h2>
        <p class="step-description">Votre race détermine vos bonus innés et vos aptitudes naturelles.</p>
        <div class="options-grid" id="race-options">
          <!-- Généré par JS -->
        </div>
        <div class="step-navigation">
          <div></div>
          <button class="btn-next" id="btn-next-1" disabled>Suivant →</button>
        </div>
      </div>

      <!-- Étape 2: Répartition des caractéristiques (système de dés) -->
      <div class="step-content" data-step="2">
        <h2 class="step-title">Attribuez vos Dés aux Caractéristiques</h2>
        <p class="step-description">Assignez un dé unique à chaque caractéristique. La valeur du dé devient la valeur de la caractéristique.</p>
        
        <div class="dice-pool" id="dice-pool">
          <!-- Dés disponibles générés par JS -->
        </div>
        
        <div class="attr-distribute" id="attr-distribute">
          <!-- Généré par JS -->
        </div>
        
        <div class="step-navigation">
          <button class="btn-prev" id="btn-prev-2">← Précédent</button>
          <button class="btn-next" id="btn-next-2" disabled>Suivant →</button>
        </div>
      </div>

      <!-- Étape 3: Choix de la classe -->
      <div class="step-content" data-step="3">
        <h2 class="step-title">Choisissez votre Classe</h2>
        <p class="step-description">Votre classe définit votre rôle et vos capacités en combat.</p>
        <div class="options-grid" id="class-options">
          <!-- Généré par JS -->
        </div>
        <div class="step-navigation">
          <button class="btn-prev" id="btn-prev-3">← Précédent</button>
          <button class="btn-next" id="btn-next-3" disabled>Suivant →</button>
        </div>
      </div>

      <!-- Étape 4: Choix d'un avantage de classe -->
      <div class="step-content" data-step="4">
        <h2 class="step-title">Choisissez un Avantage de Classe</h2>
        <p class="step-description">Sélectionnez l'avantage principal de votre classe.</p>
        <div class="options-grid-4col" id="primary-advantage-options">
          <!-- Généré par JS -->
        </div>
        <div class="step-navigation">
          <button class="btn-prev" id="btn-prev-4">← Précédent</button>
          <button class="btn-next" id="btn-next-4" disabled>Suivant →</button>
        </div>
      </div>

      <!-- Étape 5: Répartition des compétences -->
      <div class="step-content" data-step="5">
        <h2 class="step-title">Répartissez vos Compétences</h2>
        <p class="step-description">Distribuez 12 points parmi les compétences disponibles.</p>
        <div class="points-counter">
          Points restants : <span class="remaining" id="comp-points-remaining">12</span>
        </div>
        <div class="comp-distribute" id="comp-distribute">
          <!-- Généré par JS -->
        </div>
        <div class="step-navigation">
          <button class="btn-prev" id="btn-prev-5">← Précédent</button>
          <button class="btn-next" id="btn-next-5" disabled>Suivant →</button>
        </div>
      </div>

      <!-- Étape 6: Choix de 3 avantages secondaires -->
      <div class="step-content" data-step="6">
        <h2 class="step-title">Choisissez 3 Avantages Secondaires</h2>
        <p class="step-description">Sélectionnez 3 avantages parmi ceux de votre classe.</p>
        <div class="selection-count">Sélectionnés : <strong id="secondary-count">0</strong> / 3</div>
        <div id="secondary-advantage-options">
          <!-- Généré par JS -->
        </div>
        <div class="step-navigation">
          <button class="btn-prev" id="btn-prev-6">← Précédent</button>
          <button class="btn-next" id="btn-next-6" disabled>Suivant →</button>
        </div>
      </div>

      <!-- Étape 7: Nom du personnage et calcul des stats -->
      <div class="step-content" data-step="7">
        <h2 class="step-title">Nommez votre Personnage</h2>
        <p class="step-description">Donnez un nom à votre personnage, choisissez son alignement et validez le calcul de ses statistiques vitales.</p>
        
        <div class="name-alignment-grid">
          <div class="name-input-section">
            <label for="wizard-name" style="display:block; font-weight:bold; font-size:16px; color:#666; margin-bottom:0.5rem;">Nom du Personnage</label>
            <input type="text" id="wizard-name" placeholder="Entrez le nom de votre personnage..." style="width:100%; padding:0.75rem; font-size:18px; border:2px solid #ddd; border-radius:0.5rem; text-align:center;">
          </div>
          <div class="alignment-input-section">
            <label for="wizard-alignment" style="display:block; font-weight:bold; font-size:16px; color:#666; margin-bottom:0.5rem;">Alignement</label>
            <select id="wizard-alignment" style="width:100%; padding:0.75rem; font-size:16px; border:2px solid #ddd; border-radius:0.5rem; text-align:center; cursor:pointer;">
              <option value="">-- Choisir --</option>
              <option value="Loyal Bon">Loyal Bon</option>
              <option value="Loyal Neutre">Loyal Neutre</option>
              <option value="Loyal Mauvais">Loyal Mauvais</option>
              <option value="Neutre Bon">Neutre Bon</option>
              <option value="Neutre Neutre">Neutre Neutre</option>
              <option value="Neutre Mauvais">Neutre Mauvais</option>
              <option value="Chaotique Bon">Chaotique Bon</option>
              <option value="Chaotique Neutre">Chaotique Neutre</option>
              <option value="Chaotique Mauvais">Chaotique Mauvais</option>
            </select>
          </div>
        </div>
        
        <div class="stats-summary" style="background:#f8f9fa; border-radius:0.75rem; padding:1rem; margin-bottom:1rem;">
          <h4 style="margin:0 0 1rem 0; color:#8b0000; text-align:center;">📊 Récapitulatif des Statistiques</h4>
          <div class="stats-recap-grid">
            <div class="stat-box" style="background:#fff; padding:0.75rem; border-radius:0.5rem; text-align:center; border:2px solid #27ae60;">
              <div style="font-size:14px; color:#666;">Points de Vie (PV)</div>
              <div style="font-size:28px; font-weight:bold; color:#27ae60;" id="calculated-pv">--</div>
              <div style="font-size:11px; color:#999;" id="pv-formula">FOR×2 + INT×2 + 10 + Niveau + Bonus</div>
            </div>
            <div class="stat-box" style="background:#fff; padding:0.75rem; border-radius:0.5rem; text-align:center; border:2px solid #3498db;">
              <div style="font-size:14px; color:#666;">Points de Fatalité (PF)</div>
              <div style="font-size:28px; font-weight:bold; color:#3498db;" id="calculated-pf">--</div>
              <div style="font-size:11px; color:#999;" id="pf-formula">PV + Bonus</div>
            </div>
          </div>
          <div style="margin-top:1rem; padding:0.75rem; background:#fff5f5; border-radius:0.5rem; font-size:13px; color:#666;" id="stats-details">
            <!-- Détails du calcul -->
          </div>
        </div>
        
        <div class="step-navigation">
          <button class="btn-prev" id="btn-prev-7">← Précédent</button>
          <button class="btn-next" id="btn-next-7" disabled>Suivant →</button>
        </div>
      </div>

      <!-- Étape 8: Level Up -->
      <div class="step-content" data-step="8">
        <h2 class="step-title">Améliorations de Niveau (Level Up)</h2>
        <p class="step-description">Chaque Level Up vous donne <strong>10 points de création</strong> à dépenser. Choisissez vos améliorations ci-dessous.</p>
        
        <div class="levelup-controls">
          <label style="font-weight:bold; color:#666;">Nombre de Level Up :</label>
          <div style="display:flex; align-items:center; gap:0.5rem;">
            <button id="levelup-minus" class="levelup-btn" style="width:36px; height:36px; font-size:20px; border:2px solid #8b0000; background:#fff; color:#8b0000; border-radius:0.25rem; cursor:pointer;">−</button>
            <input type="number" id="levelup-count" min="0" max="10" value="0" style="width:60px; text-align:center; font-size:18px; font-weight:bold; border:2px solid #ddd; border-radius:0.25rem; padding:0.25rem;">
            <button id="levelup-plus" class="levelup-btn" style="width:36px; height:36px; font-size:20px; border:2px solid #8b0000; background:#8b0000; color:#fff; border-radius:0.25rem; cursor:pointer;">+</button>
          </div>
          <span id="levelup-total-points" style="font-size:18px; font-weight:bold; color:#27ae60;">= 0 points</span>
        </div>
        
        <div id="level-up-container">
          <!-- Généré par JS -->
        </div>
        
        <div class="step-navigation">
          <button class="btn-prev" id="btn-prev-8">← Précédent</button>
          <button class="btn-confirm" id="btn-confirm">✓ Confirmer et finaliser la fiche</button>
        </div>
      </div>
    </div>
  </div>

  <div class="wizard-separator" id="wizard-separator" style="display: none;">
    <span>📜 Votre Fiche de Personnage</span>
  </div>

  <!-- Panneau de référence -->
  <div class="reference-panel" id="reference-panel" style="display: none;">
    <div class="reference-buttons">
      <button class="reference-btn" data-ref="races">📚 Races</button>
      <button class="reference-btn" data-ref="classes">⚔️ Classes</button>
      <button class="reference-btn" data-ref="class-advantages">🎯 Avantages de Classe</button>
      <button class="reference-btn" data-ref="general-advantages">✨ Avantages Généraux</button>
      <button class="reference-btn" data-ref="custom-advantages">✦ Avantages Personnalisés</button>
      <button class="reference-btn" data-ref="session-advantages">⟐ Avantages de Session</button>
      <button class="reference-btn" data-ref="competences">📝 Compétences</button>
    </div>
    <div class="reference-content" id="reference-content">
      <!-- Contenu généré par JS -->
    </div>
    <button class="btn-back-menu" id="btn-back-from-ref" style="display: none;">← Retour au menu principal</button>
  </div>
  
  <!-- Boutons mode fiche libre -->
  <div class="free-mode-buttons" id="free-mode-buttons" style="display: none; max-width: 1000px; margin: 0 auto 1rem; text-align: center;">
    <button class="btn-levelup-free" id="btn-levelup-free">🚀 Faire un ou plusieurs Level Up</button>
    <button class="btn-back-menu" id="btn-back-from-free">← Retour au menu principal</button>
  </div>

  <div class="container" id="character-sheet" style="display: none;">
    <!-- Titre centré 2 colonnes -->
    <div class="title-row"><div class="title-box">GAÏA 2 - FICHE DE PERSONNAGE</div></div>
    <!-- Ligne supérieure -->
    <div class="grid-top">
      <div class="field"><label for="name">Nom du Personnage</label><input id="name" /></div>
      <div class="field"><label for="level">Niveau</label><input id="level" type="number" min="1" value="1" /></div>
      <div class="field"><label for="race">Race</label><input id="race" /></div>
      <div class="field"><label for="class">Classe</label><input id="class" /></div>
    </div>

    <!-- Grille principale -->
    <div class="attributes-and-vitals">
      <!-- Caractéristiques (col 1) -->
      <div class="attributes">
        <div class="attr-box"><label for="force">Force</label><div class="value-wrap"><input id="force" type="number" placeholder="10" value="10" /><span class="attr-dice" id="force-dice"></span><input type="text" placeholder="+0" style="width:30px;text-align:center;border:none;font-size:18px;" /></div></div>
        <div class="attr-box"><label for="dex">Dextérité</label><div class="value-wrap"><input id="dex" type="number" placeholder="10" value="10" /><span class="attr-dice" id="dex-dice"></span><input type="text" placeholder="+0" style="width:30px;text-align:center;border:none;font-size:18px;" /></div></div>
        <div class="attr-box"><label for="emp">Empathie</label><div class="value-wrap"><input id="emp" type="number" placeholder="10" value="10" /><span class="attr-dice" id="emp-dice"></span><input type="text" placeholder="+0" style="width:30px;text-align:center;border:none;font-size:18px;" /></div></div>
        <div class="attr-box"><label for="sag">Sagesse</label><div class="value-wrap"><input id="sag" type="number" placeholder="10" value="10" /><span class="attr-dice" id="sag-dice"></span><input type="text" placeholder="+0" style="width:30px;text-align:center;border:none;font-size:18px;" /></div></div>
        <div class="attr-box"><label for="int">Intelligence</label><div class="value-wrap"><input id="int" type="number" placeholder="10" value="10" /><span class="attr-dice" id="int-dice"></span><input type="text" placeholder="+0" style="width:30px;text-align:center;border:none;font-size:18px;" /></div></div>
      </div>

      <!-- PV / PF / Alignement (col 2) -->
      <div class="vitals">
        <div class="vital-box">
          <label>PV</label>
          <div style="display:flex;align-items:center;justify-content:center;gap:0.25rem;margin-bottom:0.25rem;">
            <input id="pv-max" type="number" placeholder="Max" style="width:50px;" />
            <span style="font-size:14px;color:#666;">+</span>
            <span style="font-size:14px;color:#666;margin-left:0.25rem;">(</span>
            <input id="pv-temp" type="number" placeholder="0" style="width:40px;" />
            <span style="font-size:14px;color:#666;">)</span>
          </div>
          <hr class="vital-sep" />
          <input id="pv-current" type="number" placeholder="Actuel" />
        </div>
        <div class="vital-box"><label>PF</label><input id="pf-max" type="number" placeholder="Max" /><hr class="vital-sep" /><input id="pf-current" type="number" placeholder="Actuel" /></div>
        <div class="vital-box"><label>Alignement</label><input id="alignement" type="text" placeholder="" /></div>
      </div>

      <!-- Notes / portrait (cols 3-4) -->
      <div class="portrait">
          <h3>Notes - Quêtes - Équipements</h3>
          <textarea class="auto-grow" rows="1">- Point d'espoir : 
- Point d'anarchisme : 
- Santé mentale : 15

- Pièces d'or = 
- Pièces d'argent = 
- Pièces de cuivre = 

Equipement :
- </textarea>
      </div>
    </div>

      <!-- Dégâts et RD (compact) -->
      <div class="damage-rd-row">
        <div class="damage-box">
          <div class="damage-header">
            <h3>Dégâts</h3>
            <div class="damage-formula" id="damage-formula">—</div>
            <button class="damage-toggle-btn" id="damage-toggle-btn">Éditer</button>
          </div>
          <div class="damage-entries" id="damage-entries"></div>
          <button class="add-damage-btn" id="add-damage-btn">+ Ajouter</button>
        </div>
        <div class="rd-box">
          <div class="damage-header">
            <h3>Réduction de Dégâts</h3>
            <div class="damage-formula" id="rd-formula">—</div>
            <button class="damage-toggle-btn" id="rd-toggle-btn">Éditer</button>
          </div>
          <div class="damage-entries" id="rd-entries"></div>
          <button class="add-damage-btn" id="add-rd-btn">+ Ajouter</button>
        </div>
      </div>

    <!-- Bonus de race + Compétences (côte à côte) -->
    <div class="row-two-col bonus-comp-row">
      <div class="half-section">
      <h3>Bonus de race</h3>
      <ul class="abilities-list" contenteditable="true"><li></li><li></li><li></li></ul>
    </div>
      <div class="half-section">
      <h3>Compétences</h3>
      <table class="skill-table">
        <thead>
          <tr><th>Nom</th><th>Attribut</th><th>Bonus</th></tr>
        </thead>
        <tbody>
          <tr><td><input /></td><td><input placeholder="FOR" /></td><td><input type="number" placeholder="+0" /></td></tr>
          <tr><td><input /></td><td><input placeholder="FOR" /></td><td><input type="number" placeholder="+0" /></td></tr>
          <tr><td><input /></td><td><input placeholder="DEX" /></td><td><input type="number" placeholder="+0" /></td></tr>
          <tr><td><input /></td><td><input placeholder="DEX" /></td><td><input type="number" placeholder="+0" /></td></tr>
          <tr><td><input /></td><td><input placeholder="SAG" /></td><td><input type="number" placeholder="+0" /></td></tr>
          <tr><td><input /></td><td><input placeholder="SAG" /></td><td><input type="number" placeholder="+0" /></td></tr>
        </tbody>
      </table>
      </div>
    </div>

    <!-- Capacités -->
    <div class="section">
      <h3>Avantages / Capacités</h3>
      <ul class="abilities-list" contenteditable="true"><li></li><li></li><li></li></ul>
    </div>

    <!-- Description + empty box (page 2 pour PDF) -->
    <div class="row-two-col page-break-before">
      <div class="half-section">
        <h3>Description Physique</h3>
        <textarea class="auto-grow" rows="1"></textarea>
      </div>
      <div class="half-section">
        <h3>Visuel</h3>
        <input type="file" id="avatar-input" accept="image/*" style="display:block;margin-bottom:.5rem;">
        <img id="avatar-preview" class="image-preview" src="" alt="Aperçu du personnage" />
      </div>
    </div>

    <!-- Histoire + Relations -->
    <div class="row-two-col">
      <div class="half-section">
        <h3>Histoire</h3>
        <textarea class="auto-grow" rows="1"></textarea>
      </div>
      <div class="half-section">
        <h3>Relations - Alliés et Enemies</h3>
        <textarea class="auto-grow" rows="1"></textarea>
      </div>
    </div>

    <!-- Export / Impression -->
    <div class="print-box" id="print-btn">Exporter au format PDF - Imprimer la Fiche de Personnage</div>
    
    <!-- Save / Load -->
    <div class="save-load-container">
      <button class="save-btn" id="save-profile-btn">💾 Sauvegarder le profil</button>
      <button class="load-btn" id="load-profile-btn">📂 Charger un profil</button>
      <input type="file" id="load-profile-input" accept=".json" style="display:none;">
    </div>
  </div>

  <script>
    function getDie(val) {
      if (val <= 4) return 'D4';
      if (val <= 6) return 'D6';
      if (val <= 8) return 'D8';
      if (val <= 10) return 'D10';
      return 'D12';
    }

    document.querySelectorAll('.attr-box').forEach(box => {
      const numInput = box.querySelector('input[type="number"]');
      const diceSpan = box.querySelector('.attr-dice');
      const update = () => {
        const v = parseInt(numInput.value, 10) || 0;
        diceSpan.textContent = `( ${getDie(v)} )`;
      };
      numInput.addEventListener('input', update);
      update();
    });
    // Ajout de lignes dans Compétences avec Entrée
    const skillsBody = document.querySelector('.skill-table tbody');
    skillsBody.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        const currentRow = e.target.closest('tr');
        if (!currentRow) return;
        const newRow = currentRow.cloneNode(true);
        newRow.querySelectorAll('input').forEach(inp => inp.value = '');
        currentRow.after(newRow);
        newRow.querySelector('input').focus();
      }
    });
    // Suppression d’une ligne vide avec Backspace dans Compétences
    skillsBody.addEventListener('keydown', (e) => {
      if (e.key === 'Backspace' && e.target.value === '') {
        const row = e.target.closest('tr');
        if (row && row.parentElement.children.length > 1) {
          e.preventDefault();
          const prev = row.previousElementSibling ? row.previousElementSibling.querySelector('input') : null;
          row.remove();
          if (prev) prev.focus();
        }
      }
    });

    // Suppression d’un <li> vide avec Backspace dans Bonus de race & Capacités
    document.querySelectorAll('.abilities-list').forEach(list => {
      list.addEventListener('keydown', (e) => {
        if (e.key === 'Backspace') {
          const sel = window.getSelection();
          if (!sel || !sel.anchorNode) return;
          const li = sel.anchorNode.closest('li');
          if (li && li.textContent.trim() === '' && list.children.length > 1) {
            e.preventDefault();
            const prev = li.previousElementSibling || li.nextElementSibling;
            const range = document.createRange();
            li.remove();
            if (prev) {
              range.selectNodeContents(prev);
              range.collapse(false);
              sel.removeAllRanges();
              sel.addRange(range);
            }
          }
        }
      });
    });
    // Bouton impression
    const printBtn=document.getElementById('print-btn');
    if(printBtn){printBtn.addEventListener('click',()=>window.print());}
    
    // ========== SYSTÈME DE DÉGÂTS ==========
    let damageEntries = [];
    
    function initDamageSystem() {
      const addBtn = document.getElementById('add-damage-btn');
      if (addBtn) {
        addBtn.addEventListener('click', function() {
          createDamageEntry(1, 'D6', 0, '');
        });
      }
      
      const toggleBtn = document.getElementById('damage-toggle-btn');
      if (toggleBtn) {
        toggleBtn.addEventListener('click', function() {
          const entries = document.getElementById('damage-entries');
          const addBtn = document.getElementById('add-damage-btn');
          if (entries) {
            entries.classList.toggle('show');
            addBtn.style.display = entries.classList.contains('show') ? 'block' : 'none';
            toggleBtn.textContent = entries.classList.contains('show') ? 'Fermer' : 'Éditer';
          }
        });
      }
      
      // Hide add button by default
      const addBtnEl = document.getElementById('add-damage-btn');
      if (addBtnEl) addBtnEl.style.display = 'none';
      
      updateDamageFormula();
    }
    
    function createDamageEntry(diceCount, diceType, bonus, label) {
      const entry = {
        id: Date.now() + Math.random(),
        diceCount: diceCount || 1,
        diceType: diceType || 'D6',
        bonus: bonus || 0,
        label: label || ''
      };
      damageEntries.push(entry);
      renderDamageEntries();
      updateDamageFormula();
    }
    
    function removeDamageEntry(id) {
      damageEntries = damageEntries.filter(e => e.id !== id);
      renderDamageEntries();
      updateDamageFormula();
    }
    
    function updateDamageEntry(id, field, value) {
      const entry = damageEntries.find(e => e.id === id);
      if (entry) {
        if (field === 'diceCount' || field === 'bonus') {
          entry[field] = parseInt(value) || 0;
        } else {
          entry[field] = value;
        }
        updateDamageFormula();
      }
    }
    
    function renderDamageEntries() {
      const container = document.getElementById('damage-entries');
      if (!container) return;
      
      container.innerHTML = '';
      
      damageEntries.forEach(entry => {
        const div = document.createElement('div');
        div.className = 'damage-entry';
        div.innerHTML = `
          <select onchange="updateDamageEntry(${entry.id}, 'diceCount', this.value)">
            ${[1, 2, 3, 4, 5, 6, 7, 8, 9, 10].map(n => 
              `<option value="${n}" ${entry.diceCount === n ? 'selected' : ''}>${n}</option>`
            ).join('')}
          </select>
          <select onchange="updateDamageEntry(${entry.id}, 'diceType', this.value)">
            ${['D4', 'D6', 'D8', 'D10', 'D12', 'D20', 'D100'].map(d => 
              `<option value="${d}" ${entry.diceType === d ? 'selected' : ''}>${d}</option>`
            ).join('')}
          </select>
          <span style="font-weight:bold;">+</span>
          <input type="number" value="${entry.bonus}" min="-99" max="99" onchange="updateDamageEntry(${entry.id}, 'bonus', this.value)" placeholder="0">
          <input type="text" value="${entry.label}" onchange="updateDamageEntry(${entry.id}, 'label', this.value)" placeholder="Source (ex: épée longue)">
          <button class="remove-damage-btn" onclick="removeDamageEntry(${entry.id})">×</button>
        `;
        container.appendChild(div);
      });
    }
    
    function updateDamageFormula() {
      const formulaDiv = document.getElementById('damage-formula');
      if (!formulaDiv) return;
      
      if (damageEntries.length === 0) {
        formulaDiv.textContent = '—';
        return;
      }
      
      const parts = damageEntries.map(entry => {
        let part = '';
        if (entry.diceCount > 1) {
          part = `${entry.diceCount}${entry.diceType}`;
        } else {
          part = entry.diceType;
        }
        if (entry.bonus > 0) {
          part += `+${entry.bonus}`;
        } else if (entry.bonus < 0) {
          part += `${entry.bonus}`;
        }
        return `(${part})`;
      });
      
      formulaDiv.textContent = parts.join(' + ');
    }
    
    // ========== SYSTÈME DE RD ==========
    let rdEntries = [];
    
    function initRDSystem() {
      const addBtn = document.getElementById('add-rd-btn');
      if (addBtn) {
        addBtn.addEventListener('click', function() {
          createRDEntry(0, '');
        });
      }
      
      const toggleBtn = document.getElementById('rd-toggle-btn');
      if (toggleBtn) {
        toggleBtn.addEventListener('click', function() {
          const entries = document.getElementById('rd-entries');
          const addBtn = document.getElementById('add-rd-btn');
          if (entries) {
            entries.classList.toggle('show');
            addBtn.style.display = entries.classList.contains('show') ? 'block' : 'none';
            toggleBtn.textContent = entries.classList.contains('show') ? 'Fermer' : 'Éditer';
          }
        });
      }
      
      // Hide add button by default
      const addBtnEl = document.getElementById('add-rd-btn');
      if (addBtnEl) addBtnEl.style.display = 'none';
      
      updateRDFormula();
    }
    
    function createRDEntry(value, label) {
      const entry = {
        id: Date.now() + Math.random(),
        value: value || 0,
        label: label || ''
      };
      rdEntries.push(entry);
      renderRDEntries();
      updateRDFormula();
    }
    
    function removeRDEntry(id) {
      rdEntries = rdEntries.filter(e => e.id !== id);
      renderRDEntries();
      updateRDFormula();
    }
    
    function updateRDEntry(id, field, value) {
      const entry = rdEntries.find(e => e.id === id);
      if (entry) {
        if (field === 'value') {
          entry[field] = parseInt(value) || 0;
        } else {
          entry[field] = value;
        }
        updateRDFormula();
      }
    }
    
    function renderRDEntries() {
      const container = document.getElementById('rd-entries');
      if (!container) return;
      
      container.innerHTML = '';
      
      rdEntries.forEach(entry => {
        const div = document.createElement('div');
        div.className = 'damage-entry';
        div.innerHTML = `
          <span style="font-weight:bold; color:#666;">RD</span>
          <input type="number" value="${entry.value}" min="0" max="999" onchange="updateRDEntry(${entry.id}, 'value', this.value)" placeholder="0" style="width:60px;">
          <input type="text" value="${entry.label}" onchange="updateRDEntry(${entry.id}, 'label', this.value)" placeholder="Source (ex: Armure)">
          <button class="remove-damage-btn" onclick="removeRDEntry(${entry.id})">×</button>
        `;
        container.appendChild(div);
      });
    }
    
    function updateRDFormula() {
      const formulaDiv = document.getElementById('rd-formula');
      if (!formulaDiv) return;
      
      if (rdEntries.length === 0) {
        formulaDiv.textContent = 'RD —';
        return;
      }
      
      const total = rdEntries.reduce((sum, entry) => sum + (entry.value || 0), 0);
      formulaDiv.textContent = `RD ${total}`;
    }
    
    // Expose functions globally
    window.updateDamageEntry = updateDamageEntry;
    window.removeDamageEntry = removeDamageEntry;
    window.updateRDEntry = updateRDEntry;
    window.removeRDEntry = removeRDEntry;
    
    // Initialize systems
    initDamageSystem();
    initRDSystem();
    
    // ========== SAVE / LOAD PROFILE ==========
    function collectSheetData() {
      const data = {
        version: '1.0',
        savedAt: new Date().toISOString(),
        sheet: {
          name: document.getElementById('name')?.value || '',
          level: document.getElementById('level')?.value || '',
          race: document.getElementById('race')?.value || '',
          classe: document.getElementById('class')?.value || '',
          alignement: document.getElementById('alignement')?.value || '',
          attributes: {},
          attributeBonuses: {},
          vitals: {},
          bonusRace: [],
          skills: [],
          abilities: [],
          descriptions: {},
          notes: '',
          avatar: ''
        }
      };
      
      // Collect attributes
      ['force', 'dex', 'emp', 'sag', 'int'].forEach(attr => {
        const input = document.getElementById(attr);
        if (input) {
          data.sheet.attributes[attr] = input.value;
          // Get bonus input (the text input next to dice)
          const box = input.closest('.attr-box');
          if (box) {
            const bonusInput = box.querySelector('input[type="text"]');
            if (bonusInput) {
              data.sheet.attributeBonuses[attr] = bonusInput.value;
            }
          }
        }
      });
      
      // Collect vitals
      data.sheet.vitals = {
        pvMax: document.getElementById('pv-max')?.value || '',
        pvTemp: document.getElementById('pv-temp')?.value || '',
        pvCurrent: document.getElementById('pv-current')?.value || '',
        pfMax: document.getElementById('pf-max')?.value || '',
        pfCurrent: document.getElementById('pf-current')?.value || ''
      };
      
      // Collect bonus de race
      const bonusSections = document.querySelectorAll('.section, .half-section');
      bonusSections.forEach(section => {
        const h3 = section.querySelector('h3');
        if (h3 && h3.textContent.includes('Bonus de race')) {
          const list = section.querySelector('.abilities-list');
          if (list) {
            list.querySelectorAll('li').forEach(li => {
              const html = li.innerHTML?.trim();
              if (html) data.sheet.bonusRace.push(html);
            });
          }
        }
      });
      
      // Collect skills
      const skillRows = document.querySelectorAll('.skill-table tbody tr');
      skillRows.forEach(row => {
        const inputs = row.querySelectorAll('input');
        if (inputs.length >= 3) {
          const name = inputs[0].value?.trim();
          const attr = inputs[1].value?.trim();
          const bonus = inputs[2].value?.trim();
          if (name || attr || bonus) {
            data.sheet.skills.push({ name, attr, bonus });
          }
        }
      });
      
      // Collect abilities
      const abilitySections = document.querySelectorAll('.section');
      abilitySections.forEach(section => {
        const h3 = section.querySelector('h3');
        if (h3 && (h3.textContent.includes('Capacités') || h3.textContent.includes('Avantages'))) {
          const list = section.querySelector('.abilities-list');
          if (list) {
            list.querySelectorAll('li').forEach(li => {
              const html = li.innerHTML?.trim();
              if (html) data.sheet.abilities.push(html);
            });
          }
        }
      });
      
      // Collect descriptions (textareas in half-sections)
      const halfSections = document.querySelectorAll('.half-section');
      halfSections.forEach(section => {
        const h3 = section.querySelector('h3')?.textContent?.trim();
        const ta = section.querySelector('textarea');
        if (h3 && ta) {
          data.sheet.descriptions[h3] = ta.value || '';
        }
      });
      
      // Collect notes (portrait section)
      const portraitSection = document.querySelector('.portrait');
      if (portraitSection) {
        const ta = portraitSection.querySelector('textarea');
        if (ta) {
          data.sheet.notes = ta.value || '';
        }
      }
      
      // Collect avatar
      const avatarPreview = document.getElementById('avatar-preview');
      if (avatarPreview && avatarPreview.style.display !== 'none' && avatarPreview.src) {
        data.sheet.avatar = avatarPreview.src;
      }
      
      // Collect damage entries
      data.sheet.damageEntries = damageEntries;
      
      // Collect RD entries
      data.sheet.rdEntries = rdEntries;
      
      return data;
    }
    
    function restoreSheetData(data) {
      const sheet = data.sheet;
      if (!sheet) return;
      
      // Restore basic fields
      if (document.getElementById('name')) document.getElementById('name').value = sheet.name || '';
      if (document.getElementById('level')) document.getElementById('level').value = sheet.level || '';
      if (document.getElementById('race')) document.getElementById('race').value = sheet.race || '';
      if (document.getElementById('class')) document.getElementById('class').value = sheet.classe || '';
      if (document.getElementById('alignement')) document.getElementById('alignement').value = sheet.alignement || '';
      
      // Restore attributes
      if (sheet.attributes) {
        ['force', 'dex', 'emp', 'sag', 'int'].forEach(attr => {
          const input = document.getElementById(attr);
          if (input && sheet.attributes[attr] !== undefined) {
            input.value = sheet.attributes[attr];
            input.dispatchEvent(new Event('input'));
          }
          // Restore bonus
          if (sheet.attributeBonuses && sheet.attributeBonuses[attr] !== undefined) {
            const box = input?.closest('.attr-box');
            if (box) {
              const bonusInput = box.querySelector('input[type="text"]');
              if (bonusInput) {
                bonusInput.value = sheet.attributeBonuses[attr];
              }
            }
          }
        });
      }
      
      // Restore vitals
      if (sheet.vitals) {
        if (document.getElementById('pv-max')) document.getElementById('pv-max').value = sheet.vitals.pvMax || '';
        if (document.getElementById('pv-temp')) document.getElementById('pv-temp').value = sheet.vitals.pvTemp || '';
        if (document.getElementById('pv-current')) document.getElementById('pv-current').value = sheet.vitals.pvCurrent || '';
        if (document.getElementById('pf-max')) document.getElementById('pf-max').value = sheet.vitals.pfMax || '';
        if (document.getElementById('pf-current')) document.getElementById('pf-current').value = sheet.vitals.pfCurrent || '';
      }
      
      // Restore bonus de race
      if (sheet.bonusRace && sheet.bonusRace.length > 0) {
        const bonusSections = document.querySelectorAll('.section, .half-section');
        bonusSections.forEach(section => {
          const h3 = section.querySelector('h3');
          if (h3 && h3.textContent.includes('Bonus de race')) {
            const list = section.querySelector('.abilities-list');
            if (list) {
              list.innerHTML = sheet.bonusRace.map(b => `<li>${b}</li>`).join('');
            }
          }
        });
      }
      
      // Restore skills
      if (sheet.skills && sheet.skills.length > 0) {
        const tbody = document.querySelector('.skill-table tbody');
        if (tbody) {
          tbody.innerHTML = '';
          sheet.skills.forEach(skill => {
            const row = document.createElement('tr');
            row.innerHTML = `
              <td><input value="${skill.name || ''}" /></td>
              <td><input value="${skill.attr || ''}" placeholder="FOR" /></td>
              <td><input type="text" value="${skill.bonus || ''}" placeholder="+0" style="text-align:center;" /></td>
            `;
            tbody.appendChild(row);
          });
        }
      }
      
      // Restore abilities
      if (sheet.abilities && sheet.abilities.length > 0) {
        const abilitySections = document.querySelectorAll('.section');
        abilitySections.forEach(section => {
          const h3 = section.querySelector('h3');
          if (h3 && (h3.textContent.includes('Capacités') || h3.textContent.includes('Avantages'))) {
            const list = section.querySelector('.abilities-list');
            if (list) {
              list.innerHTML = sheet.abilities.map(a => `<li>${a}</li>`).join('');
            }
          }
        });
      }
      
      // Restore descriptions
      if (sheet.descriptions) {
        const halfSections = document.querySelectorAll('.half-section');
        halfSections.forEach(section => {
          const h3 = section.querySelector('h3')?.textContent?.trim();
          const ta = section.querySelector('textarea');
          if (h3 && ta && sheet.descriptions[h3] !== undefined) {
            ta.value = sheet.descriptions[h3];
          }
        });
      }
      
      // Restore notes
      if (sheet.notes) {
        const portraitSection = document.querySelector('.portrait');
        if (portraitSection) {
          const ta = portraitSection.querySelector('textarea');
          if (ta) {
            ta.value = sheet.notes;
          }
        }
      }
      
      // Restore avatar
      if (sheet.avatar && sheet.avatar.startsWith('data:')) {
        const avatarPreview = document.getElementById('avatar-preview');
        const avatarInput = document.getElementById('avatar-input');
        if (avatarPreview) {
          avatarPreview.src = sheet.avatar;
          avatarPreview.style.display = 'block';
          if (avatarInput) avatarInput.style.display = 'none';
        }
      }
      
      // Restore damage entries
      if (sheet.damageEntries && Array.isArray(sheet.damageEntries)) {
        damageEntries = sheet.damageEntries;
        renderDamageEntries();
        updateDamageFormula();
        // Show entries if there are any
        if (damageEntries.length > 0) {
          const entries = document.getElementById('damage-entries');
          const addBtn = document.getElementById('add-damage-btn');
          const toggleBtn = document.getElementById('damage-toggle-btn');
          if (entries) entries.classList.add('show');
          if (addBtn) addBtn.style.display = 'block';
          if (toggleBtn) toggleBtn.textContent = 'Fermer';
        }
      }
      
      // Restore RD entries
      if (sheet.rdEntries && Array.isArray(sheet.rdEntries)) {
        rdEntries = sheet.rdEntries;
        renderRDEntries();
        updateRDFormula();
        // Show entries if there are any
        if (rdEntries.length > 0) {
          const entries = document.getElementById('rd-entries');
          const addBtn = document.getElementById('add-rd-btn');
          const toggleBtn = document.getElementById('rd-toggle-btn');
          if (entries) entries.classList.add('show');
          if (addBtn) addBtn.style.display = 'block';
          if (toggleBtn) toggleBtn.textContent = 'Fermer';
        }
      }
      
      // Auto-resize all textareas after import
      autoResizeTextareas();
    }
    
    // Helper function to auto-resize all textareas
    function autoResizeTextareas() {
      document.querySelectorAll('.half-section textarea, .portrait textarea').forEach(ta => {
        ta.style.height = 'auto';
        ta.style.height = (ta.scrollHeight) + 'px';
      });
    }
    
    function saveProfile() {
      const data = collectSheetData();
      const charName = data.sheet.name || 'personnage';
      const filename = `${charName.replace(/[^a-z0-9àâäéèêëïîôùûüç]/gi, '_')}_profile.json`;
      
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      
      // Notification
      showNotification('✅ Profil sauvegardé !', '#27ae60');
    }
    
    function loadProfile(file) {
      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const data = JSON.parse(e.target.result);
          restoreSheetData(data);
          showNotification('✅ Profil chargé avec succès !', '#3498db');
        } catch (err) {
          showNotification('❌ Erreur lors du chargement : ' + err.message, '#e74c3c');
        }
      };
      reader.readAsText(file);
    }
    
    function showNotification(message, color) {
      const notification = document.createElement('div');
      notification.style.cssText = `position:fixed;top:20px;left:50%;transform:translateX(-50%);background:${color};color:#fff;padding:1rem 2rem;border-radius:0.5rem;font-weight:bold;z-index:9999;box-shadow:0 4px 15px rgba(0,0,0,0.2);`;
      notification.textContent = message;
      document.body.appendChild(notification);
      setTimeout(() => notification.remove(), 3000);
    }
    
    // Event listeners for save/load
    const saveBtn = document.getElementById('save-profile-btn');
    const loadBtn = document.getElementById('load-profile-btn');
    const loadInput = document.getElementById('load-profile-input');
    
    if (saveBtn) {
      saveBtn.addEventListener('click', saveProfile);
    }
    if (loadBtn && loadInput) {
      loadBtn.addEventListener('click', () => loadInput.click());
      loadInput.addEventListener('change', (e) => {
        if (e.target.files && e.target.files[0]) {
          loadProfile(e.target.files[0]);
          e.target.value = '';
        }
      });
    }

    // Chargement de l'image personnage + toggle bouton
    const fileInput = document.getElementById('avatar-input');
    const previewImg = document.getElementById('avatar-preview');

    if(fileInput){
      // cliquer sur l’image rouvre le sélecteur
      previewImg.addEventListener('click', ()=> fileInput.click());

      fileInput.addEventListener('change', e => {
        const file = e.target.files[0];
        if(file){
          const reader = new FileReader();
          reader.onload = ev => {
            previewImg.src = ev.target.result;
            previewImg.style.display = 'block';
            fileInput.style.display = 'none';
          };
          reader.readAsDataURL(file);
        }
      });
    }

    // auto-grow textarea
    document.querySelectorAll('.auto-grow').forEach(area=>{
      const resize=()=>{area.style.height='auto';area.style.height=area.scrollHeight+'px';};
      area.addEventListener('input',resize);
      resize();
    });

    // ========== WIZARD DE CRÉATION ==========
    (function() {
      // Données de création intégrées directement (pour fonctionner sans serveur)
      const characterData = {
        "races": [
          {"id":"humain","name":"Humain","description":"Espèce « dominante », réputée pour son adaptabilité et son sens des affaires. Souvent ouverts aux nouveautés, les humains sont une espèce essentiellement citadine.","bonuses":["Compétent : +1 point de création/niveau (niveau 1 compris)","Adaptable : peut apprendre un avantage racial d'une autre race en trouvant un Maître et en y consacrant du temps"],"maluses":["Complexé : raciste/haineux envers une race au choix. Perd 2 niveaux de Charisme lors des interactions avec cette race"]},
          {"id":"cryx","name":"Cryx","description":"Espèce la moins courante, en trouver un est toujours un événement majeur. On dit qu'ils sont nés du cristal et qu'en voir un peut changer une vie.","bonuses":["Mage-né : +2 niveaux de dé en Sagesse","Pacifistes : commence avec la compétence Diplomatie à 3"],"maluses":["Destin lié : chaque Cryx entre en résonance avec une seule et unique personne dans le monde. Un jour il rencontrera cette personne, sera incapable de lui causer du tort et deviendra son génie personnel"]},
          {"id":"corion","name":"Corion","description":"Race souterraine, ils protègent jalousement le lieu de leurs bastions. Civilisation mystérieuse aux mœurs étranges, par exemple ils utilisent les odeurs pour délimiter leur territoire personnel à la manière d'animaux. Les guerriers Corions sont réputés pour leur brutalité.","bonuses":["Nageroche : le personnage peut nager dans la terre ou creuser facilement","Odorat développé : gagne un niveau de dé sur les tests où l'odorat est en jeu"],"maluses":["Aveugle : le personnage est aveugle, perd un niveau de dé pour toute action où la vue est importante"]},
          {"id":"haut-nain","name":"Haut-Nain","description":"La légende raconte que les nains étaient à l'époque faits de chair et de sang comme toutes autres races. Mais nul n'en a vu ces derniers siècles. Les Haut-Nains sont connus pour leur sens des affaires et leurs talents magiques et d'artisanat. C'est un peuple divisé en castes : selon le matériau dont est composé le nain, une tâche lui est dévolue dans la société archinaine.","bonuses":["Artisa'Nain : commence avec une rune d'un ancêtre gravée à même le corps, magique, qui donne +2 niveaux de compétence selon le domaine d'expertise de l'ancêtre","Corps de métal : porteur sain de toute toxine"],"maluses":["Sang de fer : les PV rendus magiquement sont divisés par 2. Soigner un nain non magiquement se fait avec le métal constitutif du nain et un jet d'Artisanat (Forge)"]},
          {"id":"troll","name":"Troll","description":"Les Trolls vivent dans de gigantesques ruches creusées dans le sol, d'argile et de boue. Ils sont d'un naturel curieux et adorent essayer des choses pour « la science ». Fait important : leur biologie fait que les Trolls naissent gigantesques et se ratatinent avec le temps, gagnant des capacités mentales en échange de leur force.","bonuses":["Évolution : le personnage commence avec −2 niveaux en Sagesse et Intelligence, et +2 niveaux en Force et Dextérité. À chaque palier de 5 niveaux (5, 10, 15, 20), il échange un −1 et un +1","Pour la Reine ! : les Trolls sont loyaux envers leur nation. Toute action menaçant la ruche est proscrite"],"maluses":["Esprit faible : le Troll possède naturellement −5 dans la compétence Volonté"]},
          {"id":"dryade","name":"Dryade","description":"Nées des arbres, les dryades apprécient les arts et le calme. Pas très fans de politique, elles préfèrent en général être dirigeantes à tour de rôle ou jouer ce rôle aux jeux. Les sédentaires restent dans leur forêt tandis que les aventureuses taillent leur équipement fétiche dans leur arbre-cœur.","bonuses":["Méditation : le personnage peut évaluer l'état d'un milieu naturel en y passant quelques minutes (maladie, présence de danger, etc.)","Arbre-cœur : l'objet en arbre-cœur donne +1 niveau de caractéristique au choix"],"maluses":["Arbre-cœur : si l'objet en arbre-cœur est détruit, les fonctions vitales de la dryade lâchent, elle devient orpheline. Les soins magiques ou non ne fonctionnent plus"]},
          {"id":"champignomes","name":"Champignome","description":"Peuple de petite taille, les champignomes sont des charognards qui ne mangent que ce qu'ils trouvent par terre. Ils vivent en général en village, érigés autour de plantes rares dont ils prennent grand soin. De ce fait, ils ont souvent des problèmes avec les alchimistes peu scrupuleux.","bonuses":["Bouffe-tout : les champignomes peuvent consommer tout ce qui est organique sans risque","Harmonie : les champignomes font pousser/modèlent les plantes à leur guise"],"maluses":["« Les médecins le détestent » : les alchimistes ont pris pour habitude de mettre des poudres minérales dans les potions, ce qui les rend toxiques pour les champignomes"]},
          {"id":"elfe-vent","name":"Elfe du Vent","description":"Les elfes du vent sont les seuls elfes rescapés de la colère d'Axell. Peuple traumatisé issu d'un ancien empire, ils ont perdu beaucoup pour en arriver à l'enclave restante. Ce sont les maîtres des bateaux volants et malgré leur passé impérialiste, leur bienveillance a laissé des populations non hostiles envers eux.","bonuses":["Magie du vent : les elfes du vent manipulent le vent","Vision nocturne : les elfes voient dans le noir absolu"],"maluses":["Gemme du Vent : les elfes du vent possèdent une gemme qui est le siège de leur essence sur le front ou le thorax. Tout dégât ou modification de cette gemme se répercute de manière accentuée sur lui"]},
          {"id":"vestal","name":"Vestal","description":"Les vestals vivent dans les cieux, sur des rochers escarpés à l'écart des autres populations. Ce peuple volant possède une affinité avec les milieux chauds car nichant parfois à flanc de volcan. Ils vivent dans des nids creusés dans des cavernes à même les falaises et se nourrissent principalement des fruits qu'ils vont cueillir.","bonuses":["Ailes : le vestal sait voler","Résistance élémentaire : résiste naturellement au feu et aux températures élevées"],"maluses":["Ossature légère : la Force n'est pas dans le calcul des PV du vestal"]},
          {"id":"orc","name":"Orc","description":"Souvent plus athlétiques et coriaces, les orcs vivent dans une société clanique patriarcale. Ils sont connus pour leur soif d'aventure et leur goût de l'adrénaline dû à leur espérance de vie relativement courte. L'idée est de vivre un maximum d'expériences exceptionnelles. Le sens de l'honneur est apprécié chez ces peaux vertes. On les voit souvent dans des rôles de mercenaires ou de gardes du corps.","bonuses":["Berz'Orc : ignore 1 blessure en combat","Aware : l'orc commence avec +1 dans les compétences Perception et Discrétion"],"maluses":["« Shot Magus First » : les Orcs se méfient de la magie et n'aiment pas les mages. Lui lancer un sort, même gentil, c'est prendre l'aggro"]},
          {"id":"ogre","name":"Ogre","description":"Un ogre, c'est moche. OK. Mais un ogre, est-ce que c'est méchant ? Souvent, c'est le méchant de l'histoire, probablement dû au passé et aux ambitions de leur roi Argold qui n'a jamais caché son sentiment de supériorité vis-à-vis des autres races. Les ogres sont des experts de la discrétion et de l'alchimie, ce qui fait d'eux le coupable idéal quel que soit le problème.","bonuses":["Esprit scientifique : +2 niveaux de dé en Intelligence","Sans trace : un ogre ne laisse pas de trace ni d'odeur"],"maluses":["Sale réputation : en plus d'être la cible de racisme, l'ogre n'inspire pas confiance. Il a −5 à ses jets sociaux quand il ne s'adresse pas à un ogre"]},
          {"id":"canitaure","name":"Canitaure","description":"Probablement les invités les plus rares à un banquet. Pas qu'ils soient de mauvaise compagnie, mais il est connu que les canitaures ont un appétit démesuré. Continuellement en guerre avec leurs cousins équidés, les canitaures sont malgré tout de bons vivants qui apprécient les plaisirs de la vie. En ville, ils font de terribles gardes et geôliers, mais d'excellents chasseurs.","bonuses":["Chef naturel : le canitaure s'impose par son physique. +1 niveau de dé en Charisme et +1 niveau de dé en Dextérité","Rapide : ça court vite cette saloperie ! +2 en Athlétisme"],"maluses":["Compétiteur : que ce soit un individu qui court ou une baballe, le canitaure ne supporte pas qu'une compétition se déroule sans lui, et il fera tout pour la gagner"]},
          {"id":"gravel","name":"Gravel","description":"Les Gravels vivent en caravanes lentes qui parcourent les routes commerciales les plus dangereuses, là où nul autre peuple n'ose s'installer durablement. Ils valorisent la constance, la fiabilité et la parole donnée plus que l'or ou les titres. Chez eux, rompre une promesse est considéré comme pire qu'un crime, car « ce qui est lourd ne doit pas mentir ».","bonuses":["Force gravitationnelle : incroyablement résistants, quasi impossibles à repousser ou renverser. +2 niveaux de dé en Force","Inertie contrôlée : résistent aux explosions, vents violents, champs de force. +4 pour ne pas bouger"],"maluses":["Lenteur chronique : déplacements plus lents, esquives difficiles, poursuites compliquées. −1 niveau de dé en Dextérité"]},
          {"id":"goule","name":"Goule","description":"D'apparence repoussante (tête rappelant des êtres troglodytes, sabots, etc.), les goules ont trouvé jadis un moyen de passer inaperçu… la métamorphose ! Elles étaient à l'origine une création de magiciens, mais ont réussi pour certaines à échapper aux maîtres pour s'organiser et s'établir. Dotées d'une grande adaptabilité mais aussi d'une grosse allergie à la flore, elles ont réussi à se faire une place discrète dans le monde.","bonuses":["Aruspice des entrailles : permet de lire une partie de l'avenir dans des entrailles","Formes supplémentaires : vieillard ou chien. 5 PF pour changer de forme, passage possible de l'une à l'autre sans repasser par la forme de base. Revenir à la forme de base est gratuit"],"maluses":["Allergie aux plantes : allergie SUPRA sévère, même au simple contact"]},
          {"id":"sylphide-cendre","name":"Sylphide Cendré","description":"Peau gris clair, cheveux comme de la fumée, voix sifflante. Les Sylphides cendrés vivent autour des volcans, des plaines brûlées et des régions que le feu a déjà traversées, qu'ils considèrent comme des lieux sacrés de renouveau. Ils voient la destruction non comme une fin, mais comme une transition nécessaire. Leur société est légère, presque nomade, et ils évitent de s'attacher durablement aux choses matérielles.","bonuses":["Né dans l'horreur : ruines et massacres sont des lieux de naissance pour les sylphides. Immunisés à la peur et au désespoir","Insaisissables : bonus pour échapper aux prises, filets, attaques d'opportunité. +4"],"maluses":["Corps fragile : faiblesse aux dégâts contondants"]},
          {"id":"vermelune","name":"Vermelune","description":"Les Vermelunes organisent toute leur société autour de cycles internes invisibles qu'eux seuls perçoivent : périodes de force, de retrait, de lucidité ou de rêve. Leurs villes sont construites pour accueillir ces rythmes. Ils considèrent l'immobilité comme une forme de mort et le changement comme une vertu cardinale. Ils vivent selon des « marées personnelles » que seuls eux ressentent.","bonuses":["Adaptation cyclique : à chaque début de séance, le joueur lance un D6 pour connaître sa « marée » : 1-2 physique (+2 Force ou Dex), 3-4 mentale (+2 Int ou Sag), 5-6 sociale (+2 Charisme)","Résistance adaptative : gagne une résistance au dernier type de dégât subi"],"maluses":["Imprévisibles : malus aux actions répétitives, aux routines et aux plans longs (ils détestent la monotonie)"]},
          {"id":"mits","name":"Mits","description":"Les Mits vivent rarement entre eux : ils préfèrent s'insérer dans les sociétés existantes, comme s'ils cherchaient à accomplir un rôle plutôt qu'à fonder un peuple. Ils accordent une immense importance aux récits, aux légendes et aux symboles, qu'ils considèrent comme aussi réels que la pierre ou le sang. Beaucoup choisissent une « fonction » dans la société : gardien, messager, traître, prophète, et s'efforcent de l'incarner parfaitement. Ils ne naissent pas biologiquement mais conceptuellement : nés d'un rêve, d'une prière, d'un mythe ancien presque oublié.","bonuses":["Nature symbolique : immunisé aux attaques non intentionnelles (pièges, accidents, effets « sans volonté », éboulements). Ce qui n'est pas dirigé contre eux explicitement les affecte peu","Présence mythique : les peuples simples les prennent pour des signes, des élus ou des mauvais présages. +2 en social"],"maluses":["Vulnérables à la magie"]},
          {"id":"ananostegit","name":"Ananostégit","description":"Les Ananostégits vivent légèrement décalés par rapport au monde qui les entoure : ils perçoivent le temps comme un flux élastique et agissent parfois « avant » ou « après » les événements. Leur société est fondée sur la patience et la prévoyance. Ils considèrent l'improvisation comme une faiblesse et enseignent à leurs jeunes à observer les cycles invisibles du monde. Pour les étrangers, ils paraissent distraits ou imprévisibles, mais chaque Ananostégit sait exactement quand frapper, parler ou disparaître.","bonuses":["Décalage temporel : peut une fois par séance : relancer une action ratée (comme s'il « corrigeait » la timeline), agir avant l'initiative normale, ou ignorer une attaque en disant « non, ça n'est pas arrivé comme ça »","Résistance au paradoxe : quand le temps s'arrête, pas toi"],"maluses":["Conservateur : pour l'Ananostégit, les autres races sont des enfants qui doivent être guidés. Regard désapprobateur à toute innovation qui n'est pas de leur fait, et très maniaque"]},
          {"id":"lustrien","name":"Lustrien","description":"Doués dans des sphères spécifiques dès la naissance, les lustriens se sont organisés comme des fourmis, se répartissant les rôles telles des ouvrières pour être plus efficaces. Ayant pris les commandes de leur continent d'origine et s'y étant confinés, les lustriens, tant chez eux que dans le reste du monde, attirent les regards car il est extrêmement rare d'en voir mêlés à d'autres races.","bonuses":["Génie : une caractéristique à déterminer à la création ne coûtera plus que 4 points à monter","Mémoire eidétique : les lustriens se rappellent parfaitement de tout ce qu'ils ont vu, entendu ou vécu"],"maluses":["Outsider : les lustriens sont par défaut assez peu discrets et on les voit dans une foule. −5 en Discrétion"]},
          {"id":"centaure","name":"Centaure","description":"Créature extrêmement rare vue par certains comme des gardiens et par d'autres comme des monstres, les centaures parcourant Gaïa sont peu nombreux mais semblent investis d'une mission chaque fois qu'on les voit.","bonuses":["Force : +1 niveau de dé en Force","Charge : action gratuite pour aller à la rencontre d'un individu ou se désengager"],"maluses":["Héritage de Bambi : si le Centaure se fait charger ou est aveuglé, il rate sa défense. Si les 2 conditions sont réunies, c'est un critique"]}
        ],
        "classes": [
          {"id":"monteur-meubles","name":"Monteur de Meubles","description":"Artisan robuste et polyvalent, le monteur de meubles excelle dans le bricolage et sait transformer n'importe quoi en arme redoutable.","avantages":[{"id":"bidouille","name":"La Bidouil' !","description":"+Niveau/2 aux jets relatifs au bricolage"},{"id":"ferrailleur","name":"Ferrailleur","description":"1 contact donne 1 cargaison d'un matériau au début de la séance, dans la limite des stocks disponibles"},{"id":"boutique","name":"Boutique","description":"C'est une boutique, tout ce qu'il y a de plus boutiqual"},{"id":"apprenti","name":"Apprenti","description":"Il peut aider mais il ne fera jamais mieux ou aussi bien que toi"},{"id":"chef-oeuvre","name":"Chef-d'œuvre","description":"Bonus de qualité permanent ou gros boost sur 1 objet"},{"id":"flip-table","name":"Flip the Table","description":"Attaque de zone tournoyante"},{"id":"fureur","name":"Fureur","description":"+Niveau/2 dégâts"},{"id":"ensevelir","name":"Ensevelir","description":"Enchevêtrement"},{"id":"cri-rage","name":"Cri de Rage","description":"+Niveau/2 attaque PJ pendant Force tours"},{"id":"il-en-faut-plus","name":"IL EN FAUT PLUS","description":"Permet de revenir full PV, seulement s'il t'en restait au moins un peu. Prochaines actions à −5"}]},
          {"id":"inspecteur-impots","name":"Inspecteur des Impôts","description":"Expert en infiltration urbaine et en analyse, l'inspecteur des impôts sait se fondre dans la masse et débusquer les secrets les mieux gardés.","avantages":[{"id":"tout-le-monde","name":"M. Tout-Le-Monde","description":"+Niveau/2 Discrétion en ville"},{"id":"main-habile","name":"Main habile","description":"+2 niveaux de dé en Dextérité"},{"id":"dossier","name":"Nous allons devoir étudier votre dossier","description":"+Niveau/2 Baratin"},{"id":"perception-ultime","name":"Perception Ultime","description":"+Niveau/2 Perception en ville"},{"id":"analyse","name":"Analyse","description":"Quantité et qualité des objets"},{"id":"appel-monture","name":"Appel de la Monture","description":"Appelle sa monture à distance"},{"id":"monture-inspecteur","name":"Monture d'Inspecteur","description":"Possède une monture loyale"},{"id":"combat-monte","name":"Combat Monté","description":"+Niveau/2 combat à cheval"},{"id":"monture-guerre","name":"Monture de Guerre","description":"Amélioration combat de la monture"},{"id":"ne-faire-quun","name":"Ne Faire Qu'Un","description":"Transfert de PV avec la monture"}]},
          {"id":"laborantin","name":"Laborantin","description":"Scientifique et guérisseur, le laborantin maîtrise l'art des soins et possède une résistance naturelle à la magie.","avantages":[{"id":"diagnostic-rapide","name":"Diagnostic Rapide","description":"Identifie rapidement blessures et maladies"},{"id":"soin-rapide","name":"Soin Rapide","description":"Soigne plus vite"},{"id":"cuisine","name":"Cuisine","description":"+Niveau/2 Cuisine"},{"id":"resurrection","name":"Résurrection","description":"Fait revenir à 1 PV un héros, 1×/scénario"},{"id":"cultiver-herbes","name":"Cultiver les herbes","description":"Fait pousser des herbes médicinales"},{"id":"insensibilite-magie","name":"Insensibilité à la Magie","description":"+Niveau/2 Volonté contre magie"},{"id":"drain-magie","name":"Drain de Magie","description":"Par contact, Volonté vs Volonté pour prendre des PF à une cible"},{"id":"desenchantement","name":"Désenchantement","description":"Rituel, permet de retirer la magie d'un objet"},{"id":"aimantation-repulsion","name":"Aimantation/Répulsion Magique","description":"Permet sur Volonté d'attirer ou repousser les individus ou objets magiques"},{"id":"stockage-magie","name":"Stockage de Magie","description":"Permet de dépasser le maximum de PF"}]},
          {"id":"croque-mort","name":"Croque-Mort","description":"Spécialiste de l'antimagie et de l'anatomie, le croque-mort est à la fois un expert en neutralisation magique et un connaisseur des corps.","avantages":[{"id":"decharge-magique","name":"Décharge Magique","description":"Si stock de magie, produit une décharge offensive en zone épuisant tous les PF du stock, sinon tous les PF du personnage"},{"id":"coupure-magie","name":"Coupure de la Magie","description":"Rituel, permet de couper un individu de la magie"},{"id":"zone-antimagique","name":"Zone Antimagique","description":"Rituel, permet de mettre une résistance magique à une zone"},{"id":"philosophie","name":"Philosophie","description":"+2 niveaux de dé en Sagesse"},{"id":"analyse-magique","name":"Analyse Magique","description":"Permet de repérer les éléments et types de magie"},{"id":"maitrise-poisons","name":"Maîtrise des Poisons","description":"Expert en poisons et antidotes"},{"id":"connaissances-anatomiques","name":"Connaissances Anatomiques","description":"Dex à répartir attaque et dégâts, cibles humanoïdes"},{"id":"transplantation","name":"Transplantation Miraculeuse","description":"Implants"},{"id":"zone-bienfaisance","name":"Zone de Bienfaisance","description":"Zone autour du personnage, soin de DEX pendant 3 tours, 1×/scénario"},{"id":"glauque","name":"Glauque","description":"Les gens vous laissent passer dans les moments dramatiques, et vous avez +Niveau en Intimidation"}]},
          {"id":"garde","name":"Garde","description":"Combattant discipliné et vigilant, le garde excelle dans la protection et le combat à distance.","avantages":[{"id":"parade-reactive","name":"Parade Réactive","description":"1 défense supplémentaire par tour"},{"id":"botte","name":"Botte","description":"+Niveau attaque, 1 fois par combat"},{"id":"arme-favorite","name":"Arme favorite","description":"+Niveau/2 avec un type d'arme"},{"id":"arme-nommee","name":"Arme nommée","description":"+Niveau/2 avec une arme spécifique"},{"id":"charge","name":"Charge","description":"Renverser/choc"},{"id":"vision-aigle","name":"Vision d'aigle","description":"+Niveau/2 Perception"},{"id":"compagnon-animal","name":"Compagnon animal","description":"Possède un compagnon animal fidèle"},{"id":"tir-precis","name":"Tir précis","description":"Relance dégât"},{"id":"tir-rapide","name":"Tir rapide","description":"Attaque plus souvent"},{"id":"acrobatir","name":"Acrobatir","description":"Bonus pour le gunfight stylé"}]},
          {"id":"fraudeur","name":"Fraudeur","description":"Rôdeur des bas-fonds et expert en survie, le fraudeur connaît tous les chemins secrets et les contacts douteux.","avantages":[{"id":"langage-foret","name":"Langage de la forêt","description":"Permet de connaître la situation globale du milieu, danger, etc."},{"id":"signalisation","name":"Signalisation des Fraudeurs","description":"Connaissance de la signalisation des fraudeurs"},{"id":"pas-loup","name":"Pas de loup","description":"+Niveau/2 discrétion nature"},{"id":"depecage","name":"Dépeçage avancé","description":"Composants plus rares sur les créatures"},{"id":"planques","name":"Connaissance des planques","description":"Connaissance des planques de fraudeur"},{"id":"connais-gars","name":"J'connais un gars","description":"1 contact bas-fonds"},{"id":"par-la","name":"Par là !","description":"+Niveau/2 Fouille"},{"id":"toc-toc","name":"Toc-Toc","description":"Dégâts ×2 par surprise"},{"id":"tracage-piecette","name":"Traçage de la piécette","description":"Permet via bol enchanté de retrouver quelqu'un qui a donné de l'argent"},{"id":"fondu-ombres","name":"Fondu dans les ombres","description":"Permet de faire un fondu, même par temps couvert, ou de devenir invisible dans les ombres"}]},
          {"id":"avanturier","name":"Aventurier","description":"Combattant polyvalent et tacticien, l'aventurier sait s'adapter à toutes les situations et protéger ses alliés.","avantages":[{"id":"interception","name":"Interception","description":"Défend une attaque pour un allié, 1×/combat"},{"id":"coup-assommant","name":"Coup Assommant","description":"Peut assommer un adversaire"},{"id":"briser","name":"Briser","description":"Dégât sur équipement/arme accru"},{"id":"organisation-combat","name":"Organisation du combat","description":"Jet tactique par combat, permet de repositionner"},{"id":"connaissance-armure","name":"Connaissance armure","description":"+Niveau/2 Défense et RD et +Niveau/2 attaque contre armure similaire"},{"id":"demonstration","name":"Démonstration","description":"Manœuvre offensive pour intimider"},{"id":"coup-bas","name":"Coup bas","description":"1 action par combat, +Niveau/2 initiative"},{"id":"repliques-percutantes","name":"Répliques percutantes","description":"Rajouter Baratin à répartir entre attaque et dégâts"},{"id":"provocation-masse","name":"Provocation de masse","description":"Bonne chance"},{"id":"perfection-etincelante","name":"Perfection Étincelante","description":"Peut ajouter sa Force sur des jets sociaux"}]},
          {"id":"gladiateur","name":"Gladiateur","description":"Combattant spectaculaire et artiste de l'arène, le gladiateur allie prouesses martiales et charisme.","avantages":[{"id":"botte-secrete","name":"Botte Secrète","description":"Attaque sans dégâts mais ennemi −Niveau+2 Défense jusqu'à fin du prochain tour"},{"id":"feinte","name":"Feinte","description":"−Niveau/2 attaque, +Niveau/2 dégâts"},{"id":"point-faible","name":"Point faible","description":"−5 attaque, passe armure"},{"id":"ecarter-soie","name":"Écarter la Soie","description":"Dégâts /2 continus mais arme dans l'adversaire, il a −5 pour attaquer et défendre mais +10 pour attaquer le personnage tant que maintenu"},{"id":"frappe-sang-lie","name":"Frappe du Sang-Lié","description":"Sacrifie PF ou PV pour augmenter dégâts d'autant (PV) ou moitié (PF)"},{"id":"rock-star","name":"Rock Star","description":"Groupuscule de fans"},{"id":"voie-ange","name":"Voie d'ange","description":"+Niveau/2 action voix"},{"id":"touche-a-tout","name":"Touche-à-tout","description":"+5 compétences artistiques"},{"id":"instrument-favori","name":"Instrument Favori","description":"+Niveau/2 avec un instrument ou une arme"},{"id":"sharing-soul","name":"Sharing Soul","description":"Partage une émotion, exacerbe un sentiment"}]},
          {"id":"ami-maire","name":"Ami du Maire","description":"Serviteur dévoué d'une entité (maire, dieu, entité métaphysique...), l'ami du maire canalise des pouvoirs de soin et de destruction.","avantages":[{"id":"imposition-mains","name":"Imposition des mains","description":"X PF+PV = 2×X PV soignés"},{"id":"rayon-brulure","name":"Rayon de brûlure","description":"X PV+PF = 2×X dégâts"},{"id":"politicien","name":"Politicien","description":"+Niveau/2 Tactique"},{"id":"devotion","name":"Dévotion","description":"PF dépensés dans 2 compétences impliquant l'idéal de l'entité ×2"},{"id":"sur-entraine","name":"Sur-entraîné","description":"+Niveau/2 Athlétisme"},{"id":"puttin-devil-jail","name":"Puttin' Devil in Jail","description":"Jet sur la compétence préférée de l'entité avec tout le groupe, permet de repousser n'importe quel adversaire sur une réussite"},{"id":"verbe-flatteur","name":"Verbe Flatteur","description":"+Niveau/2 Séduction"},{"id":"conteur-invetere","name":"Conteur Invétéré","description":"Connaissance des mythes"},{"id":"promotion","name":"Promotion","description":"1×/niveau, double les gains monétaires sur une quête"},{"id":"pour-la-mairie","name":"POUR LA MAIRIE !","description":"3×/scénario, +Niveau/2 à un jet allié"}]},
          {"id":"tavernier","name":"Tavernier","description":"Combattant à mains nues redoutable et maître de l'hospitalité, le tavernier sait autant servir une bière que distribuer des coups.","avantages":[{"id":"petit-papa-baston","name":"Petit Papa Baston","description":"+Niveau à répartir entre attaque et dégâts contondants mains nues, 3 PF/round"},{"id":"refus-paiement","name":"Refus de paiement","description":"1×/combat, attaque instantanée"},{"id":"descendre-pinte","name":"Descendre une pinte","description":"1 action, +Niveau/2 aux actions alliées pendant 2 rounds"},{"id":"homme-bourre","name":"Technique de l'Homme Bourré","description":"Actions ninjaesques et techniques chelou"},{"id":"gants-anti-coupure","name":"Gants anti-coupure","description":"Parer à mains nues"},{"id":"degager-importuns","name":"Dégager les Importuns","description":"2 caractéristiques ×2 pendant 5 rounds, puis /2 pendant 5h"},{"id":"artefact","name":"Artefact","description":"Cadeau, souvent artefact, obtenu pendant une aventure trop longue à raconter"},{"id":"cuvee-speciale","name":"Cuvée spéciale","description":"+1D6 de dégâts d'un élément"},{"id":"purification","name":"Purification","description":"Pratique pour le ragoût de la semaine dernière"},{"id":"ardoise","name":"Tu vas la payer ton ardoise ?","description":"Permet de connaître les alignements"}]},
          {"id":"convoyeur","name":"Convoyeur","description":"Ingénieur et cavalier, le convoyeur combine expertise technique et maîtrise équestre pour des missions de transport et de combat.","avantages":[{"id":"alchimie-materiaux","name":"Alchimie des Matériaux","description":"Permet de métamorphoser les matériaux"},{"id":"amelioration-objet","name":"Amélioration d'objet","description":"Peut améliorer un objet"},{"id":"reparapide","name":"Réparapide","description":"Répare plus vite"},{"id":"technomagie","name":"Technomagie","description":"Permet de donner des effets magiques aux inventions"},{"id":"biomachine","name":"Biomachine","description":"Permet de rendre compatible chair et mécanique"},{"id":"lien-telempathique","name":"Lien Télempathique","description":"Communication mentale avec la monture"},{"id":"archerie-montee","name":"Archerie Montée","description":"+Niveau/2 tirs à cheval"},{"id":"charge-cavalerie","name":"Charge de Cavalerie","description":"Charge dévastatrice"},{"id":"esprit-indomptable","name":"Esprit Indomptable","description":"+Niveau/2 Volonté"},{"id":"acrobate-voltigeur","name":"Acrobate Voltigeur","description":"+Niveau/2 actions acrobatiques à cheval"}]},
          {"id":"yandere","name":"Yandere","description":"Manipulateur charismatique aux méthodes parfois brutales, le yandere excelle en social comme au combat.","avantages":[{"id":"gueule-ange","name":"Gueule d'ange","description":"+Niveau/2 social beauté"},{"id":"negoce","name":"Négoce","description":"+Niveau/2 Marchandage"},{"id":"ange-passe","name":"Un Ange Passe","description":"Les foules se taisent naturellement pour laisser parler"},{"id":"voodoo-powa","name":"VooDoo Powa","description":"Empathie vs Idéal permet de faire tomber amoureux le temps d'un ordre"},{"id":"commerage","name":"Commérage","description":"Permet d'avoir quelques infos croustillantes"},{"id":"frappe-sismique","name":"Frappe Sismique","description":"−Niveau/2 de zone, 2 tours"},{"id":"coup-brutal","name":"Coup Brutal","description":"Force vs Force : déséquilibrer, renverser, désarmer"},{"id":"haine-grandissante","name":"Haine Grandissante","description":"+2/tour de combat cumulatif (dégâts, attaque, défense ou initiative au choix)"},{"id":"arme-lourde-main","name":"Arme lourde à une main","description":"Manie armes lourdes à une main"},{"id":"bas-les-pattes","name":"Bas les pattes !","description":"Choisis un PJ chouchou en début de session, +Niveau attaque pour attaquer celui qui tape le chouchou"}]},
          {"id":"enqueteur","name":"Enquêteur","description":"Investigateur charismatique et combattant agile, l'enquêteur résout les mystères et sait se défendre avec élégance.","avantages":[{"id":"enchainement","name":"Enchaînement","description":"Si 5 de différence, attaque supplémentaire"},{"id":"multi-baffe","name":"Multi-baffe","description":"Attaque zone corps à corps"},{"id":"bourre-pif","name":"Bourre-pif","description":"+Niveau/2 dégâts poings"},{"id":"courage-fuyons","name":"Courage fuyons","description":"Désengagement gratuit"},{"id":"meditation","name":"Méditation","description":"1 relance par session"},{"id":"attaque-charismatique","name":"Attaque Charismatique","description":"Ajoute Charisme au score d'attaque"},{"id":"defense-charismatique","name":"Défense Charismatique","description":"Ajoute Charisme à la défense"},{"id":"psychologue","name":"Psychologue","description":"+Niveau/2 Détection de mensonge"},{"id":"polyglotte","name":"Polyglotte","description":"4 langues gratuites"},{"id":"chef-naturel","name":"Chef Naturel","description":"Les PNJ ont tendance à suivre les directives du personnage"}]}
        ],
        "competences": [
          {"id":"acrobatie","name":"Acrobatie","attribut":"DEX"},
          {"id":"athletisme","name":"Athlétisme","attribut":"FOR"},
          {"id":"agriculture","name":"Agriculture","attribut":"INT"},
          {"id":"tir","name":"Tir","attribut":"DEX"},
          {"id":"ingenierie","name":"Ingénierie","attribut":"INT"},
          {"id":"melee","name":"Mêlée","attribut":"FOR"},
          {"id":"artisanat","name":"Artisanat","attribut":"DEX"},
          {"id":"bibliotheque","name":"Bibliothèque","attribut":"INT"},
          {"id":"herboristerie","name":"Herboristerie","attribut":"INT"},
          {"id":"discretion","name":"Discrétion","attribut":"DEX"},
          {"id":"representation","name":"Représentation","attribut":"EMP"},
          {"id":"fouille","name":"Fouille","attribut":"DEX"},
          {"id":"comedie","name":"Comédie","attribut":"EMP"},
          {"id":"equitation","name":"Équitation","attribut":"EMP"},
          {"id":"bagarre","name":"Bagarre","attribut":"DEX"},
          {"id":"crochetage","name":"Crochetage","attribut":"DEX"},
          {"id":"vol","name":"Vol","attribut":"DEX"},
          {"id":"dressage","name":"Dressage","attribut":"EMP"},
          {"id":"droit","name":"Droit","attribut":"INT"},
          {"id":"volonte","name":"Volonté","attribut":"SAG"},
          {"id":"eloquence","name":"Éloquence","attribut":"EMP"},
          {"id":"perception","name":"Perception","attribut":"EMP"},
          {"id":"esquive","name":"Esquive","attribut":"DEX"},
          {"id":"parade","name":"Parade","attribut":"FOR"},
          {"id":"fronde","name":"Fronde","attribut":"DEX"},
          {"id":"etiquette","name":"Étiquette","attribut":"INT"},
          {"id":"linguistique","name":"Linguistique","attribut":"INT"},
          {"id":"orientation","name":"Orientation","attribut":"SAG"},
          {"id":"theologie","name":"Théologie","attribut":"SAG"},
          {"id":"chasse","name":"Chasse","attribut":"EMP"},
          {"id":"piege","name":"Piège","attribut":"DEX"},
          {"id":"psychologie","name":"Psychologie","attribut":"EMP"},
          {"id":"poison","name":"Poison","attribut":"INT"},
          {"id":"medecine","name":"Médecine","attribut":"INT"},
          {"id":"chirurgie","name":"Chirurgie","attribut":"DEX"},
          {"id":"tactique","name":"Tactique","attribut":"SAG"},
          {"id":"survie","name":"Survie","attribut":"DEX"},
          {"id":"zoologie","name":"Zoologie","attribut":"INT"},
          {"id":"magie","name":"Magie","attribut":"—","description":"1 compétence par type de magie"},
          {"id":"perception-magique","name":"Perception Magique","attribut":"EMP"},
          {"id":"intimidation","name":"Intimidation","attribut":"FOR"},
          {"id":"diplomatie","name":"Diplomatie","attribut":"EMP"},
          {"id":"erudition","name":"Érudition","attribut":"INT"},
          {"id":"pilotage","name":"Pilotage","attribut":"DEX"},
          {"id":"informatique","name":"Informatique","attribut":"INT"},
          {"id":"seduction","name":"Séduction","attribut":"EMP"},
          {"id":"deguisement","name":"Déguisement","attribut":"DEX"},
          {"id":"baratin","name":"Baratin","attribut":"EMP"},
          {"id":"resistance","name":"Résistance","attribut":"FOR"}
        ],
        "avantagesGeneraux": [
          {"id":"connaissance-magie","name":"Connaissance d'une magie","description":"Le personnage a la capacité d'utiliser l'une des nombreuses formes de magie disponibles sur Gaïa."},
          {"id":"ambidextrie","name":"Ambidextrie","description":"Le personnage dispose de deux actions par tour de combat."},
          {"id":"action-combinee","name":"Action combinée","description":"Prérequis : pouvoir faire deux actions par tour. Permet au personnage de faire une seule action au lieu de deux, mais augmentée de 50 % (100 % si en full attaque)."},
          {"id":"action-supplementaire-specifique","name":"Action supplémentaire spécifique","description":"Permet d'avoir une action gratuite dont la nature doit être spécifiée à la prise de l'avantage. Peut se cumuler avec Ambidextrie. Sauf conditions particulières, cette action gratuite ne peut pas être une action d'attaque."},
          {"id":"infatigable","name":"Infatigable","description":"Réduit la quantité de repos dont le personnage a besoin."},
          {"id":"hyperactif","name":"Hyperactif","description":"Prérequis : Infatigable. Le personnage dispose de trois actions au lieu de deux entre deux séances."},
          {"id":"eleve-doue","name":"Élève doué","description":"Réduit l'entraînement d'une compétence à 3 actions au lieu de 4."},
          {"id":"superiorite-martiale","name":"Supériorité martiale","description":"Permet de rajouter la moitié de la différence entre son attaque et la défense de l'adversaire aux dégâts."},
          {"id":"suprematie-martiale","name":"Suprématie martiale","description":"Prérequis : Supériorité martiale. Permet de rajouter la différence totale entre l'attaque et la défense au lieu de la moitié."},
          {"id":"avantage-autre-classe","name":"Avantage d'une autre classe","description":"Coûte l'équivalent de deux avantages (6 points de création). Permet de choisir un avantage appartenant à une classe différente de la sienne."},
          {"id":"style-particulier","name":"Style particulier","description":"Remplace une caractéristique par une autre dans une compétence spécifique ou les jets de dégâts."},
          {"id":"expertise-competence","name":"Expertise de compétence","description":"Ajoute les rangs d'une compétence définie aux jets d'une autre compétence définie."},
          {"id":"accompagner-coups","name":"Accompagner les coups","description":"Ajoute la Dextérité à la RD, uniquement si une tentative d'esquive ou de parade a pu être faite."},
          {"id":"developper-technique-sort","name":"Développer une technique ou un sort","description":"Généralement moins coûteux ou plus puissant qu'une action improvisée. Permet de créer une technique ou un sort personnalisé."},
          {"id":"regroupement-competences","name":"Regroupement de compétences","description":"Un avantage (3 points) par compétence regroupée, si celles-ci utilisent la même caractéristique. Permet de lier plusieurs compétences entre elles."}
        ],
        "levelUps": [
          {"level":2,"options":[{"id":"pv","name":"+2 PV max","effect":{"type":"pv","value":2}},{"id":"pf","name":"+2 PF max","effect":{"type":"pf","value":2}},{"id":"comp","name":"+2 points de compétence","effect":{"type":"competence","value":2}},{"id":"carac","name":"+1 caractéristique","effect":{"type":"caracteristique","value":1}}]},
          {"level":3,"options":[{"id":"pv","name":"+2 PV max","effect":{"type":"pv","value":2}},{"id":"pf","name":"+2 PF max","effect":{"type":"pf","value":2}},{"id":"comp","name":"+2 points de compétence","effect":{"type":"competence","value":2}},{"id":"carac","name":"+1 caractéristique","effect":{"type":"caracteristique","value":1}},{"id":"avantage","name":"Nouvel avantage de classe","effect":{"type":"avantage","value":1}}]},
          {"level":4,"options":[{"id":"pv","name":"+3 PV max","effect":{"type":"pv","value":3}},{"id":"pf","name":"+3 PF max","effect":{"type":"pf","value":3}},{"id":"comp","name":"+3 points de compétence","effect":{"type":"competence","value":3}},{"id":"carac","name":"+1 caractéristique","effect":{"type":"caracteristique","value":1}}]},
          {"level":5,"options":[{"id":"pv","name":"+3 PV max","effect":{"type":"pv","value":3}},{"id":"pf","name":"+3 PF max","effect":{"type":"pf","value":3}},{"id":"comp","name":"+3 points de compétence","effect":{"type":"competence","value":3}},{"id":"carac","name":"+2 caractéristiques","effect":{"type":"caracteristique","value":2}},{"id":"avantage","name":"Nouvel avantage de classe","effect":{"type":"avantage","value":1}}]}
        ]
      };
      
      let currentStep = 1;
      const totalSteps = 8;
      
      // État de création
      const creationState = {
        race: null,
        dryadeChosenAttr: null, // Caractéristique choisie par la Dryade pour l'arbre-cœur
        // Nouveau système de dés : chaque carac a un dé attribué (D4=4, D6=6, D8=8, D10=10, D12=12)
        attributes: { force: null, dex: null, emp: null, sag: null, int: null },
        // Bonus de caractéristiques (provenant de la race, etc.)
        attributeBonuses: { force: 0, dex: 0, emp: 0, sag: 0, int: 0 },
        // Dés disponibles (non encore attribués)
        availableDice: [4, 6, 8, 10, 12],
        classe: null,
        primaryAdvantage: null,
        competences: {},
        compPointsUsed: 0,
        secondaryAdvantages: [],
        customAdvantages: [], // Avantages personnalisés créés par le joueur
        name: '',
        alignment: '',
        // Level Up system
        levelUpCount: 0,
        levelUpPointsTotal: 0,
        levelUpPointsSpent: 0,
        levelUpChoices: [], // Array of { type, cost, details }
        levelUpCurrentSelection: null // Type d'amélioration en cours de sélection
      };
      
      // Mapping des bonus de caractéristiques par race
      const raceBonuses = {
        'cryx': { sag: 2 },
        'troll': { force: 2, dex: 2, sag: -2, int: -2 },
        'ogre': { int: 2 },
        'canitaure': { emp: 1, dex: 1 },
        'gravel': { force: 2, dex: -1 },
        'centaure': { force: 1 }
        // Note: Dryade a +1 carac au choix (arbre-cœur) - à gérer séparément si besoin
        // Note: Vermelune a un bonus aléatoire par séance - à gérer séparément si besoin
      };
      
      // Applique les bonus de race aux caractéristiques
      function applyRaceBonuses() {
        // Reset des bonus
        creationState.attributeBonuses = { force: 0, dex: 0, emp: 0, sag: 0, int: 0 };
        
        if (creationState.race && raceBonuses[creationState.race.id]) {
          const bonuses = raceBonuses[creationState.race.id];
          for (const [attr, value] of Object.entries(bonuses)) {
            creationState.attributeBonuses[attr] = value;
          }
        }
        
        // Ajouter le bonus de Dryade si applicable
        if (creationState.race && creationState.race.id === 'dryade' && creationState.dryadeChosenAttr) {
          creationState.attributeBonuses[creationState.dryadeChosenAttr] = 
            (creationState.attributeBonuses[creationState.dryadeChosenAttr] || 0) + 1;
        }
      }
      
      // Calcule la valeur finale d'une caractéristique (dé + bonus)
      function getFinalAttribute(attr) {
        const baseValue = parseInt(creationState.attributes[attr]) || 0;
        const raceBonus = creationState.attributeBonuses[attr] || 0;
        
        // Compter les augmentations de Level Up pour cette caractéristique
        const levelUpBonus = creationState.levelUpChoices
          .filter(c => c.type === 'caracteristique' && c.details && (c.details.attrKey === attr || c.details.attr === attr))
          .length;
        
        // Bonus total = race + level ups (chaque level up = +1 niveau de dé)
        const totalBonus = raceBonus + levelUpBonus;
        
        if (baseValue === 0) return { value: 0, die: null, bonus: 0, display: '-' };
        
        // Chaque +1 augmente le dé d'un cran (D4->D6->D8->D10->D12)
        // Au-delà de D12, on reste à D12 avec un bonus
        const diceProgression = [4, 6, 8, 10, 12];
        let currentIndex = diceProgression.indexOf(baseValue);
        
        // Si la valeur n'est pas trouvée, trouver l'index le plus proche
        if (currentIndex === -1) {
          currentIndex = diceProgression.findIndex(d => d >= baseValue);
          if (currentIndex === -1) currentIndex = diceProgression.length - 1;
        }
        
        let extraBonus = 0;
        
        if (totalBonus > 0) {
          // Bonus positif : monter les dés
          for (let i = 0; i < totalBonus; i++) {
            if (currentIndex < diceProgression.length - 1) {
              currentIndex++;
            } else {
              // Déjà au D12, ajouter un bonus
              extraBonus++;
            }
          }
        } else if (totalBonus < 0) {
          // Malus : descendre les dés
          for (let i = 0; i < Math.abs(totalBonus); i++) {
            if (currentIndex > 0) {
              currentIndex--;
            }
            // En dessous de D4, reste à D4
          }
        }
        
        const finalDie = diceProgression[currentIndex];
        const display = extraBonus > 0 ? `D${finalDie} +${extraBonus}` : `D${finalDie}`;
        
        return { value: finalDie, die: finalDie, bonus: extraBonus, display, baseValue, raceBonus: raceBonus, levelUpBonus: levelUpBonus };
      }
      
      const attrNames = {
        force: 'Force',
        dex: 'Dextérité',
        emp: 'Empathie',
        sag: 'Sagesse',
        int: 'Intelligence'
      };
      
      // Mode actuel de la page (accessible globalement)
      let currentMode = 'menu'; // 'menu', 'wizard', 'consult', 'free'
      
      // Initialiser le wizard
      function initWizard() {
        
        // Fonction pour réinitialiser au menu principal
        function backToMainMenu() {
          currentMode = 'menu';
          document.getElementById('wizard-container').style.display = 'block';
          document.getElementById('wizard-intro').style.display = 'block';
          document.getElementById('wizard-steps').classList.remove('active');
          document.getElementById('wizard-separator').style.display = 'none';
          document.getElementById('reference-panel').style.display = 'none';
          document.getElementById('free-mode-buttons').style.display = 'none';
          document.getElementById('btn-back-from-ref').style.display = 'none';
          document.getElementById('character-sheet').style.display = 'none';
          window.scrollTo({ top: 0, behavior: 'smooth' });
        }
        
        // Bouton 1: Démarrer la création de Personnage
        document.getElementById('btn-start-wizard').addEventListener('click', () => {
          currentMode = 'wizard';
          document.getElementById('wizard-intro').style.display = 'none';
          document.getElementById('wizard-steps').classList.add('active');
          document.getElementById('character-sheet').style.display = 'block';
          document.getElementById('free-mode-buttons').style.display = 'none';
          document.getElementById('btn-back-from-ref').style.display = 'none';
          renderStep(1);
          // Auto-resize textareas after sheet becomes visible
          setTimeout(() => autoResizeTextareas(), 50);
        });
        
        // Bouton 2: Consulter les références (Races/Classes/etc.)
        document.getElementById('btn-consult-ref').addEventListener('click', () => {
          currentMode = 'consult';
          document.getElementById('wizard-container').style.display = 'none';
          document.getElementById('wizard-separator').style.display = 'none';
          document.getElementById('reference-panel').style.display = 'block';
          document.getElementById('btn-back-from-ref').style.display = 'block';
          document.getElementById('free-mode-buttons').style.display = 'none';
          document.getElementById('character-sheet').style.display = 'none';
          // Cliquer sur le premier bouton par défaut
          document.querySelector('.reference-btn[data-ref="races"]').click();
        });
        
        // Bouton 3: Remplir la fiche librement
        document.getElementById('btn-fill-free').addEventListener('click', () => {
          currentMode = 'free';
          document.getElementById('wizard-container').style.display = 'none';
          document.getElementById('wizard-separator').style.display = 'none';
          document.getElementById('reference-panel').style.display = 'block';
          document.getElementById('btn-back-from-ref').style.display = 'none';
          document.getElementById('free-mode-buttons').style.display = 'block';
          document.getElementById('character-sheet').style.display = 'block';
          // Auto-resize textareas after sheet becomes visible
          setTimeout(() => autoResizeTextareas(), 50);
        });
        
        // Bouton 4: Importer JSON
        document.getElementById('btn-import-json').addEventListener('click', () => {
          document.getElementById('import-json-input').click();
        });
        
        document.getElementById('import-json-input').addEventListener('change', (e) => {
          const file = e.target.files[0];
          if (!file) return;
          
          const reader = new FileReader();
          reader.onload = (event) => {
            try {
              const data = JSON.parse(event.target.result);
              
              // Passer en mode libre
              currentMode = 'free';
              document.getElementById('wizard-container').style.display = 'none';
              document.getElementById('wizard-separator').style.display = 'none';
              document.getElementById('reference-panel').style.display = 'block';
              document.getElementById('btn-back-from-ref').style.display = 'none';
              document.getElementById('free-mode-buttons').style.display = 'block';
              document.getElementById('character-sheet').style.display = 'block';
              
              // Restaurer les données
              restoreSheetData(data);
              
              // Auto-resize textareas after sheet becomes visible
              setTimeout(() => autoResizeTextareas(), 100);
              
              alert('Profil chargé avec succès !');
            } catch (err) {
              alert('Erreur lors du chargement du fichier : ' + err.message);
            }
          };
          reader.readAsText(file);
          e.target.value = ''; // Reset input
        });
        
        // Bouton retour depuis consultation
        document.getElementById('btn-back-from-ref').addEventListener('click', backToMainMenu);
        
        // Bouton retour depuis mode libre
        document.getElementById('btn-back-from-free').addEventListener('click', backToMainMenu);
        
        // Bouton Level Up depuis mode libre
        document.getElementById('btn-levelup-free').addEventListener('click', () => {
          // Vérifier que la fiche est complétée
          const name = document.getElementById('name').value.trim();
          const level = document.getElementById('level').value.trim();
          const race = document.getElementById('race').value.trim();
          const classe = document.getElementById('class').value.trim();
          
          if (!name || !level || !race || !classe) {
            alert('⚠️ Veuillez compléter la fiche avant de passer au Level Up.\n\nChamps requis :\n- Nom du Personnage\n- Niveau\n- Race\n- Classe');
            return;
          }
          
          // Rester en mode libre pour le retour
          currentMode = 'free';
          document.getElementById('wizard-container').style.display = 'block';
          document.getElementById('wizard-intro').style.display = 'none';
          document.getElementById('wizard-steps').classList.add('active');
          document.getElementById('free-mode-buttons').style.display = 'none';
          
          // Modifier le texte du bouton Précédent pour le mode libre
          const prevBtn8 = document.getElementById('btn-prev-8');
          if (prevBtn8) prevBtn8.textContent = '← Annuler';
          
          // Réinitialiser le Level Up state pour une nouvelle session
          creationState.levelUpCount = 1; // Commencer avec 1 Level Up par défaut
          creationState.levelUpPointsTotal = 10;
          creationState.levelUpPointsSpent = 0;
          creationState.levelUpChoices = [];
          creationState.levelUpCurrentSelection = null;
          creationState.existingBonuses = {};
          
          // Charger les données de la fiche dans creationState
          loadSheetIntoCreationState();
          
          // Mettre à jour l'input de compteur
          const countInput = document.getElementById('levelup-count');
          if (countInput) countInput.value = 1;
          
          // Afficher uniquement l'étape Level Up
          goToStep(8);
        });
        
        // Fonction pour charger les données de la fiche dans creationState (pour le Level Up)
        function loadSheetIntoCreationState() {
          const raceName = document.getElementById('race').value.trim();
          const className = document.getElementById('class').value.trim();
          
          // Trouver la race et la classe correspondantes
          const race = characterData.races.find(r => r.name === raceName);
          const cls = characterData.classes.find(c => c.name === className);
          
          if (race) creationState.race = race;
          if (cls) creationState.classe = cls;
          
          // Mapping des IDs de la fiche vers les clés du creationState
          const attrMapping = {
            'force': 'for',
            'dex': 'dex',
            'emp': 'emp',
            'sag': 'sag',
            'int': 'int'
          };
          
          // Charger les caractéristiques depuis la fiche (avec bonus)
          Object.entries(attrMapping).forEach(([sheetId, stateKey]) => {
            const input = document.getElementById(sheetId);
            if (input) {
              const dieValue = parseInt(input.value) || 6;
              creationState.attributes[stateKey] = dieValue;
              
              // Charger aussi le bonus
              const box = input.closest('.attr-box');
              const bonusInput = box?.querySelector('input[type="text"]');
              const bonusValue = parseInt(bonusInput?.value?.replace(/[^0-9-]/g, '')) || 0;
              
              // Stocker le bonus dans levelUpChoices si > 0
              if (bonusValue > 0) {
                // Trouver si on a déjà un choice pour cette caractéristique
                const existingChoice = creationState.levelUpChoices.find(
                  c => c.type === 'caracteristique' && c.details?.attrKey === stateKey
                );
                if (!existingChoice) {
                  // Ajouter un pseudo-choice pour représenter les bonus existants
                  creationState.existingBonuses = creationState.existingBonuses || {};
                  creationState.existingBonuses[stateKey] = bonusValue;
                }
              }
            }
          });
          
          // Charger le niveau actuel
          creationState.currentLevel = parseInt(document.getElementById('level').value) || 1;
        };
        
        // Navigation
        for (let i = 1; i <= totalSteps; i++) {
          const prevBtn = document.getElementById(`btn-prev-${i}`);
          const nextBtn = document.getElementById(`btn-next-${i}`);
          if (prevBtn) {
            if (i === 8) {
              // Gestion spéciale pour le bouton Précédent à l'étape Level Up
              prevBtn.addEventListener('click', () => {
                // Si on vient du mode libre, retourner au mode libre
                if (currentMode === 'free') {
                  document.getElementById('wizard-container').style.display = 'none';
                  document.getElementById('wizard-separator').style.display = 'none';
                  document.getElementById('reference-panel').style.display = 'block';
                  document.getElementById('btn-back-from-ref').style.display = 'none';
                  document.getElementById('free-mode-buttons').style.display = 'block';
                  return;
                }
                goToStep(i - 1);
              });
            } else {
              prevBtn.addEventListener('click', () => goToStep(i - 1));
            }
          }
          if (nextBtn) nextBtn.addEventListener('click', () => goToStep(i + 1));
        }
        
        // Bouton confirmer
        document.getElementById('btn-confirm').addEventListener('click', generateCharacterSheet);
        
        // Progress bar click
        document.querySelectorAll('.progress-step').forEach(step => {
          step.addEventListener('click', () => {
            const stepNum = parseInt(step.dataset.step);
            if (canNavigateToStep(stepNum)) {
              goToStep(stepNum);
            }
          });
        });
      }
      
      function canNavigateToStep(step) {
        // Peut naviguer vers les étapes précédentes ou complétées
        // Si on est à l'étape 9 (terminée), on peut aller à n'importe quelle étape 1-8
        if (currentStep === 9 && step >= 1 && step <= 8) return true;
        return step <= currentStep;
      }
      
      function goToStep(step) {
        // Permettre la navigation vers les étapes 1-8 (même depuis l'étape 9)
        if (step < 1 || step > 8) return;
        
        const previousStep = currentStep;
        
        // Si on revient de l'étape 9 (terminée), cacher le message et réinitialiser le séparateur
        if (previousStep === 9) {
          const separator = document.getElementById('wizard-separator');
          separator.innerHTML = '<h3 style="text-align: center; color: #666;">↓ Votre fiche de personnage ↓</h3>';
          // Cacher l'étape 9 dans la barre de progression
          const step9 = document.querySelector('.progress-step[data-step="9"]');
          if (step9) step9.style.display = 'none';
        }
        
        // Appliquer les changements de l'étape précédente à la fiche (quand on avance)
        if (step > previousStep && previousStep !== 9) {
          applyStepToSheet(previousStep);
        }
        
        // Cacher l'étape actuelle (seulement si ce n'est pas l'étape 9 qui n'a pas de contenu)
        if (previousStep !== 9) {
          const prevStepContent = document.querySelector(`.step-content[data-step="${previousStep}"]`);
          if (prevStepContent) prevStepContent.classList.remove('active');
        }
        
        // Afficher la nouvelle étape
        currentStep = step;
        const newStepContent = document.querySelector(`.step-content[data-step="${currentStep}"]`);
        if (newStepContent) newStepContent.classList.add('active');
        
        // Mettre à jour la progress bar
        updateProgressBar();
        
        // Rendre le contenu de l'étape
        renderStep(step);
        
        // Afficher le séparateur, le panneau de référence et la fiche quand on avance
        if (step > 1) {
          document.getElementById('wizard-separator').style.display = 'block';
          document.getElementById('reference-panel').style.display = 'block';
          document.getElementById('character-sheet').style.display = 'block';
        }
        
        // Scroll vers le haut du wizard pour voir la nouvelle étape (après un court délai pour le DOM)
        setTimeout(() => {
          const wizardContainer = document.getElementById('wizard-container');
          if (wizardContainer) {
            wizardContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
          }
          // Auto-resize textareas after sheet becomes visible
          autoResizeTextareas();
        }, 100);
      }
      
      // Appliquer les changements d'une étape à la fiche
      function applyStepToSheet(step) {
        switch (step) {
          case 1: 
            updateSheetRace(); 
            break;
          case 2: 
            updateSheetAttributes(); 
            break;
          case 3: 
            updateSheetClass(); 
            break;
          case 4: 
            updateSheetCapacities(); 
            break;
          case 5: 
            updateSheetCompetences(); 
            break;
          case 6: 
            updateSheetCapacities(); 
            break;
          case 7: 
            updateSheetNameAndStats(); 
            break;
        }
      }
      
      function updateProgressBar() {
        document.querySelectorAll('.progress-step').forEach(step => {
          const stepNum = parseInt(step.dataset.step);
          step.classList.remove('active', 'completed');
          if (stepNum === currentStep) {
            step.classList.add('active');
          } else if (stepNum < currentStep) {
            step.classList.add('completed');
          }
        });
      }
      
      function renderStep(step) {
        switch (step) {
          case 1: renderRaceOptions(); break;
          case 2: applyRaceBonuses(); renderAttributeDistribution(); break;
          case 3: renderClassOptions(); break;
          case 4: renderPrimaryAdvantageOptions(); break;
          case 5: renderCompetenceDistribution(); break;
          case 6: renderSecondaryAdvantageOptions(); break;
          case 7: renderNameAndStats(); break;
          case 8: renderLevelUpOptions(); break;
        }
      }
      
      // ========== FONCTIONS DE MISE À JOUR DE LA FICHE ==========
      
      // Mettre à jour la case Race et les bonus de race
      function updateSheetRace() {
        if (!creationState.race) return;
        
        // Case Race
        const raceField = document.getElementById('race');
        if (raceField) raceField.value = creationState.race.name;
        
        // Fonction pour formater un bonus/malus avec le nom en gras
        function formatTrait(trait) {
          const colonIndex = trait.indexOf(':');
          if (colonIndex > 0) {
            const name = trait.substring(0, colonIndex).trim();
            const desc = trait.substring(colonIndex + 1).trim();
            return `<li><strong>${name}</strong> : ${desc}</li>`;
          }
          return `<li>${trait}</li>`;
        }
        
        // Bonus de race
        const sections = document.querySelectorAll('.section, .half-section');
        sections.forEach(section => {
          const h3 = section.querySelector('h3');
          if (h3 && h3.textContent.includes('Bonus de race')) {
            const list = section.querySelector('.abilities-list');
            if (list) {
              const allTraits = [];
              if (creationState.race.bonuses) {
                creationState.race.bonuses.forEach(b => allTraits.push(formatTrait(b)));
              }
              if (creationState.race.maluses && creationState.race.maluses.length > 0) {
                creationState.race.maluses.forEach(m => allTraits.push(formatTrait(m)));
              }
              list.innerHTML = allTraits.join('');
            }
          }
        });
      }
      
      // Mettre à jour les caractéristiques
      function updateSheetAttributes() {
        const attrMap = { force: 'force', dex: 'dex', emp: 'emp', sag: 'sag', int: 'int' };
        for (const [key, id] of Object.entries(attrMap)) {
          const input = document.getElementById(id);
          if (input) {
            const finalAttr = getFinalAttribute(key);
            
            // Mettre la valeur du dé final dans l'input number
            if (finalAttr.value > 0) {
              input.value = finalAttr.value;
            } else {
              input.value = '';
            }
            input.dispatchEvent(new Event('input')); // Déclenche la mise à jour du dé affiché
            
            // Mettre le bonus dans le petit champ +0 (le 3ème élément dans value-wrap)
            const attrBox = input.closest('.attr-box');
            if (attrBox) {
              const bonusInput = attrBox.querySelector('input[type="text"]');
              if (bonusInput && finalAttr.bonus > 0) {
                bonusInput.value = `+${finalAttr.bonus}`;
              } else if (bonusInput) {
                bonusInput.value = '+0';
              }
            }
          }
        }
      }
      
      // Mettre à jour la case Classe
      function updateSheetClass() {
        if (!creationState.classe) return;
        const classField = document.getElementById('class');
        if (classField) classField.value = creationState.classe.name;
      }
      
      // Mettre à jour les avantages/capacités
      function updateSheetCapacities() {
        const sections = document.querySelectorAll('.section');
        sections.forEach(section => {
          const h3 = section.querySelector('h3');
          if (h3 && (h3.textContent.includes('Capacités') || h3.textContent.includes('Avantages'))) {
            const list = section.querySelector('.abilities-list');
            if (list) {
              const capacities = [];
              
              // Avantage primaire (de classe)
              if (creationState.primaryAdvantage) {
                capacities.push(`<li><strong>${creationState.primaryAdvantage.name}</strong> : ${creationState.primaryAdvantage.description}</li>`);
              }
              
              // Avantages secondaires (classe + généraux)
              creationState.secondaryAdvantages.forEach(adv => {
                const marker = adv.isGeneral ? ' ◆' : '';
                capacities.push(`<li><strong>${adv.name}${marker}</strong> : ${adv.description}</li>`);
              });
              
              // Avantages personnalisés
              creationState.customAdvantages.forEach(adv => {
                if (adv.name && adv.name.trim() !== '') {
                  capacities.push(`<li><strong>${adv.name} ✦</strong> : ${adv.description || 'Pas de description'}</li>`);
                }
              });
              
              if (capacities.length > 0) {
                list.innerHTML = capacities.join('');
              }
            }
          }
        });
      }
      
      // Mettre à jour les compétences
      function updateSheetCompetences() {
        const skillsBody = document.querySelector('.skill-table tbody');
        if (!skillsBody) {
          console.error('Tableau des compétences non trouvé');
          return;
        }
        
        // Collecter toutes les compétences (étape 5 + level ups + bonus de race)
        const allComps = {};
        
        // Compétences de l'étape 5
        for (const [compId, value] of Object.entries(creationState.competences)) {
          if (value && value > 0) {
            allComps[compId] = (allComps[compId] || 0) + value;
          }
        }
        
        // Ajouter les compétences des Level Ups
        creationState.levelUpChoices
          .filter(c => c.type === 'competence' && c.details && c.details.compId)
          .forEach(choice => {
            allComps[choice.details.compId] = (allComps[choice.details.compId] || 0) + 1;
          });
        
        // Ajouter les bonus de compétences de la race
        if (creationState.race && raceCompBonuses[creationState.race.id]) {
          const raceBonuses = raceCompBonuses[creationState.race.id];
          for (const [compId, value] of Object.entries(raceBonuses)) {
            allComps[compId] = (allComps[compId] || 0) + value;
          }
        }
        
        // Construire la liste des compétences avec leurs infos
        const usedComps = [];
        for (const [compId, value] of Object.entries(allComps)) {
          const comp = characterData.competences.find(c => c.id === compId);
          if (comp) {
            usedComps.push({ comp, value });
          }
        }
        
        // Trier par nom
        usedComps.sort((a, b) => a.comp.name.localeCompare(b.comp.name));
        
        // Toujours vider et reconstruire le tableau
        skillsBody.innerHTML = '';
        
        if (usedComps.length > 0) {
          usedComps.forEach(({ comp, value }) => {
            const row = document.createElement('tr');
            row.innerHTML = `
              <td><input value="${comp.name}" /></td>
              <td><input value="${comp.attribut}" /></td>
              <td><input type="text" value="+${value}" style="text-align:center;" /></td>
            `;
            skillsBody.appendChild(row);
          });
        } else {
          // Ajouter des lignes vides par défaut si aucune compétence
          for (let i = 0; i < 6; i++) {
            const row = document.createElement('tr');
            row.innerHTML = `
              <td><input /></td>
              <td><input placeholder="FOR" /></td>
              <td><input type="number" placeholder="+0" /></td>
            `;
            skillsBody.appendChild(row);
          }
        }
      }
      
      // Calculer les PV (FOR×2 + INT×2 + 10 + Niveau + Bonus)
      function calculatePV() {
        const niveau = 1 + (creationState.levelUpCount || 0); // Niveau de base + level ups
        let bonusPV = 0;
        
        // Utiliser getFinalAttribute pour obtenir les valeurs finales incluant tous les bonus
        const forceAttr = getFinalAttribute('force');
        const intelAttr = getFinalAttribute('int');
        
        // Valeur de la caractéristique = valeur du dé + bonus au-delà de D12
        // Pour le calcul des PV, on utilise la valeur du dé + le bonus extra
        const forceValue = (forceAttr.value || 0) + (forceAttr.bonus || 0);
        const intelValue = (intelAttr.value || 0) + (intelAttr.bonus || 0);
        
        // TODO: Ajouter les bonus de race ou d'avantage qui augmentent les PV
        
        const pv = (forceValue * 2) + (intelValue * 2) + 10 + niveau + bonusPV;
        return { pv, force: forceValue, intel: intelValue, niveau, bonusPV, forceBonus: forceAttr.bonus, intelBonus: intelAttr.bonus };
      }
      
      // Calculer les PF (PF = PV + Bonus)
      function calculatePF(pv) {
        let bonusPF = 0;
        
        // TODO: Ajouter les bonus de race ou d'avantage qui augmentent les PF
        
        return { pf: pv + bonusPF, bonusPF };
      }
      
      // Mettre à jour le nom et les stats vitales
      function updateSheetNameAndStats() {
        const nameInput = document.getElementById('wizard-name');
        const alignmentSelect = document.getElementById('wizard-alignment');
        const nameField = document.getElementById('name');
        const alignmentField = document.getElementById('alignement');
        const levelField = document.getElementById('level');
        const pvMaxField = document.getElementById('pv-max');
        const pvCurrentField = document.getElementById('pv-current');
        const pfMaxField = document.getElementById('pf-max');
        const pfCurrentField = document.getElementById('pf-current');
        
        if (nameInput && nameField) {
          nameField.value = nameInput.value;
        }
        
        if (alignmentSelect && alignmentField) {
          alignmentField.value = alignmentSelect.value;
        } else if (creationState.alignment && alignmentField) {
          alignmentField.value = creationState.alignment;
        }
        
        if (levelField) {
          levelField.value = 1;
        }
        
        const { pv } = calculatePV();
        const { pf } = calculatePF(pv);
        
        if (pvMaxField) pvMaxField.value = pv;
        if (pvCurrentField) pvCurrentField.value = pv;
        if (pfMaxField) pfMaxField.value = pf;
        if (pfCurrentField) pfCurrentField.value = pf;
      }
      
      // Étape 1: Races
      // Chemins des images
      function getRaceImagePath(raceId) {
        // Centaure utilise .jpg, les autres .png
        const ext = raceId === 'centaure' ? 'jpg' : 'png';
        return `img/races/${raceId}.${ext}`;
      }
      
      function getClassImagePath(classId) {
        return `img/classes/${classId}.png`;
      }
      
      function renderRaceOptions() {
        const container = document.getElementById('race-options');
        container.innerHTML = '';
        
        // Fonction pour formater un bonus/malus avec le nom en gras
        function formatTrait(trait) {
          const colonIndex = trait.indexOf(':');
          if (colonIndex > 0) {
            const name = trait.substring(0, colonIndex).trim();
            const desc = trait.substring(colonIndex + 1).trim();
            return `<li><strong>${name}</strong> : ${desc}</li>`;
          }
          return `<li>${trait}</li>`;
        }
        
        characterData.races.forEach(race => {
          const card = document.createElement('div');
          card.className = 'option-card' + (creationState.race?.id === race.id ? ' selected' : '');
          
          // Générer la liste des bonus
          const bonusesHtml = race.bonuses && race.bonuses.length > 0 
            ? `<ul class="option-bonuses">${race.bonuses.map(b => formatTrait(b)).join('')}</ul>` 
            : '';
          
          // Générer la liste des malus
          const malusesHtml = race.maluses && race.maluses.length > 0 
            ? `<ul class="option-maluses">${race.maluses.map(m => formatTrait(m)).join('')}</ul>` 
            : '';
          
          // Indicateur du choix Dryade
          const attrNames = { force: 'Force', dex: 'Dextérité', emp: 'Charisme', sag: 'Sagesse', int: 'Intelligence' };
          const dryadeChoiceHtml = race.id === 'dryade' && creationState.race?.id === 'dryade' && creationState.dryadeChosenAttr
            ? `<div style="background:#27ae60;color:#fff;padding:0.25rem 0.5rem;border-radius:0.25rem;margin-top:0.5rem;font-size:0.85rem;">🌳 Arbre-cœur : +1 ${attrNames[creationState.dryadeChosenAttr]}</div>`
            : '';
          
          card.innerHTML = `
            <img src="${getRaceImagePath(race.id)}" alt="${race.name}" class="option-img" onerror="this.style.display='none'">
            <div class="option-content">
              <div class="option-name">${race.name}</div>
              <div class="option-desc">${race.description}</div>
              ${bonusesHtml}
              ${malusesHtml}
              ${dryadeChoiceHtml}
            </div>
          `;
          card.addEventListener('click', () => {
            // Si c'est une Dryade, afficher le popup pour choisir la caractéristique
            if (race.id === 'dryade') {
              showDryadeAttrPopup((chosenAttr) => {
                if (chosenAttr) {
                  creationState.race = race;
                  creationState.dryadeChosenAttr = chosenAttr;
                  applyRaceBonuses();
                  renderRaceOptions();
                  document.getElementById('btn-next-1').disabled = false;
                }
              });
            } else {
              creationState.race = race;
              creationState.dryadeChosenAttr = null;
              applyRaceBonuses();
              renderRaceOptions();
              document.getElementById('btn-next-1').disabled = false;
            }
          });
          container.appendChild(card);
        });
      }
      
      // Étape 2: Caractéristiques
      // Système de dés pour les caractéristiques
      let selectedDice = null; // Dé actuellement sélectionné
      
      function renderAttributeDistribution() {
        const dicePool = document.getElementById('dice-pool');
        const container = document.getElementById('attr-distribute');
        
        const attrs = ['force', 'dex', 'emp', 'sag', 'int'];
        const allDice = [4, 6, 8, 10, 12];
        
        // Calculer les dés utilisés
        const usedDice = Object.values(creationState.attributes).filter(d => d !== null);
        const availableDice = allDice.filter(d => !usedDice.includes(d));
        
        // Afficher le pool de dés
        dicePool.innerHTML = '<div class="dice-instructions">🎲 Cliquez sur un dé, puis sur une caractéristique pour l\'assigner</div>';
        
        const diceContainer = document.createElement('div');
        diceContainer.style.cssText = 'display:flex; justify-content:center; gap:0.75rem; flex-wrap:wrap; margin-top:0.5rem;';
        
        allDice.forEach(dice => {
          const isUsed = usedDice.includes(dice);
          const isSelected = selectedDice === dice;
          
          const diceEl = document.createElement('div');
          diceEl.className = 'dice-item' + (isUsed ? ' used' : '') + (isSelected ? ' selected' : '');
          diceEl.innerHTML = `D${dice}`;
          diceEl.title = isUsed ? 'Ce dé est déjà assigné' : `Cliquez pour sélectionner le D${dice}`;
          
          if (!isUsed) {
            diceEl.addEventListener('click', () => {
              selectedDice = isSelected ? null : dice;
              renderAttributeDistribution();
            });
          }
          
          diceContainer.appendChild(diceEl);
        });
        
        dicePool.appendChild(diceContainer);
        
        // Afficher les caractéristiques
        container.innerHTML = '';
        
        attrs.forEach(attr => {
          const value = creationState.attributes[attr];
          const hasDice = value !== null;
          const raceBonus = creationState.attributeBonuses[attr] || 0;
          const finalAttr = getFinalAttribute(attr);
          
          const item = document.createElement('div');
          item.className = 'attr-item' + (hasDice ? ' has-dice' : '') + (selectedDice && !hasDice ? ' selected-target' : '');
          
          // Affichage du bonus de race
          let bonusHtml = '';
          if (raceBonus !== 0) {
            const bonusColor = raceBonus > 0 ? '#27ae60' : '#c0392b';
            const bonusSign = raceBonus > 0 ? '+' : '';
            bonusHtml = `<div style="font-size:11px; color:${bonusColor}; margin-top:0.25rem;">(Race : ${bonusSign}${raceBonus})</div>`;
          }
          
          if (hasDice) {
            // Afficher le dé final avec le bonus de race appliqué
            const finalDisplay = raceBonus !== 0 
              ? `<span style="text-decoration:line-through; opacity:0.5;">D${value}</span> → <strong>${finalAttr.display}</strong>`
              : `D${value}`;
            
            item.innerHTML = `
              <label>${attrNames[attr]}</label>
              <div class="attr-dice-display">${finalDisplay}</div>
              <div class="attr-value-display">Valeur : ${finalAttr.value}${finalAttr.bonus > 0 ? ' +' + finalAttr.bonus : ''}</div>
              ${bonusHtml}
              <button style="margin-top:0.5rem; padding:0.25rem 0.5rem; font-size:12px; background:#c0392b; color:#fff; border:none; border-radius:0.25rem; cursor:pointer;" data-attr="${attr}">✗ Retirer</button>
            `;
          } else {
            item.innerHTML = `
              <label>${attrNames[attr]}</label>
              <div class="attr-empty">${selectedDice ? '← Cliquez ici' : 'Aucun dé'}</div>
              ${bonusHtml}
            `;
          }
          
          // Event listener pour assigner ou retirer un dé
          item.addEventListener('click', (e) => {
            if (e.target.tagName === 'BUTTON') {
              // Retirer le dé
              creationState.attributes[attr] = null;
              selectedDice = null;
              renderAttributeDistribution();
            } else if (selectedDice && !hasDice) {
              // Assigner le dé sélectionné
              creationState.attributes[attr] = selectedDice;
              selectedDice = null;
              renderAttributeDistribution();
            }
          });
          
          container.appendChild(item);
        });
        
        // Vérifier si toutes les caractéristiques sont assignées
        const allAssigned = attrs.every(attr => creationState.attributes[attr] !== null);
        document.getElementById('btn-next-2').disabled = !allAssigned;
      }
      
      // Étape 3: Classes
      function renderClassOptions() {
        const container = document.getElementById('class-options');
        container.innerHTML = '';
        
        characterData.classes.forEach(cls => {
          const card = document.createElement('div');
          card.className = 'option-card' + (creationState.classe?.id === cls.id ? ' selected' : '');
          
          // Générer la liste des avantages de la classe (même format que les races)
          const avantagesHtml = (cls.avantages || []).map(adv => 
            `<li><strong>${adv.name}</strong> : ${adv.description}</li>`
          ).join('');
          
          card.innerHTML = `
            <img src="${getClassImagePath(cls.id)}" alt="${cls.name}" class="option-img" onerror="this.style.display='none'">
            <div class="option-content">
              <div class="option-name">${cls.name}</div>
              <div class="option-desc">${cls.description}</div>
              ${avantagesHtml ? `<ul class="option-bonuses">${avantagesHtml}</ul>` : ''}
            </div>
          `;
          card.addEventListener('click', () => {
            creationState.classe = cls;
            creationState.primaryAdvantage = null;
            creationState.secondaryAdvantages = [];
            renderClassOptions();
            document.getElementById('btn-next-3').disabled = false;
          });
          container.appendChild(card);
        });
      }
      
      // Étape 4: Avantage de classe
      function renderPrimaryAdvantageOptions() {
        const container = document.getElementById('primary-advantage-options');
        container.innerHTML = '';
        
        if (!creationState.classe) {
          container.innerHTML = '<p style="text-align:center;color:#e74c3c;">Veuillez d\'abord choisir une classe.</p>';
          return;
        }
        
        // Utiliser tous les avantages de la classe
        const avantages = creationState.classe.avantages || [];
        
        avantages.forEach(adv => {
          const card = document.createElement('div');
          card.className = 'option-card-simple' + (creationState.primaryAdvantage?.id === adv.id ? ' selected' : '');
          card.innerHTML = `
            <div class="option-name">${adv.name}</div>
            <div class="option-desc">${adv.description}</div>
          `;
          card.addEventListener('click', () => {
            creationState.primaryAdvantage = adv;
            renderPrimaryAdvantageOptions();
            document.getElementById('btn-next-4').disabled = false;
          });
          container.appendChild(card);
        });
      }
      
      // Étape 5: Compétences
      function renderCompetenceDistribution() {
        const container = document.getElementById('comp-distribute');
        container.innerHTML = '';
        
        const maxPoints = 12;
        const maxPerComp = 3; // Maximum +3 par compétence
        const pointsRemaining = maxPoints - creationState.compPointsUsed;
        
        characterData.competences.forEach(comp => {
          const value = creationState.competences[comp.id] || 0;
          const isMaxed = value >= maxPerComp;
          
          const item = document.createElement('div');
          item.className = 'comp-item' + (value > 0 ? ' has-points' : '');
          item.innerHTML = `
            <div class="comp-info">
              <span class="comp-name">${comp.name}</span>
              <span class="comp-attr">${comp.attribut}</span>
            </div>
            <div class="comp-controls">
              <button data-comp="${comp.id}" data-action="dec" ${value <= 0 ? 'disabled' : ''}>−</button>
              <span class="comp-value" style="${value > 0 ? 'color:#27ae60;font-weight:bold;' : ''}">+${value}</span>
              <button data-comp="${comp.id}" data-action="inc" ${isMaxed || pointsRemaining <= 0 ? 'disabled' : ''}>+</button>
            </div>
          `;
          container.appendChild(item);
        });
        
        // Event listeners
        container.querySelectorAll('button').forEach(btn => {
          btn.addEventListener('click', () => {
            const comp = btn.dataset.comp;
            const action = btn.dataset.action;
            const currentValue = creationState.competences[comp] || 0;
            
            if (action === 'inc' && currentValue < maxPerComp && creationState.compPointsUsed < maxPoints) {
              creationState.competences[comp] = currentValue + 1;
              creationState.compPointsUsed++;
            } else if (action === 'dec' && currentValue > 0) {
              creationState.competences[comp] = currentValue - 1;
              creationState.compPointsUsed--;
            }
            renderCompetenceDistribution();
          });
        });
        
        // Update points display
        const remaining = document.getElementById('comp-points-remaining');
        remaining.textContent = pointsRemaining;
        remaining.className = 'remaining' + (pointsRemaining === 0 ? ' done' : pointsRemaining < 4 ? ' warning' : '');
        
        // Enable/disable next button
        document.getElementById('btn-next-5').disabled = pointsRemaining !== 0;
      }
      
      // Étape 6: Avantages secondaires
      function renderSecondaryAdvantageOptions() {
        const container = document.getElementById('secondary-advantage-options');
        container.innerHTML = '';
        
        if (!creationState.classe) {
          container.innerHTML = '<p style="text-align:center;color:#e74c3c;">Veuillez d\'abord choisir une classe.</p>';
          return;
        }
        
        // Compte total des avantages sélectionnés (class + général + custom)
        const totalSelected = creationState.secondaryAdvantages.length + creationState.customAdvantages.length;
        
        // === SECTION 1: Avantages de classe ===
        const classTitle = document.createElement('h4');
        classTitle.className = 'advantages-section-title';
        classTitle.textContent = `Avantages de classe : ${creationState.classe.name}`;
        container.appendChild(classTitle);
        
        const classGrid = document.createElement('div');
        classGrid.className = 'options-grid-4col';
        container.appendChild(classGrid);
        
        // Utiliser tous les avantages de classe sauf celui choisi comme primaire
        const avantagesClasse = (creationState.classe.avantages || []).filter(
          adv => !creationState.primaryAdvantage || adv.id !== creationState.primaryAdvantage.id
        );
        
        avantagesClasse.forEach(adv => {
          const isSelected = creationState.secondaryAdvantages.some(a => a.id === adv.id && !a.isGeneral);
          const card = document.createElement('div');
          card.className = 'option-checkbox-simple' + (isSelected ? ' selected' : '');
          card.innerHTML = `
            <span class="checkbox-mark"></span>
            <div>
              <div class="option-name">${adv.name}</div>
              <div class="option-desc">${adv.description}</div>
            </div>
          `;
          card.addEventListener('click', () => {
            if (isSelected) {
              creationState.secondaryAdvantages = creationState.secondaryAdvantages.filter(a => a.id !== adv.id);
            } else if (totalSelected < 3) {
              creationState.secondaryAdvantages.push({ ...adv, isGeneral: false });
            }
            renderSecondaryAdvantageOptions();
          });
          classGrid.appendChild(card);
        });
        
        // === SECTION 2: Avantages généraux ===
        const generalTitle = document.createElement('h4');
        generalTitle.className = 'advantages-section-title';
        generalTitle.textContent = 'Avantages généraux';
        container.appendChild(generalTitle);
        
        const generalGrid = document.createElement('div');
        generalGrid.className = 'options-grid-4col';
        container.appendChild(generalGrid);
        
        const avantagesGeneraux = characterData.avantagesGeneraux || [];
        
        avantagesGeneraux.forEach(adv => {
          const isSelected = creationState.secondaryAdvantages.some(a => a.id === adv.id && a.isGeneral);
          const card = document.createElement('div');
          card.className = 'option-checkbox-simple' + (isSelected ? ' selected' : '');
          card.innerHTML = `
            <span class="checkbox-mark"></span>
            <div>
              <div class="option-name">${adv.name}</div>
              <div class="option-desc">${adv.description}</div>
            </div>
          `;
          card.addEventListener('click', () => {
            if (isSelected) {
              creationState.secondaryAdvantages = creationState.secondaryAdvantages.filter(a => !(a.id === adv.id && a.isGeneral));
            } else if (totalSelected < 3) {
              creationState.secondaryAdvantages.push({ ...adv, isGeneral: true });
            }
            renderSecondaryAdvantageOptions();
          });
          generalGrid.appendChild(card);
        });
        
        // === SECTION 3: Avantages personnalisés ===
        const customTitle = document.createElement('h4');
        customTitle.className = 'advantages-section-title';
        customTitle.textContent = 'Avantages personnalisés';
        container.appendChild(customTitle);
        
        const customContainer = document.createElement('div');
        customContainer.className = 'custom-advantages-container';
        container.appendChild(customContainer);
        
        // Afficher les avantages personnalisés existants
        creationState.customAdvantages.forEach((customAdv, index) => {
          const customCard = document.createElement('div');
          customCard.className = 'custom-advantage-card selected';
          customCard.innerHTML = `
            <div class="custom-advantage-header">
              <input type="text" class="custom-advantage-name" placeholder="Nom de l'avantage" value="${customAdv.name || ''}" data-index="${index}">
              <button class="custom-advantage-remove" data-index="${index}" title="Supprimer">×</button>
            </div>
            <textarea class="custom-advantage-desc" placeholder="Description de l'avantage" data-index="${index}">${customAdv.description || ''}</textarea>
          `;
          customContainer.appendChild(customCard);
          
          // Event listeners pour les inputs
          const nameInput = customCard.querySelector('.custom-advantage-name');
          const descInput = customCard.querySelector('.custom-advantage-desc');
          const removeBtn = customCard.querySelector('.custom-advantage-remove');
          
          nameInput.addEventListener('input', (e) => {
            creationState.customAdvantages[index].name = e.target.value;
            updateSecondaryCount();
          });
          
          descInput.addEventListener('input', (e) => {
            creationState.customAdvantages[index].description = e.target.value;
          });
          
          removeBtn.addEventListener('click', () => {
            creationState.customAdvantages.splice(index, 1);
            renderSecondaryAdvantageOptions();
          });
        });
        
        // Bouton "+" pour ajouter un avantage personnalisé
        if (totalSelected < 3) {
          const addBtn = document.createElement('div');
          addBtn.className = 'custom-advantage-add';
          addBtn.innerHTML = `
            <span class="add-icon">+</span>
            <span class="add-text">Ajouter un avantage personnalisé</span>
          `;
          addBtn.addEventListener('click', () => {
            if (totalSelected < 3) {
              creationState.customAdvantages.push({ 
                id: 'custom-' + Date.now(), 
                name: '', 
                description: '',
                isCustom: true
              });
              renderSecondaryAdvantageOptions();
            }
          });
          customContainer.appendChild(addBtn);
        }
        
        // Update count
        updateSecondaryCount();
      }
      
      function updateSecondaryCount() {
        const totalSelected = creationState.secondaryAdvantages.length + creationState.customAdvantages.length;
        document.getElementById('secondary-count').textContent = totalSelected;
        
        // Vérifier si tous les avantages personnalisés ont un nom
        const allCustomHaveNames = creationState.customAdvantages.every(adv => adv.name && adv.name.trim() !== '');
        
        document.getElementById('btn-next-6').disabled = totalSelected !== 3 || !allCustomHaveNames;
      }
      
      // Étape 7: Nom et Stats
      let nameCheckHandler = null;
      
      function renderNameAndStats() {
        const nameInput = document.getElementById('wizard-name');
        const alignmentSelect = document.getElementById('wizard-alignment');
        const calculatedPV = document.getElementById('calculated-pv');
        const calculatedPF = document.getElementById('calculated-pf');
        const statsDetails = document.getElementById('stats-details');
        const btnNext = document.getElementById('btn-next-7');
        
        // Restaurer les valeurs si elles existent
        if (nameInput && creationState.name) {
          nameInput.value = creationState.name;
        }
        if (alignmentSelect && creationState.alignment) {
          alignmentSelect.value = creationState.alignment;
        }
        
        // Calculer les stats
        const { pv, force, intel, niveau, bonusPV, forceBonus, intelBonus } = calculatePV();
        const { pf, bonusPF } = calculatePF(pv);
        
        // Afficher les calculs
        if (calculatedPV) calculatedPV.textContent = pv;
        if (calculatedPF) calculatedPF.textContent = pf;
        
        // Détails du calcul
        if (statsDetails) {
          // Afficher FOR et INT avec leurs bonus si présents
          const forceDisplay = forceBonus > 0 ? `${force - forceBonus}+${forceBonus}=${force}` : force;
          const intelDisplay = intelBonus > 0 ? `${intel - intelBonus}+${intelBonus}=${intel}` : intel;
          
          let details = `<strong>Calcul des PV :</strong> FOR(${forceDisplay})×2 + INT(${intelDisplay})×2 + 10 + Niveau(${niveau})`;
          if (bonusPV > 0) details += ` + Bonus(${bonusPV})`;
          details += ` = <strong>${pv}</strong><br>`;
          details += `<strong>Calcul des PF :</strong> PV(${pv})`;
          if (bonusPF > 0) details += ` + Bonus(${bonusPF})`;
          details += ` = <strong>${pf}</strong>`;
          
          // Ajouter un récap du personnage
          details += `<hr style="margin:0.75rem 0; border:none; border-top:1px dashed #ccc;">`;
          details += `<strong>Récapitulatif :</strong><br>`;
          if (creationState.race) details += `• Race : ${creationState.race.name}<br>`;
          if (creationState.classe) details += `• Classe : ${creationState.classe.name}<br>`;
          
          // Afficher les caractéristiques avec leurs valeurs finales
          const formatAttr = (attr) => {
            const final = getFinalAttribute(attr);
            if (!final.value) return '—';
            return final.bonus > 0 ? `D${final.value}+${final.bonus} (${final.value + final.bonus})` : `D${final.value} (${final.value})`;
          };
          details += `• FOR: ${formatAttr('force')} | DEX: ${formatAttr('dex')} | EMP: ${formatAttr('emp')} | SAG: ${formatAttr('sag')} | INT: ${formatAttr('int')}`;
          
          statsDetails.innerHTML = details;
        }
        
        // Fonction de validation (nom ET alignement requis)
        function validateStep7() {
          const nameOk = nameInput && nameInput.value.trim().length > 0;
          const alignmentOk = alignmentSelect && alignmentSelect.value !== '';
          
          // Stocker les valeurs dans creationState
          if (nameInput) creationState.name = nameInput.value.trim();
          if (alignmentSelect) creationState.alignment = alignmentSelect.value;
          
          if (btnNext) {
            btnNext.disabled = !(nameOk && alignmentOk);
          }
        }
        
        // Validation du nom et de l'alignement
        if (nameInput && alignmentSelect && btnNext) {
          // Supprimer les anciens handlers si existants
          if (nameCheckHandler) {
            nameInput.removeEventListener('input', nameCheckHandler);
            alignmentSelect.removeEventListener('change', nameCheckHandler);
          }
          
          // Créer un nouveau handler
          nameCheckHandler = validateStep7;
          
          nameInput.addEventListener('input', nameCheckHandler);
          alignmentSelect.addEventListener('change', nameCheckHandler);
          nameCheckHandler(); // Vérification initiale
        }
      }
      
      // Étape 8: Level Up
      // Level Up options configuration
      const LEVELUP_OPTIONS = [
        { id: 'autre-classe', cost: 6, name: 'Avantage d\'autre classe', desc: '+1 Avantage/Capacité d\'une autre classe' },
        { id: 'caracteristique', cost: 5, name: '+1 Dé Caractéristique', desc: '+1 Dé sur une carac. (ou +1 bonus si déjà D12)' },
        { id: 'classe-general', cost: 3, name: 'Avantage classe/général', desc: '+1 Avantage/Capacité de sa classe ou général' },
        { id: 'competence', cost: 1, name: '+1 Compétence', desc: '+1 point de compétence' }
      ];
      
      function renderLevelUpOptions() {
        const container = document.getElementById('level-up-container');
        const countInput = document.getElementById('levelup-count');
        const totalPointsSpan = document.getElementById('levelup-total-points');
        const minusBtn = document.getElementById('levelup-minus');
        const plusBtn = document.getElementById('levelup-plus');
        
        // Setup controls si pas déjà fait
        if (!minusBtn.dataset.initialized) {
          minusBtn.dataset.initialized = 'true';
          
          minusBtn.addEventListener('click', () => {
            const current = parseInt(countInput.value) || 0;
            if (current > 0) {
              countInput.value = current - 1;
              updateLevelUpPoints();
            }
          });
          
          plusBtn.addEventListener('click', () => {
            const current = parseInt(countInput.value) || 0;
            if (current < 10) {
              countInput.value = current + 1;
              updateLevelUpPoints();
            }
          });
          
          countInput.addEventListener('change', () => {
            let val = parseInt(countInput.value) || 0;
            val = Math.max(0, Math.min(10, val));
            countInput.value = val;
            updateLevelUpPoints();
          });
        }
        
        // Restore value
        countInput.value = creationState.levelUpCount;
        
        updateLevelUpPoints();
        renderLevelUpContent();
      }
      
      function updateLevelUpPoints() {
        const countInput = document.getElementById('levelup-count');
        const totalPointsSpan = document.getElementById('levelup-total-points');
        
        creationState.levelUpCount = parseInt(countInput.value) || 0;
        creationState.levelUpPointsTotal = creationState.levelUpCount * 10;
        
        // Recalculer les points dépensés
        creationState.levelUpPointsSpent = creationState.levelUpChoices.reduce((sum, c) => sum + c.cost, 0);
        
        totalPointsSpan.textContent = `= ${creationState.levelUpPointsTotal} points`;
        
        renderLevelUpContent();
      }
      
      function renderLevelUpContent() {
        const container = document.getElementById('level-up-container');
        container.innerHTML = '';
        
        if (creationState.levelUpCount === 0) {
          container.innerHTML = `
            <p style="text-align:center;color:#666;padding:1rem;">
              Vous n'avez pas de Level Up. Utilisez les boutons ci-dessus pour ajouter des Level Up si vous commencez à un niveau supérieur à 1.
            </p>
          `;
          return;
        }
        
        const pointsRemaining = creationState.levelUpPointsTotal - creationState.levelUpPointsSpent;
        
        // Points display
        const pointsDisplay = document.createElement('div');
        pointsDisplay.className = 'levelup-points-display';
        pointsDisplay.innerHTML = `
          <div style="font-size:14px; color:#666; margin-bottom:0.25rem;">Points restants</div>
          <div class="levelup-points-remaining ${pointsRemaining === 0 ? 'spent' : pointsRemaining <= 3 ? 'warning' : ''}">${pointsRemaining} / ${creationState.levelUpPointsTotal}</div>
        `;
        container.appendChild(pointsDisplay);
        
        // Options grid
        const optionsGrid = document.createElement('div');
        optionsGrid.className = 'levelup-options-grid';
        
        LEVELUP_OPTIONS.forEach(opt => {
          const canAfford = pointsRemaining >= opt.cost;
          const isSelected = creationState.levelUpCurrentSelection === opt.id;
          
          const card = document.createElement('div');
          card.className = 'levelup-option-card' + (isSelected ? ' selected' : '') + (!canAfford ? ' disabled' : '');
          card.innerHTML = `
            <div class="levelup-option-cost">${opt.cost} pt${opt.cost > 1 ? 's' : ''}</div>
            <div class="levelup-option-name">${opt.name}</div>
            <div class="levelup-option-desc">${opt.desc}</div>
          `;
          
          if (canAfford) {
            card.addEventListener('click', () => {
              creationState.levelUpCurrentSelection = isSelected ? null : opt.id;
              renderLevelUpContent();
            });
          }
          
          optionsGrid.appendChild(card);
        });
        
        container.appendChild(optionsGrid);
        
        // Selection panel (if an option is selected)
        if (creationState.levelUpCurrentSelection) {
          const selectionPanel = document.createElement('div');
          selectionPanel.className = 'levelup-selection-panel';
          renderSelectionPanel(selectionPanel, creationState.levelUpCurrentSelection, pointsRemaining);
          container.appendChild(selectionPanel);
        }
        
        // Current choices list
        if (creationState.levelUpChoices.length > 0) {
          const choicesList = document.createElement('div');
          choicesList.className = 'levelup-choices-list';
          choicesList.innerHTML = '<strong style="color:#8b0000;">🎯 Améliorations choisies :</strong>';
          
          creationState.levelUpChoices.forEach((choice, index) => {
            const item = document.createElement('div');
            item.className = 'levelup-choice-item';
            item.innerHTML = `
              <span><strong>${choice.cost} pts</strong> - ${choice.label}</span>
              <button class="levelup-choice-remove" data-index="${index}">✕ Retirer</button>
            `;
            item.querySelector('button').addEventListener('click', () => {
              // Retirer le choix et recalculer les points
              const removedChoice = creationState.levelUpChoices.splice(index, 1)[0];
              creationState.levelUpPointsSpent -= removedChoice.cost;
              renderLevelUpContent();
            });
            choicesList.appendChild(item);
          });
          
          container.appendChild(choicesList);
        }
      }
      
      function renderSelectionPanel(panel, optionId, pointsRemaining) {
        const opt = LEVELUP_OPTIONS.find(o => o.id === optionId);
        if (!opt) return;
        
        panel.innerHTML = `<div class="levelup-selection-title">Choisissez : ${opt.name} (${opt.cost} pts)</div>`;
        
        const content = document.createElement('div');
        
        switch (optionId) {
          case 'competence':
            renderCompetenceSelection(content, opt.cost);
            break;
          case 'caracteristique':
            renderCaracteristiqueSelection(content, opt.cost);
            break;
          case 'classe-general':
            renderClasseGeneralSelection(content, opt.cost);
            break;
          case 'autre-classe':
            renderAutreClasseSelection(content, opt.cost);
            break;
        }
        
        panel.appendChild(content);
      }
      
      function renderCompetenceSelection(container, cost) {
        container.innerHTML = '<p style="margin-bottom:0.75rem; color:#666;">Sélectionnez une compétence à améliorer (+1) :</p>';
        
        const grid = document.createElement('div');
        grid.className = 'levelup-comp-grid';
        grid.style.cssText = 'display:grid; grid-template-columns:repeat(auto-fill, minmax(150px, 1fr)); gap:0.5rem; max-height:200px; overflow-y:auto;';
        
        characterData.competences.forEach(comp => {
          const btn = document.createElement('button');
          btn.style.cssText = 'padding:0.5rem; border:1px solid #ddd; border-radius:0.25rem; background:#fff; cursor:pointer; text-align:left; font-size:12px;';
          btn.innerHTML = `<strong>${comp.name}</strong> <span style="color:#888;">(${comp.attribut})</span>`;
          btn.addEventListener('click', () => {
            addLevelUpChoice({
              type: 'competence',
              cost: cost,
              label: `+1 ${comp.name} (${comp.attribut})`,
              details: { compId: comp.id, compName: comp.name }
            });
          });
          btn.addEventListener('mouseover', () => btn.style.borderColor = '#8b0000');
          btn.addEventListener('mouseout', () => btn.style.borderColor = '#ddd');
          grid.appendChild(btn);
        });
        
        container.appendChild(grid);
      }
      
      function renderCaracteristiqueSelection(container, cost) {
        container.innerHTML = '<p style="margin-bottom:0.75rem; color:#666;">Sélectionnez une caractéristique à améliorer :</p>';
        
        // Mapping des clés: displayKey -> stateKey
        const attrMapping = {
          'for': { name: 'Force (FOR)', sheetId: 'force' },
          'dex': { name: 'Dextérité (DEX)', sheetId: 'dex' },
          'emp': { name: 'Empathie (EMP)', sheetId: 'emp' },
          'sag': { name: 'Sagesse (SAG)', sheetId: 'sag' },
          'int': { name: 'Intelligence (INT)', sheetId: 'int' }
        };
        const diceProgression = [4, 6, 8, 10, 12];
        
        const grid = document.createElement('div');
        grid.className = 'levelup-carac-grid';
        grid.style.cssText = 'display:grid; grid-template-columns:repeat(5, 1fr); gap:0.5rem;';
        
        Object.entries(attrMapping).forEach(([stateKey, attrInfo]) => {
          // Récupérer la valeur actuelle depuis le creationState ou directement depuis la fiche
          let baseDie = creationState.attributes[stateKey] || 4;
          
          // Si en mode libre, récupérer directement depuis la fiche
          if (currentMode === 'free') {
            const sheetInput = document.getElementById(attrInfo.sheetId);
            if (sheetInput) {
              baseDie = parseInt(sheetInput.value) || 4;
            }
          }
          
          const raceBonus = creationState.attributeBonuses[stateKey] || 0;
          
          // Bonus existants sur la fiche (au-delà du D12)
          const existingBonus = (creationState.existingBonuses && creationState.existingBonuses[stateKey]) || 0;
          
          // Nombre de level ups déjà choisis pour cette caractéristique dans cette session
          const levelUpCount = creationState.levelUpChoices
            .filter(c => c.type === 'caracteristique' && c.details && c.details.attrKey === stateKey)
            .length;
          
          // Calculer l'état actuel
          let currentIndex = diceProgression.indexOf(baseDie);
          if (currentIndex === -1) currentIndex = diceProgression.length - 1; // Assume D12 if not found
          
          // Ajouter les bonus existants de la fiche
          let currentExtraBonus = existingBonus;
          
          // Ajouter les bonus de race et de level ups de cette session
          const totalBonusSteps = raceBonus + levelUpCount;
          
          for (let i = 0; i < totalBonusSteps; i++) {
            if (currentIndex < diceProgression.length - 1) {
              currentIndex++;
            } else {
              currentExtraBonus++;
            }
          }
          
          const currentDie = diceProgression[currentIndex];
          
          // Calculer ce qui se passe avec +1 level up supplémentaire
          let nextDie = currentDie;
          let nextExtraBonus = currentExtraBonus;
          
          if (currentIndex < diceProgression.length - 1) {
            nextDie = diceProgression[currentIndex + 1];
          } else {
            nextExtraBonus = currentExtraBonus + 1;
          }
          
          // Construire le texte d'effet
          const attrDisplayName = attrInfo.name.split(' ')[0];
          let currentDisplay = `D${currentDie}${currentExtraBonus > 0 ? '+' + currentExtraBonus : ''}`;
          let nextDisplay = `D${nextDie}${nextExtraBonus > 0 ? '+' + nextExtraBonus : ''}`;
          const effectText = `${currentDisplay} → ${nextDisplay}`;
          
          const btn = document.createElement('button');
          btn.style.cssText = 'padding:0.75rem 0.5rem; border:2px solid #ddd; border-radius:0.5rem; background:#fff; cursor:pointer; text-align:center;';
          btn.innerHTML = `
            <div style="font-weight:bold; font-size:13px;">${attrDisplayName}</div>
            <div style="font-size:11px; color:#666;">Actuel: ${currentDisplay}</div>
            <div style="font-size:10px; color:#27ae60; margin-top:0.25rem;">${effectText}</div>
          `;
          btn.addEventListener('click', () => {
            addLevelUpChoice({
              type: 'caracteristique',
              cost: cost,
              label: `+1 ${attrDisplayName} (${effectText})`,
              details: { attrKey: stateKey, sheetId: attrInfo.sheetId }
            });
          });
          btn.addEventListener('mouseover', () => btn.style.borderColor = '#8b0000');
          btn.addEventListener('mouseout', () => btn.style.borderColor = '#ddd');
          grid.appendChild(btn);
        });
        
        container.appendChild(grid);
      }
      
      // Vérifie si un avantage est déjà choisi (étapes précédentes ou level ups)
      function isAdvantageAlreadyChosen(advId) {
        // Vérifier l'avantage primaire (étape 4)
        if (creationState.primaryAdvantage && creationState.primaryAdvantage.id === advId) {
          return true;
        }
        
        // Vérifier les avantages secondaires (étape 6)
        if (creationState.secondaryAdvantages.some(a => a.id === advId)) {
          return true;
        }
        
        // Vérifier les avantages personnalisés (étape 6)
        if (creationState.customAdvantages.some(a => a.id === advId)) {
          return true;
        }
        
        // Vérifier les choix de level up
        if (creationState.levelUpChoices.some(c => c.details && c.details.advId === advId)) {
          return true;
        }
        
        return false;
      }
      
      function renderClasseGeneralSelection(container, cost) {
        container.innerHTML = '';
        
        // Section: Avantages de classe
        if (creationState.classe && creationState.classe.avantages) {
          const classSection = document.createElement('div');
          classSection.innerHTML = `<p style="margin-bottom:0.5rem; color:#666;"><strong>Avantages de votre classe (${creationState.classe.name}) :</strong></p>`;
          
          const classGrid = document.createElement('div');
          classGrid.className = 'levelup-adv-grid';
          classGrid.style.cssText = 'display:grid; grid-template-columns:repeat(auto-fill, minmax(280px, 1fr)); gap:0.75rem; margin-bottom:1rem; max-height:300px; overflow-y:auto;';
          
          const availableClassAdvantages = creationState.classe.avantages.filter(adv => !isAdvantageAlreadyChosen(adv.id));
          
          if (availableClassAdvantages.length === 0) {
            classGrid.innerHTML = '<p style="color:#999; font-style:italic; padding:0.5rem;">Tous les avantages de classe ont été choisis.</p>';
          } else {
            availableClassAdvantages.forEach(adv => {
              const btn = document.createElement('button');
              btn.style.cssText = 'padding:0.75rem; border:1px solid #ddd; border-radius:0.5rem; background:#fff; cursor:pointer; text-align:left; font-size:12px; line-height:1.4;';
              btn.innerHTML = `<strong style="color:#333;">${adv.name}</strong><br><span style="color:#666; font-size:11px;">${adv.description}</span>`;
              btn.addEventListener('click', () => {
                addLevelUpChoice({
                  type: 'classe-general',
                  cost: cost,
                  label: `${adv.name} (Classe)`,
                  details: { advId: adv.id, advName: adv.name, advDesc: adv.description, source: 'classe' }
                });
              });
              btn.addEventListener('mouseover', () => btn.style.borderColor = '#8b0000');
              btn.addEventListener('mouseout', () => btn.style.borderColor = '#ddd');
              classGrid.appendChild(btn);
            });
          }
          
          classSection.appendChild(classGrid);
          container.appendChild(classSection);
        }
        
        // Section: Avantages généraux
        const generalSection = document.createElement('div');
        generalSection.innerHTML = `<p style="margin-bottom:0.5rem; color:#666;"><strong>Avantages généraux :</strong></p>`;
        
        const generalGrid = document.createElement('div');
        generalGrid.className = 'levelup-adv-grid';
        generalGrid.style.cssText = 'display:grid; grid-template-columns:repeat(auto-fill, minmax(280px, 1fr)); gap:0.75rem; margin-bottom:1rem; max-height:300px; overflow-y:auto;';
        
        const availableGeneralAdvantages = (characterData.avantagesGeneraux || []).filter(adv => !isAdvantageAlreadyChosen(adv.id));
        
        if (availableGeneralAdvantages.length === 0) {
          generalGrid.innerHTML = '<p style="color:#999; font-style:italic; padding:0.5rem;">Tous les avantages généraux ont été choisis.</p>';
        } else {
          availableGeneralAdvantages.forEach(adv => {
            const btn = document.createElement('button');
            btn.style.cssText = 'padding:0.75rem; border:1px solid #ddd; border-radius:0.5rem; background:#fff; cursor:pointer; text-align:left; font-size:12px; line-height:1.4;';
            btn.innerHTML = `<strong style="color:#333;">${adv.name}</strong><br><span style="color:#666; font-size:11px;">${adv.description}</span>`;
            btn.addEventListener('click', () => {
              addLevelUpChoice({
                type: 'classe-general',
                cost: cost,
                label: `${adv.name} (Général)`,
                details: { advId: adv.id, advName: adv.name, advDesc: adv.description, source: 'general' }
              });
            });
            btn.addEventListener('mouseover', () => btn.style.borderColor = '#8b0000');
            btn.addEventListener('mouseout', () => btn.style.borderColor = '#ddd');
            generalGrid.appendChild(btn);
          });
        }
        
        generalSection.appendChild(generalGrid);
        container.appendChild(generalSection);
        
        // Section: Avantage personnalisé
        const customSection = document.createElement('div');
        customSection.innerHTML = `<p style="margin-bottom:0.5rem; color:#666;"><strong>Créer un avantage personnalisé :</strong></p>`;
        
        const customForm = document.createElement('div');
        customForm.style.cssText = 'background:#f8f9fa; border-radius:0.5rem; padding:1rem; border:2px dashed #8b0000;';
        customForm.innerHTML = `
          <div style="margin-bottom:0.75rem;">
            <label style="display:block; font-size:12px; color:#666; margin-bottom:0.25rem;">Nom de l'avantage</label>
            <input type="text" id="levelup-custom-adv-name" placeholder="Ex: Technique spéciale..." style="width:100%; padding:0.5rem; border:1px solid #ddd; border-radius:0.25rem; font-size:13px; box-sizing:border-box;">
          </div>
          <div style="margin-bottom:0.75rem;">
            <label style="display:block; font-size:12px; color:#666; margin-bottom:0.25rem;">Description</label>
            <textarea id="levelup-custom-adv-desc" placeholder="Décrivez l'effet de cet avantage..." rows="3" style="width:100%; padding:0.5rem; border:1px solid #ddd; border-radius:0.25rem; font-size:12px; resize:vertical; box-sizing:border-box;"></textarea>
          </div>
          <button id="levelup-custom-adv-add" style="padding:0.5rem 1.5rem; background:#8b0000; color:#fff; border:none; border-radius:0.25rem; font-weight:bold; cursor:pointer; font-size:13px;">
            ✦ Ajouter cet avantage (${cost} pts)
          </button>
        `;
        
        customSection.appendChild(customForm);
        container.appendChild(customSection);
        
        // Event listener pour le bouton d'ajout d'avantage personnalisé
        setTimeout(() => {
          const addBtn = document.getElementById('levelup-custom-adv-add');
          if (addBtn) {
            addBtn.addEventListener('click', () => {
              const nameInput = document.getElementById('levelup-custom-adv-name');
              const descInput = document.getElementById('levelup-custom-adv-desc');
              
              const name = nameInput?.value?.trim();
              const desc = descInput?.value?.trim();
              
              if (!name) {
                nameInput.style.borderColor = '#e74c3c';
                nameInput.focus();
                return;
              }
              
              addLevelUpChoice({
                type: 'custom-levelup',
                cost: cost,
                label: `${name} (Personnalisé ✦)`,
                details: { 
                  advId: 'custom-levelup-' + Date.now(), 
                  advName: name, 
                  advDesc: desc || 'Avantage personnalisé', 
                  source: 'custom' 
                }
              });
            });
          }
        }, 0);
      }
      
      function renderAutreClasseSelection(container, cost) {
        container.innerHTML = '<p style="margin-bottom:0.75rem; color:#666;">Sélectionnez d\'abord une classe, puis un avantage :</p>';
        
        // Liste des autres classes
        const classSelect = document.createElement('select');
        classSelect.style.cssText = 'width:100%; padding:0.5rem; margin-bottom:1rem; border:2px solid #ddd; border-radius:0.25rem; font-size:14px;';
        classSelect.innerHTML = '<option value="">-- Choisir une classe --</option>';
        
        characterData.classes.forEach(cls => {
          if (!creationState.classe || cls.id !== creationState.classe.id) {
            classSelect.innerHTML += `<option value="${cls.id}">${cls.name}</option>`;
          }
        });
        
        const advantagesContainer = document.createElement('div');
        advantagesContainer.className = 'levelup-adv-grid';
        advantagesContainer.style.cssText = 'display:grid; grid-template-columns:repeat(auto-fill, minmax(280px, 1fr)); gap:0.75rem; max-height:300px; overflow-y:auto;';
        
        classSelect.addEventListener('change', () => {
          advantagesContainer.innerHTML = '';
          const selectedClass = characterData.classes.find(c => c.id === classSelect.value);
          if (!selectedClass) return;
          
          // Filtrer les avantages déjà choisis
          const availableAdvantages = (selectedClass.avantages || []).filter(adv => !isAdvantageAlreadyChosen(adv.id));
          
          if (availableAdvantages.length === 0) {
            advantagesContainer.innerHTML = '<p style="color:#999; font-style:italic; padding:0.5rem;">Tous les avantages de cette classe ont été choisis.</p>';
          } else {
            availableAdvantages.forEach(adv => {
              const btn = document.createElement('button');
              btn.style.cssText = 'padding:0.75rem; border:1px solid #ddd; border-radius:0.5rem; background:#fff; cursor:pointer; text-align:left; font-size:12px; line-height:1.4;';
              btn.innerHTML = `<strong style="color:#333;">${adv.name}</strong><br><span style="color:#666; font-size:11px;">${adv.description}</span>`;
              btn.addEventListener('click', () => {
                addLevelUpChoice({
                  type: 'autre-classe',
                  cost: cost,
                  label: `${adv.name} (${selectedClass.name})`,
                  details: { advId: adv.id, advName: adv.name, advDesc: adv.description, className: selectedClass.name }
                });
              });
              btn.addEventListener('mouseover', () => btn.style.borderColor = '#8b0000');
              btn.addEventListener('mouseout', () => btn.style.borderColor = '#ddd');
              advantagesContainer.appendChild(btn);
            });
          }
        });
        
        container.appendChild(classSelect);
        container.appendChild(advantagesContainer);
      }
      
      function addLevelUpChoice(choice) {
        const pointsRemaining = creationState.levelUpPointsTotal - creationState.levelUpPointsSpent;
        if (choice.cost > pointsRemaining) return;
        
        creationState.levelUpChoices.push(choice);
        creationState.levelUpPointsSpent += choice.cost;
        creationState.levelUpCurrentSelection = null;
        
        renderLevelUpContent();
      }
      
      // Appliquer les choix de Level Up à la fiche
      function applyLevelUpChoices() {
        if (creationState.levelUpChoices.length === 0 && creationState.levelUpCount === 0) return;
        
        // En mode wizard normal, mettre à jour le niveau
        if (currentMode !== 'free') {
          const levelField = document.getElementById('level');
          if (levelField) {
            levelField.value = 1 + creationState.levelUpCount;
          }
        }
        
        // Parcourir les choix
        creationState.levelUpChoices.forEach(choice => {
          switch (choice.type) {
            case 'competence':
              // Appliquer directement à la fiche en mode libre
              if (currentMode === 'free') {
                applyLevelUpCompetenceToSheet(choice.details);
              }
              break;
            case 'caracteristique':
              // Appliquer directement à la fiche en mode libre
              if (currentMode === 'free') {
                applyLevelUpCharacteristicToSheet(choice.details);
              }
              break;
            case 'classe-general':
            case 'autre-classe':
              applyLevelUpAdvantage(choice);
              break;
          }
        });
        
        // Si pas en mode libre, utiliser les fonctions standard
        if (currentMode !== 'free') {
          // Recalculer PV/PF avec le nouveau niveau
          const { pv } = calculatePV();
          const { pf } = calculatePF(pv);
          
          const pvMaxField = document.getElementById('pv-max');
          const pvCurrentField = document.getElementById('pv-current');
          const pfMaxField = document.getElementById('pf-max');
          const pfCurrentField = document.getElementById('pf-current');
          
          if (pvMaxField) pvMaxField.value = pv;
          if (pvCurrentField) pvCurrentField.value = pv;
          if (pfMaxField) pfMaxField.value = pf;
          if (pfCurrentField) pfCurrentField.value = pf;
        }
      }
      
      // Recalculer PV/PF directement depuis les valeurs de la fiche
      // Formule: PV = (2 x Force) + (2 x Intel) + 10 + Level
      // PF = PV
      function recalculatePVPFFromSheet() {
        // Lire les valeurs directement depuis la fiche
        const forceInput = document.getElementById('force');
        const intInput = document.getElementById('int');
        const levelInput = document.getElementById('level');
        
        // Lire les valeurs des dés
        const forceDie = parseInt(forceInput?.value) || 10;
        const intDie = parseInt(intInput?.value) || 10;
        const level = parseInt(levelInput?.value) || 1;
        
        // Lire les bonus au-delà de D12 (+1, +2, etc.)
        const forceBox = forceInput?.closest('.attr-box');
        const intBox = intInput?.closest('.attr-box');
        const forceBonusInput = forceBox?.querySelector('input[type="text"]');
        const intBonusInput = intBox?.querySelector('input[type="text"]');
        const forceBonus = parseInt(forceBonusInput?.value?.replace(/[^0-9-]/g, '')) || 0;
        const intBonus = parseInt(intBonusInput?.value?.replace(/[^0-9-]/g, '')) || 0;
        
        // Valeur totale = dé + bonus
        const forceValue = forceDie + forceBonus;
        const intValue = intDie + intBonus;
        
        // Calcul PV = (2 x Force) + (2 x Intel) + 10 + Level
        const pv = (forceValue * 2) + (intValue * 2) + 10 + level;
        const pf = pv; // PF = PV
        
        // Mettre à jour les champs
        const pvMaxField = document.getElementById('pv-max');
        const pvCurrentField = document.getElementById('pv-current');
        const pfMaxField = document.getElementById('pf-max');
        const pfCurrentField = document.getElementById('pf-current');
        
        if (pvMaxField) pvMaxField.value = pv;
        if (pvCurrentField) pvCurrentField.value = pv;
        if (pfMaxField) pfMaxField.value = pf;
        if (pfCurrentField) pfCurrentField.value = pf;
        
        console.log(`PV/PF recalculés: Force(${forceDie}+${forceBonus}=${forceValue}) + Intel(${intDie}+${intBonus}=${intValue}) + Level(${level}) = ${pv}`);
      }
      
      // Appliquer une amélioration de caractéristique directement à la fiche
      function applyLevelUpCharacteristicToSheet(details) {
        const sheetId = details.sheetId;
        if (!sheetId) return;
        
        const input = document.getElementById(sheetId);
        if (!input) return;
        
        const box = input.closest('.attr-box');
        const bonusInput = box?.querySelector('input[type="text"]');
        
        const currentDie = parseInt(input.value) || 4;
        const currentBonus = parseInt(bonusInput?.value?.replace(/[^0-9-]/g, '')) || 0;
        
        const diceProgression = [4, 6, 8, 10, 12];
        const currentIndex = diceProgression.indexOf(currentDie);
        
        if (currentIndex < diceProgression.length - 1) {
          // Monter le dé d'un cran
          input.value = diceProgression[currentIndex + 1];
          input.dispatchEvent(new Event('input')); // Met à jour l'affichage (D8), etc.
        } else {
          // Déjà à D12, ajouter +1 au bonus
          if (bonusInput) {
            bonusInput.value = `+${currentBonus + 1}`;
          }
        }
      }
      
      // Appliquer une amélioration de compétence directement à la fiche
      function applyLevelUpCompetenceToSheet(details) {
        const skillsBody = document.querySelector('.skill-table tbody');
        if (!skillsBody) return;
        
        const comp = characterData.competences.find(c => c.id === details.compId);
        if (!comp) return;
        
        // Chercher si la compétence existe déjà
        const rows = skillsBody.querySelectorAll('tr');
        let found = false;
        
        rows.forEach(row => {
          const nameCell = row.querySelector('td:first-child');
          if (nameCell && nameCell.textContent.trim() === comp.name) {
            found = true;
            const bonusInput = row.querySelector('input');
            if (bonusInput) {
              const currentValue = parseInt(bonusInput.value.replace(/[^0-9-]/g, '')) || 0;
              bonusInput.value = `+${currentValue + 1}`;
            }
          }
        });
        
        // Si pas trouvée, l'ajouter
        if (!found) {
          const newRow = document.createElement('tr');
          newRow.innerHTML = `
            <td>${comp.name}</td>
            <td>${comp.attribut}</td>
            <td><input type="text" value="+1" style="width:100%;border:none;text-align:center;font-size:16px;" /></td>
          `;
          skillsBody.appendChild(newRow);
        }
      }
      
      function applyLevelUpCompetence(details) {
        // Ajouter +1 à la compétence dans le tableau
        const skillsBody = document.querySelector('.skill-table tbody');
        if (!skillsBody) return;
        
        const comp = characterData.competences.find(c => c.id === details.compId);
        if (!comp) return;
        
        // Chercher si la compétence existe déjà
        const rows = skillsBody.querySelectorAll('tr');
        let found = false;
        
        for (const row of rows) {
          const nameCell = row.querySelector('td:first-child input');
          if (nameCell && nameCell.value === comp.name) {
            // Incrémenter le bonus existant
            const bonusCell = row.querySelector('td:last-child input');
            if (bonusCell) {
              let currentBonus = parseInt(bonusCell.value.replace(/[^0-9-]/g, '')) || 0;
              bonusCell.value = '+' + (currentBonus + 1);
              found = true;
              break;
            }
          }
        }
        
        // Si pas trouvée, chercher une ligne vide ou en créer une nouvelle
        if (!found) {
          // Chercher une ligne vide
          let emptyRow = null;
          for (const row of rows) {
            const nameCell = row.querySelector('td:first-child input');
            if (nameCell && !nameCell.value.trim()) {
              emptyRow = row;
              break;
            }
          }
          
          if (emptyRow) {
            // Utiliser la ligne vide
            const cells = emptyRow.querySelectorAll('td input');
            if (cells.length >= 3) {
              cells[0].value = comp.name;
              cells[1].value = comp.attribut;
              cells[2].value = '+1';
            }
          } else {
            // Créer une nouvelle ligne
            const newRow = document.createElement('tr');
            newRow.innerHTML = `
              <td><input value="${comp.name}" /></td>
              <td><input value="${comp.attribut}" /></td>
              <td><input type="text" value="+1" style="text-align:center;" /></td>
            `;
            skillsBody.appendChild(newRow);
          }
        }
      }
      
      function applyLevelUpCaracteristique(details) {
        const attr = details.attr;
        // Les IDs correspondent aux noms des attributs dans le HTML
        const attrMapping = { force: 'force', dex: 'dex', emp: 'emp', sag: 'sag', int: 'int' };
        const fieldId = attrMapping[attr];
        
        // Récupérer le champ principal de la caractéristique
        const valueField = document.getElementById(fieldId);
        if (!valueField) return;
        
        // Le champ bonus est le deuxième input dans le même conteneur (après le dice span)
        const container = valueField.closest('.value-wrap');
        const bonusField = container ? container.querySelector('input[type="text"]') : null;
        
        let currentValue = parseInt(valueField.value) || 4;
        let currentBonus = parseInt(bonusField?.value?.replace(/[^0-9-]/g, '')) || 0;
        
        if (currentValue < 12) {
          // Augmenter le dé
          valueField.value = Math.min(12, currentValue + 2);
        } else {
          // Déjà au max, augmenter le bonus
          if (bonusField) {
            bonusField.value = '+' + (currentBonus + 1);
          }
        }
      }
      
      function applyLevelUpAdvantage(choice) {
        // Ajouter l'avantage à la liste des capacités
        const sections = document.querySelectorAll('.section');
        sections.forEach(section => {
          const h3 = section.querySelector('h3');
          if (h3 && (h3.textContent.includes('Capacités') || h3.textContent.includes('Avantages'))) {
            const list = section.querySelector('.abilities-list');
            if (list) {
              const li = document.createElement('li');
              // Determine marker based on type and source
              let marker = '';
              if (choice.type === 'autre-classe') {
                marker = ' ⬡';
              } else if (choice.type === 'custom-levelup') {
                marker = ' ✦';
              } else if (choice.type === 'classe-general' && choice.details?.source === 'general') {
                marker = ' ◆';
              }
              // No marker for same-class advantages (choice.type === 'classe-general' without source='general')
              li.innerHTML = `<strong>${choice.details.advName}${marker}</strong> : ${choice.details.advDesc}`;
              list.appendChild(li);
            }
          }
        });
      }
      
      // Finaliser la fiche
      function generateCharacterSheet() {
        // Appliquer les level ups
        applyLevelUpChoices();
        
        // Si on vient du mode libre (Level Up depuis fiche libre)
        if (currentMode === 'free') {
          // Mettre à jour le niveau sur la fiche
          const levelUpCount = parseInt(document.getElementById('levelup-count')?.value) || 0;
          let newLevel = parseInt(document.getElementById('level').value) || 1;
          if (levelUpCount > 0) {
            newLevel = newLevel + levelUpCount;
            document.getElementById('level').value = newLevel;
          }
          
          // Recalculer les PV/PF avec les nouvelles valeurs de la fiche
          recalculatePVPFFromSheet();
          
          // Retourner au mode libre
          document.getElementById('wizard-container').style.display = 'none';
          document.getElementById('wizard-separator').style.display = 'none';
          document.getElementById('reference-panel').style.display = 'block';
          document.getElementById('btn-back-from-ref').style.display = 'none';
          document.getElementById('free-mode-buttons').style.display = 'block';
          document.getElementById('character-sheet').style.display = 'block';
          
          // Réinitialiser les choices pour un prochain level up
          creationState.levelUpChoices = [];
          creationState.levelUpPointsSpent = 0;
          
          alert('✅ Level Up appliqué avec succès !');
          
          // Scroll vers la fiche
          setTimeout(() => {
            document.getElementById('character-sheet').scrollIntoView({ behavior: 'smooth' });
          }, 100);
          return;
        }
        
        // Mode wizard normal - appliquer toutes les étapes
        updateSheetRace();
        updateSheetAttributes();
        updateSheetClass();
        updateSheetCapacities();
        updateSheetCompetences();
        updateSheetNameAndStats();
        
        // Mettre le texte par défaut des Notes avec les valeurs de création
        const notesTextarea = document.querySelector('.portrait textarea');
        if (notesTextarea) {
          notesTextarea.value = `- Point d'espoir : 1
- Point d'anarchisme : 1
- Santé mentale : 15

- Pièces d'or = 0
- Pièces d'argent = 0
- Pièces de cuivre = 0

Equipement :
- `;
          // Auto-resize the textarea
          notesTextarea.style.height = 'auto';
          notesTextarea.style.height = (notesTextarea.scrollHeight) + 'px';
        }
        
        // Afficher l'étape 9 dans la progress bar
        const step9 = document.querySelector('.progress-step[data-step="9"]');
        step9.style.display = 'flex';
        
        // Marquer toutes les étapes comme complétées et activer l'étape 9
        document.querySelectorAll('.progress-step').forEach(step => {
          const stepNum = parseInt(step.dataset.step);
          step.classList.remove('active', 'completed');
          if (stepNum === 9) {
            step.classList.add('active');
          } else {
            step.classList.add('completed');
          }
        });
        
        // Cacher le contenu de l'étape actuelle
        document.querySelectorAll('.step-content').forEach(el => el.classList.remove('active'));
        
        // Afficher un message de succès (sans masquer le wizard)
        const separator = document.getElementById('wizard-separator');
        separator.style.display = 'block';
        separator.innerHTML = `
          <div style="text-align: center; padding: 1rem;">
            <h3 style="color: #27ae60; margin-bottom: 0.5rem;">✅ Création terminée - Fiche éditable</h3>
            <p style="color: #666; margin: 0;">Pour revenir sur des éléments de la création, cliquez sur la bulle correspondante au-dessus.<br>
            <em style="color: #e74c3c;">⚠️ Cela annulera vos modifications manuelles sur la fiche.</em></p>
          </div>
        `;
        
        // Afficher le panneau de référence
        document.getElementById('reference-panel').style.display = 'block';
        
        // Mettre à jour currentStep pour la navigation
        currentStep = 9;
        
        // Scroller vers la fiche
        document.getElementById('character-sheet').scrollIntoView({ behavior: 'smooth' });
        
        // Afficher une notification temporaire
        const notification = document.createElement('div');
        notification.style.cssText = 'position:fixed;top:20px;left:50%;transform:translateX(-50%);background:#27ae60;color:#fff;padding:1rem 2rem;border-radius:0.5rem;font-weight:bold;z-index:9999;box-shadow:0 4px 15px rgba(0,0,0,0.2);';
        notification.textContent = '✅ Fiche générée ! Cliquez sur une étape pour modifier.';
        document.body.appendChild(notification);
        setTimeout(() => notification.remove(), 4000);
      }
      
      // Initialiser
      initWizard();
      
      // ========== PANNEAU DE RÉFÉRENCE ==========
      function initReferencePanel() {
        const panel = document.getElementById('reference-panel');
        const content = document.getElementById('reference-content');
        const buttons = document.querySelectorAll('.reference-btn');
        
        buttons.forEach(btn => {
          btn.addEventListener('click', () => {
            const refType = btn.dataset.ref;
            const wasActive = btn.classList.contains('active');
            
            // Reset all buttons
            buttons.forEach(b => b.classList.remove('active'));
            
            if (wasActive) {
              // Close panel
              content.classList.remove('active');
              content.innerHTML = '';
            } else {
              // Open panel with content
              btn.classList.add('active');
              content.classList.add('active');
              renderReferenceContent(refType);
            }
          });
        });
      }
      
      function renderReferenceContent(type) {
        const content = document.getElementById('reference-content');
        let html = '';
        
        switch (type) {
          case 'races':
            html = renderRacesReference();
            break;
          case 'classes':
            html = renderClassesReference();
            break;
          case 'class-advantages':
            html = renderClassAdvantagesReference();
            break;
          case 'general-advantages':
            html = renderGeneralAdvantagesReference();
            break;
          case 'custom-advantages':
            html = renderCustomAdvantagesReference();
            break;
          case 'session-advantages':
            html = renderSessionAdvantagesReference();
            break;
          case 'competences':
            html = renderCompetencesReference();
            break;
        }
        
        content.innerHTML = html + '<button class="reference-close-btn" onclick="closeReferencePanel()">✕ Fermer</button>';
      }
      
      function closeReferencePanel() {
        const content = document.getElementById('reference-content');
        const buttons = document.querySelectorAll('.reference-btn');
        buttons.forEach(b => b.classList.remove('active'));
        content.classList.remove('active');
        content.innerHTML = '';
      }
      
      // Exposer la fonction globalement
      window.closeReferencePanel = closeReferencePanel;
      
      function formatTraitRef(trait) {
        const colonIndex = trait.indexOf(':');
        if (colonIndex > 0) {
          const name = trait.substring(0, colonIndex).trim();
          const desc = trait.substring(colonIndex + 1).trim();
          return `<li><strong>${name}</strong> : ${desc}</li>`;
        }
        return `<li>${trait}</li>`;
      }
      
      function renderRacesReference() {
        const currentRace = document.getElementById('race')?.value || '';
        
        let html = '<h3>📚 Races Disponibles</h3>';
        html += '<p style="text-align:center; color:#666; font-size:12px; margin-bottom:1rem;">Cliquez sur une race pour la sélectionner et appliquer ses bonus à la fiche</p>';
        html += '<div class="options-grid">';
        
        characterData.races.forEach(race => {
          const isSelected = currentRace === race.name;
          const bonusesHtml = race.bonuses?.length > 0 
            ? `<ul class="option-bonuses">${race.bonuses.map(b => formatTraitRef(b)).join('')}</ul>` 
            : '';
          const malusesHtml = race.maluses?.length > 0 
            ? `<ul class="option-maluses">${race.maluses.map(m => formatTraitRef(m)).join('')}</ul>` 
            : '';
          
          html += `
            <div class="option-card ref-item-interactive ${isSelected ? 'selected' : ''}" onclick="selectRaceFromRef('${race.id}')" style="cursor:pointer;">
              <img src="${getRaceImagePath(race.id)}" alt="${race.name}" class="option-img" onerror="this.style.display='none'">
              <div class="option-content">
                <div class="option-name">${isSelected ? '✓ ' : ''}${race.name}</div>
                <div class="option-desc">${race.description}</div>
                ${bonusesHtml}
                ${malusesHtml}
              </div>
            </div>
          `;
        });
        
        html += '</div>';
        return html;
      }
      
      function renderClassesReference() {
        const currentClass = document.getElementById('class')?.value || '';
        
        let html = '<h3>⚔️ Classes Disponibles</h3>';
        html += '<p style="text-align:center; color:#666; font-size:12px; margin-bottom:1rem;">Cliquez sur une classe pour la sélectionner (les avantages de classe seront mis à jour)</p>';
        html += '<div class="options-grid">';
        
        characterData.classes.forEach(cls => {
          const isSelected = currentClass === cls.name;
          const avantagesHtml = (cls.avantages || []).map(adv => 
            `<li><strong>${adv.name}</strong> : ${adv.description}</li>`
          ).join('');
          
          html += `
            <div class="option-card ref-item-interactive ${isSelected ? 'selected' : ''}" onclick="selectClassFromRef('${cls.id}')" style="cursor:pointer;">
              <img src="${getClassImagePath(cls.id)}" alt="${cls.name}" class="option-img" onerror="this.style.display='none'">
              <div class="option-content">
                <div class="option-name">${isSelected ? '✓ ' : ''}${cls.name}</div>
                <div class="option-desc">${cls.description}</div>
                ${avantagesHtml ? `<ul class="option-bonuses">${avantagesHtml}</ul>` : ''}
              </div>
            </div>
          `;
        });
        
        html += '</div>';
        return html;
      }
      
      function renderClassAdvantagesReference() {
        const currentClassName = document.getElementById('class')?.value || '';
        const currentClass = characterData.classes.find(c => c.name === currentClassName);
        
        let html = '<h3>🎯 Avantages par Classe</h3>';
        html += '<p style="text-align:center; color:#666; font-size:12px; margin-bottom:1rem;">Cliquez sur <span style="color:#27ae60;">+</span> pour ajouter ou <span style="color:#e74c3c;">−</span> pour retirer de la fiche</p>';
        
        // If a class is selected, show it first with highlight
        if (currentClass) {
          html += `<h4 class="advantages-section-title" style="background:#fff5f5; padding:0.5rem; border-radius:0.5rem;">⭐ ${currentClass.name} (Votre classe)</h4>`;
          html += '<div class="options-grid-4col">';
          
          (currentClass.avantages || []).forEach(adv => {
            const isOnSheet = isAdvantageOnSheet(adv.name);
            html += `
              <div class="option-card-simple ref-item-interactive ${isOnSheet ? 'ref-item-added' : ''}" data-adv-name="${adv.name}" data-adv-desc="${adv.description.replace(/"/g, '&quot;')}" data-source="classe">
                <button class="${isOnSheet ? 'ref-remove-btn' : 'ref-add-btn'}" onclick="toggleAdvantageOnSheet('${adv.name.replace(/'/g, "\\'")}', '${adv.description.replace(/'/g, "\\'")}', 'classe', this)">${isOnSheet ? '−' : '+'}</button>
                <div class="option-name">${adv.name}</div>
                <div class="option-desc">${adv.description}</div>
              </div>
            `;
          });
          
          html += '</div>';
          html += '<hr style="margin:1.5rem 0; border:none; border-top:2px dashed #ddd;">';
          html += '<p style="text-align:center; color:#999; font-size:11px; margin-bottom:1rem;">Autres classes (coût: 6 pts en Level Up)</p>';
        }
        
        // Show other classes
        characterData.classes.forEach(cls => {
          // Skip current class if already shown
          if (currentClass && cls.id === currentClass.id) return;
          
          html += `<h4 class="advantages-section-title">${cls.name}</h4>`;
          html += '<div class="options-grid-4col">';
          
          (cls.avantages || []).forEach(adv => {
            const isOnSheet = isAdvantageOnSheet(adv.name);
            html += `
              <div class="option-card-simple ref-item-interactive ${isOnSheet ? 'ref-item-added' : ''}" data-adv-name="${adv.name}" data-adv-desc="${adv.description.replace(/"/g, '&quot;')}" data-source="autre-classe">
                <button class="${isOnSheet ? 'ref-remove-btn' : 'ref-add-btn'}" onclick="toggleAdvantageOnSheet('${adv.name.replace(/'/g, "\\'")}', '${adv.description.replace(/'/g, "\\'")}', 'autre-classe', this)">${isOnSheet ? '−' : '+'}</button>
                <div class="option-name">${adv.name}</div>
                <div class="option-desc">${adv.description}</div>
              </div>
            `;
          });
          
          html += '</div>';
        });
        
        return html;
      }
      
      function renderGeneralAdvantagesReference() {
        let html = '<h3>✨ Avantages Généraux</h3>';
        html += '<p style="text-align:center; color:#666; font-size:12px; margin-bottom:1rem;">Cliquez sur <span style="color:#27ae60;">+</span> pour ajouter ou <span style="color:#e74c3c;">−</span> pour retirer de la fiche</p>';
        html += '<div class="options-grid-4col">';
        
        (characterData.avantagesGeneraux || []).forEach(adv => {
          const isOnSheet = isAdvantageOnSheet(adv.name);
          html += `
            <div class="option-card-simple ref-item-interactive ${isOnSheet ? 'ref-item-added' : ''}" data-adv-name="${adv.name}" data-adv-desc="${adv.description.replace(/"/g, '&quot;')}" data-source="general">
              <button class="${isOnSheet ? 'ref-remove-btn' : 'ref-add-btn'}" onclick="toggleAdvantageOnSheet('${adv.name.replace(/'/g, "\\'")}', '${adv.description.replace(/'/g, "\\'")}', 'general', this)">${isOnSheet ? '−' : '+'}</button>
              <div class="option-name">${adv.name}</div>
              <div class="option-desc">${adv.description}</div>
            </div>
          `;
        });
        
        html += '</div>';
        return html;
      }
      
      function renderCustomAdvantagesReference() {
        let html = '<h3>✦ Avantages Personnalisés de Classe</h3>';
        html += '<p style="text-align:center; color:#666; font-size:12px; margin-bottom:1rem;">Créez vos propres avantages en rapport avec votre classe (3 pts de création lors d\'un Level Up)</p>';
        html += '<p style="text-align:center; color:#8b0000; font-size:14px; margin-bottom:1rem;"><strong>Marqueur :</strong> ✦ (après le nom)</p>';
        
        html += '<div class="custom-advantage-creator">';
        html += `
          <div class="custom-adv-form" style="max-width:600px; margin:0 auto; padding:1rem; border:2px solid #333; border-radius:1rem; background:#f9f9f9;">
            <div style="margin-bottom:1rem;">
              <label style="display:block; font-weight:bold; margin-bottom:0.25rem;">Nom de l'avantage :</label>
              <input type="text" id="custom-adv-name" placeholder="Ex: Technique du Dragon" style="width:100%; padding:0.5rem; border:1px solid #ccc; border-radius:0.5rem; font-size:14px;" />
            </div>
            <div style="margin-bottom:1rem;">
              <label style="display:block; font-weight:bold; margin-bottom:0.25rem;">Description :</label>
              <textarea id="custom-adv-desc" placeholder="Décrivez l'effet de cet avantage..." rows="3" style="width:100%; padding:0.5rem; border:1px solid #ccc; border-radius:0.5rem; font-size:14px; resize:vertical;"></textarea>
            </div>
            <button onclick="addCustomAdvantageToSheet()" style="width:100%; padding:0.75rem; background:#8b0000; color:#fff; border:none; border-radius:0.5rem; font-size:16px; font-weight:bold; cursor:pointer;">+ Ajouter à la fiche</button>
          </div>
        `;
        html += '</div>';
        
        return html;
      }
      
      function renderSessionAdvantagesReference() {
        let html = '<h3>⟐ Avantages Gagnés en Session</h3>';
        html += '<p style="text-align:center; color:#666; font-size:12px; margin-bottom:1rem;">Ces avantages sont accordés par le MJ pendant les sessions de jeu. Ils ne peuvent pas être achetés avec des points de création.</p>';
        html += '<p style="text-align:center; color:#8b0000; font-size:14px; margin-bottom:1rem;"><strong>Marqueur :</strong> ⟐ (après le nom)</p>';
        
        html += '<div class="session-advantage-info" style="max-width:600px; margin:0 auto; padding:1.5rem; border:2px dashed #666; border-radius:1rem; background:#f5f5f5; text-align:center;">';
        html += `
          <p style="font-size:18px; color:#333; margin-bottom:1rem;">🎲 <strong>Comment ça marche ?</strong></p>
          <ul style="text-align:left; list-style:disc; padding-left:2rem; font-size:14px; color:#555;">
            <li style="margin-bottom:0.5rem;">Les avantages de session sont des récompenses narratives données par le MJ.</li>
            <li style="margin-bottom:0.5rem;">Ils représentent des capacités spéciales acquises pendant l'aventure (artefacts, bénédictions, mutations, etc.).</li>
            <li style="margin-bottom:0.5rem;">Seul le MJ peut vous attribuer ces avantages.</li>
            <li style="margin-bottom:0.5rem;">Ils sont identifiés par le symbole ⟐ après leur nom.</li>
          </ul>
          <hr style="margin:1.5rem 0; border:none; border-top:1px solid #ccc;" />
          <p style="font-size:14px; color:#666;">Pour ajouter manuellement un avantage de session :</p>
          <div style="margin-top:1rem;">
            <input type="text" id="session-adv-name" placeholder="Nom de l'avantage" style="width:100%; padding:0.5rem; border:1px solid #ccc; border-radius:0.5rem; font-size:14px; margin-bottom:0.5rem;" />
            <textarea id="session-adv-desc" placeholder="Description..." rows="2" style="width:100%; padding:0.5rem; border:1px solid #ccc; border-radius:0.5rem; font-size:14px; resize:vertical; margin-bottom:0.5rem;"></textarea>
            <button onclick="addSessionAdvantageToSheet()" style="width:100%; padding:0.5rem; background:#666; color:#fff; border:none; border-radius:0.5rem; font-size:14px; cursor:pointer;">⟐ Ajouter comme avantage de session</button>
          </div>
        `;
        html += '</div>';
        
        return html;
      }
      
      // Functions to add custom/session advantages to sheet
      function addCustomAdvantageToSheet() {
        const nameInput = document.getElementById('custom-adv-name');
        const descInput = document.getElementById('custom-adv-desc');
        
        const name = nameInput?.value?.trim();
        const desc = descInput?.value?.trim() || 'Pas de description';
        
        if (!name) {
          showNotification('❌ Veuillez entrer un nom pour l\'avantage', '#e74c3c');
          return;
        }
        
        // Add to abilities list
        const abilitySections = document.querySelectorAll('.section');
        abilitySections.forEach(section => {
          const h3 = section.querySelector('h3');
          if (h3 && (h3.textContent.includes('Capacités') || h3.textContent.includes('Avantages'))) {
            const list = section.querySelector('.abilities-list');
            if (list) {
              // Find first empty li or create new
              let emptyLi = null;
              for (const item of list.querySelectorAll('li')) {
                const content = item.innerHTML.replace(/<br\s*\/?>/gi, '').trim();
                if (!content) {
                  emptyLi = item;
                  break;
                }
              }
              
              const newContent = `<strong>${name} ✦</strong> : ${desc}`;
              
              if (emptyLi) {
                emptyLi.innerHTML = newContent;
                cleanupEmptyListItems(list);
              } else {
                const li = document.createElement('li');
                li.innerHTML = newContent;
                list.appendChild(li);
              }
            }
          }
        });
        
        // Clear inputs
        nameInput.value = '';
        descInput.value = '';
        
        showNotification(`✅ "${name} ✦" ajouté à la fiche`, '#27ae60');
      }
      
      function addSessionAdvantageToSheet() {
        const nameInput = document.getElementById('session-adv-name');
        const descInput = document.getElementById('session-adv-desc');
        
        const name = nameInput?.value?.trim();
        const desc = descInput?.value?.trim() || 'Accordé par le MJ';
        
        if (!name) {
          showNotification('❌ Veuillez entrer un nom pour l\'avantage', '#e74c3c');
          return;
        }
        
        // Add to abilities list
        const abilitySections = document.querySelectorAll('.section');
        abilitySections.forEach(section => {
          const h3 = section.querySelector('h3');
          if (h3 && (h3.textContent.includes('Capacités') || h3.textContent.includes('Avantages'))) {
            const list = section.querySelector('.abilities-list');
            if (list) {
              // Find first empty li or create new
              let emptyLi = null;
              for (const item of list.querySelectorAll('li')) {
                const content = item.innerHTML.replace(/<br\s*\/?>/gi, '').trim();
                if (!content) {
                  emptyLi = item;
                  break;
                }
              }
              
              const newContent = `<strong>${name} ⟐</strong> : ${desc}`;
              
              if (emptyLi) {
                emptyLi.innerHTML = newContent;
                cleanupEmptyListItems(list);
              } else {
                const li = document.createElement('li');
                li.innerHTML = newContent;
                list.appendChild(li);
              }
            }
          }
        });
        
        // Clear inputs
        nameInput.value = '';
        descInput.value = '';
        
        showNotification(`✅ "${name} ⟐" ajouté à la fiche`, '#27ae60');
      }
      
      function renderCompetencesReference() {
        let html = '<h3>📝 Compétences</h3>';
        html += '<p style="text-align:center; color:#666; font-size:12px; margin-bottom:1rem;">Utilisez les boutons <span style="color:#8b0000;">−</span> et <span style="color:#27ae60;">+</span> pour ajuster les bonus</p>';
        html += '<div class="comp-distribute">';
        
        // Trier par nom alphabétique
        const sortedComps = [...characterData.competences].sort((a, b) => a.name.localeCompare(b.name));
        
        sortedComps.forEach(comp => {
          const currentBonus = getCompetenceBonus(comp.name);
          const isOnSheet = currentBonus > 0;
          html += `
            <div class="comp-item ref-comp-item ${isOnSheet ? 'added' : ''}" data-comp-name="${comp.name}" data-comp-attr="${comp.attribut}">
              <div class="comp-info">
                <span class="comp-name">${comp.name}</span>
                <span class="comp-attr">${comp.attribut}</span>
              </div>
              <div class="comp-controls">
                <button onclick="adjustCompetenceOnSheet('${comp.name}', '${comp.attribut}', -1, this.closest('.ref-comp-item'))" ${currentBonus <= 0 ? 'disabled' : ''}>−</button>
                <span class="comp-value">${currentBonus > 0 ? '+' + currentBonus : '+0'}</span>
                <button onclick="adjustCompetenceOnSheet('${comp.name}', '${comp.attribut}', 1, this.closest('.ref-comp-item'))">+</button>
              </div>
            </div>
          `;
        });
        
        html += '</div>';
        return html;
      }
      
      // Helper functions for reference panel interactivity
      function isAdvantageOnSheet(advName) {
        const abilitySections = document.querySelectorAll('.section');
        let found = false;
        abilitySections.forEach(section => {
          const h3 = section.querySelector('h3');
          if (h3 && (h3.textContent.includes('Capacités') || h3.textContent.includes('Avantages'))) {
            const list = section.querySelector('.abilities-list');
            if (list) {
              list.querySelectorAll('li').forEach(li => {
                if (li.textContent.includes(advName)) {
                  found = true;
                }
              });
            }
          }
        });
        return found;
      }
      
      function getCompetenceBonus(compName) {
        const skillRows = document.querySelectorAll('.skill-table tbody tr');
        for (const row of skillRows) {
          const nameInput = row.querySelector('td:first-child input');
          if (nameInput && nameInput.value.trim() === compName) {
            const bonusInput = row.querySelector('td:last-child input');
            if (bonusInput) {
              return parseInt(bonusInput.value.replace(/[^0-9-]/g, '')) || 0;
            }
          }
        }
        return 0;
      }
      
      function toggleAdvantageOnSheet(name, description, source, btnElement) {
        const abilitySections = document.querySelectorAll('.section');
        let targetList = null;
        
        abilitySections.forEach(section => {
          const h3 = section.querySelector('h3');
          if (h3 && (h3.textContent.includes('Capacités') || h3.textContent.includes('Avantages'))) {
            targetList = section.querySelector('.abilities-list');
          }
        });
        
        if (!targetList) return;
        
        const isOnSheet = isAdvantageOnSheet(name);
        const card = btnElement.closest('.ref-item-interactive');
        
        if (isOnSheet) {
          // Remove from sheet
          const items = targetList.querySelectorAll('li');
          items.forEach(li => {
            if (li.textContent.includes(name)) {
              li.remove();
            }
          });
          // Update button and card
          btnElement.className = 'ref-add-btn';
          btnElement.textContent = '+';
          card.classList.remove('ref-item-added');
          showNotification(`❌ "${name}" retiré de la fiche`, '#e74c3c');
        } else {
          // Add to sheet with appropriate marker (after name)
          let marker = '';
          if (source === 'general') {
            marker = ' ◆';
          } else if (source === 'autre-classe') {
            marker = ' ⬡';
          } else if (source === 'custom') {
            marker = ' ✦';
          } else if (source === 'session') {
            marker = ' ⟐';
          }
          
          const newContent = `<strong>${name}${marker}</strong> : ${description}`;
          
          // Find first empty li (check for empty innerHTML, only <br>, or only whitespace)
          let emptyLi = null;
          const allItems = targetList.querySelectorAll('li');
          for (const item of allItems) {
            const content = item.innerHTML.replace(/<br\s*\/?>/gi, '').trim();
            if (!content) {
              emptyLi = item;
              break;
            }
          }
          
          if (emptyLi) {
            emptyLi.innerHTML = newContent;
            // Clean up remaining empty placeholders after this one
            cleanupEmptyListItems(targetList);
          } else {
            const li = document.createElement('li');
            li.innerHTML = newContent;
            targetList.appendChild(li);
          }
          
          // Update button and card
          btnElement.className = 'ref-remove-btn';
          btnElement.textContent = '−';
          card.classList.add('ref-item-added');
          
          const sourceLabel = source === 'general' ? '(Général)' : source === 'autre-classe' ? '(Autre classe)' : '(Classe)';
          showNotification(`✅ "${name}" ajouté ${sourceLabel}`, '#27ae60');
        }
      }
      
      // Helper to clean up empty list items at the end of a list
      function cleanupEmptyListItems(list) {
        const items = list.querySelectorAll('li');
        // Remove empty items from the end
        for (let i = items.length - 1; i >= 0; i--) {
          const content = items[i].innerHTML.replace(/<br\s*\/?>/gi, '').trim();
          if (!content) {
            items[i].remove();
          } else {
            break; // Stop at first non-empty item from the end
          }
        }
      }
      
      function adjustCompetenceOnSheet(name, attr, delta, itemElement) {
        const tbody = document.querySelector('.skill-table tbody');
        if (!tbody) return;
        
        const currentBonus = getCompetenceBonus(name);
        const newBonus = currentBonus + delta;
        
        // Find existing row
        let existingRow = null;
        const rows = tbody.querySelectorAll('tr');
        for (const row of rows) {
          const nameInput = row.querySelector('td:first-child input');
          if (nameInput && nameInput.value.trim() === name) {
            existingRow = row;
            break;
          }
        }
        
        if (newBonus <= 0) {
          // Remove from sheet if exists
          if (existingRow) {
            existingRow.remove();
          }
          // Update UI
          itemElement.classList.remove('added');
          itemElement.querySelector('.comp-value').textContent = '+0';
          // Disable minus button
          const minusBtn = itemElement.querySelector('.comp-controls button:first-child');
          if (minusBtn) minusBtn.disabled = true;
          
          if (delta < 0) {
            showNotification(`❌ "${name}" retiré de la fiche`, '#e74c3c');
          }
        } else {
          if (existingRow) {
            // Update existing row
            const bonusInput = existingRow.querySelector('td:last-child input');
            if (bonusInput) {
              bonusInput.value = '+' + newBonus;
            }
          } else {
            // Find first empty placeholder row or create new one
            let emptyRow = null;
            for (const row of rows) {
              const nameInput = row.querySelector('td:first-child input');
              if (nameInput && !nameInput.value.trim()) {
                emptyRow = row;
                break;
              }
            }
            
            if (emptyRow) {
              // Use the empty placeholder row
              const inputs = emptyRow.querySelectorAll('input');
              if (inputs[0]) inputs[0].value = name;
              if (inputs[1]) inputs[1].value = attr;
              if (inputs[2]) inputs[2].value = '+' + newBonus;
              // Clean up remaining empty rows after this one
              cleanupEmptySkillRows(tbody);
            } else {
              // Create new row
              const newRow = document.createElement('tr');
              newRow.innerHTML = `
              <td><input value="${name}" /></td>
              <td><input value="${attr}" /></td>
              <td><input type="text" value="+${newBonus}" style="text-align:center;" /></td>
            `;
              tbody.appendChild(newRow);
            }
          }
          
          // Update UI
          itemElement.classList.add('added');
          itemElement.querySelector('.comp-value').textContent = '+' + newBonus;
          // Enable minus button
          const minusBtn = itemElement.querySelector('.comp-controls button:first-child');
          if (minusBtn) minusBtn.disabled = false;
          
          if (delta > 0) {
            showNotification(`✅ "${name}" : +${newBonus}`, '#27ae60');
          } else {
            showNotification(`📝 "${name}" : +${newBonus}`, '#f39c12');
          }
        }
      }
      
      // Helper to clean up empty skill table rows at the end
      function cleanupEmptySkillRows(tbody) {
        const rows = Array.from(tbody.querySelectorAll('tr'));
        // Remove empty rows from the end
        for (let i = rows.length - 1; i >= 0; i--) {
          const nameInput = rows[i].querySelector('td:first-child input');
          if (nameInput && !nameInput.value.trim()) {
            rows[i].remove();
          } else {
            break; // Stop at first non-empty row from the end
          }
        }
      }
      
      // Mapping complet des bonus/malus de caractéristiques par race
      const raceAttrBonuses = {
        'cryx': { sag: 2 },            // Mage-né : +2 niveaux de dé en Sagesse
        'troll': { force: 2, dex: 2, sag: -2, int: -2 }, // Évolution : +2 For/Dex, −2 Sag/Int
        'ogre': { int: 2 },            // Esprit scientifique : +2 niveaux de dé en Intelligence
        'canitaure': { emp: 1, dex: 1 }, // Chef naturel : +1 Charisme, +1 Dextérité
        'gravel': { force: 2, dex: -1 }, // Force gravitationnelle : +2 Force, Lenteur : −1 Dex
        'centaure': { force: 1 }       // +1 niveau de dé en Force
        // Dryade: +1 carac au choix (arbre-cœur) - géré via popup
      };
      
      // Mapping des bonus/malus de compétences par race
      const raceCompBonuses = {
        'cryx': { 'diplomatie': 3 },       // Pacifistes : commence avec Diplomatie à 3
        'orc': { 'perception': 1, 'discretion': 1 }, // Aware : +1 en Perception et Discrétion
        'troll': { 'volonte': -5 },        // Esprit faible : −5 en Volonté
        'canitaure': { 'athletisme': 2 },  // Rapide : +2 en Athlétisme
        'lustrien': { 'discretion': -5 }   // Outsider : −5 en Discrétion
      };
      
      // Pour stocker le bonus de caractéristique choisi par la Dryade
      let dryadeChosenAttr = null;
      
      // Variable pour stocker la race actuellement appliquée sur la fiche
      let currentAppliedRaceId = null;
      
      // Détecte la race actuellement sur la fiche
      function detectCurrentRaceFromSheet() {
        const raceName = document.getElementById('race')?.value || '';
        const race = characterData.races.find(r => r.name === raceName);
        return race ? race.id : null;
      }
      
      // Progression des dés
      const diceProgression = [4, 6, 8, 10, 12];
      
      // Obtient la valeur actuelle d'un attribut sur la fiche (dé + bonus)
      function getSheetAttribute(attrId) {
        const input = document.getElementById(attrId);
        if (!input) return { die: 10, bonus: 0 };
        
        const dieValue = parseInt(input.value) || 10;
        const box = input.closest('.attr-box');
        const bonusInput = box?.querySelector('input[type="text"]');
        const bonusValue = parseInt(bonusInput?.value?.replace(/[^0-9-]/g, '')) || 0;
        
        return { die: dieValue, bonus: bonusValue };
      }
      
      // Met à jour un attribut sur la fiche
      function setSheetAttribute(attrId, dieValue, bonusValue) {
        const input = document.getElementById(attrId);
        if (!input) return;
        
        input.value = dieValue;
        input.dispatchEvent(new Event('input')); // Met à jour l'affichage du dé
        
        const box = input.closest('.attr-box');
        const bonusInput = box?.querySelector('input[type="text"]');
        if (bonusInput) {
          bonusInput.value = bonusValue > 0 ? `+${bonusValue}` : '+0';
        }
      }
      
      // Applique un modificateur à un attribut (positif ou négatif)
      function applyAttrModifier(attrId, modifier) {
        const current = getSheetAttribute(attrId);
        let newDie = current.die;
        let newBonus = current.bonus;
        
        if (modifier > 0) {
          // Bonus positif : augmenter
          for (let i = 0; i < modifier; i++) {
            const dieIndex = diceProgression.indexOf(newDie);
            if (dieIndex < diceProgression.length - 1) {
              // Peut encore augmenter le dé
              newDie = diceProgression[dieIndex + 1];
            } else {
              // Déjà au D12, augmenter le bonus
              newBonus++;
            }
          }
        } else if (modifier < 0) {
          // Malus : diminuer
          for (let i = 0; i < Math.abs(modifier); i++) {
            if (newBonus > 0) {
              // Réduire le bonus d'abord
              newBonus--;
            } else {
              // Puis réduire le dé
              const dieIndex = diceProgression.indexOf(newDie);
              if (dieIndex > 0) {
                newDie = diceProgression[dieIndex - 1];
              }
              // Ne pas descendre en dessous de D4
            }
          }
        }
        
        setSheetAttribute(attrId, newDie, newBonus);
      }
      
      // Retire les bonus d'une race (caractéristiques seulement)
      function removeRaceBonuses(raceId) {
        const bonuses = raceAttrBonuses[raceId];
        if (!bonuses) return;
        
        // Appliquer l'inverse des bonus
        for (const [attr, value] of Object.entries(bonuses)) {
          applyAttrModifier(attr, -value);
        }
        
        // Si c'était une Dryade, retirer aussi son bonus choisi
        if (raceId === 'dryade') {
          removeDryadeBonus();
        }
      }
      
      // Applique les bonus d'une race
      function applyRaceAttrBonuses(raceId) {
        const bonuses = raceAttrBonuses[raceId];
        if (!bonuses) return;
        
        for (const [attr, value] of Object.entries(bonuses)) {
          applyAttrModifier(attr, value);
        }
      }
      
      // Applique les bonus de compétences d'une race
      function applyRaceCompBonuses(raceId) {
        const bonuses = raceCompBonuses[raceId];
        if (!bonuses) return;
        
        for (const [compId, value] of Object.entries(bonuses)) {
          applyCompetenceModifier(compId, value);
        }
      }
      
      // Retire les bonus de compétences d'une race
      function removeRaceCompBonuses(raceId) {
        const bonuses = raceCompBonuses[raceId];
        if (!bonuses) return;
        
        for (const [compId, value] of Object.entries(bonuses)) {
          applyCompetenceModifier(compId, -value);
        }
      }
      
      // Applique un modificateur à une compétence sur la fiche
      function applyCompetenceModifier(compId, value) {
        const comp = characterData.competences.find(c => c.id === compId);
        if (!comp) return;
        
        // Chercher la compétence dans le tableau
        const table = document.querySelector('.skill-table tbody');
        if (!table) return;
        
        const rows = table.querySelectorAll('tr');
        let found = false;
        
        for (const row of rows) {
          const nameInput = row.querySelector('td:first-child input');
          if (nameInput && nameInput.value.toLowerCase().includes(comp.name.toLowerCase())) {
            const bonusInput = row.querySelector('td:last-child input');
            if (bonusInput) {
              const currentBonus = parseInt(bonusInput.value) || 0;
              bonusInput.value = currentBonus + value;
              found = true;
              break;
            }
          }
        }
        
        // Si la compétence n'existe pas sur la fiche, l'ajouter
        if (!found && value > 0) {
          // Trouver une ligne vide ou en créer une
          let emptyRow = null;
          for (const row of rows) {
            const nameInput = row.querySelector('td:first-child input');
            if (nameInput && !nameInput.value.trim()) {
              emptyRow = row;
              break;
            }
          }
          
          if (!emptyRow) {
            // Créer une nouvelle ligne
            emptyRow = document.createElement('tr');
            emptyRow.innerHTML = '<td><input /></td><td><input placeholder="' + comp.attribut + '" /></td><td><input type="number" placeholder="+0" /></td>';
            table.appendChild(emptyRow);
          }
          
          const nameInput = emptyRow.querySelector('td:first-child input');
          const attrInput = emptyRow.querySelector('td:nth-child(2) input');
          const bonusInput = emptyRow.querySelector('td:last-child input');
          
          if (nameInput) nameInput.value = comp.name;
          if (attrInput) attrInput.value = comp.attribut;
          if (bonusInput) bonusInput.value = value;
        }
      }
      
      // Affiche un popup modal pour choisir une caractéristique (Dryade)
      function showDryadeAttrPopup(callback) {
        const overlay = document.createElement('div');
        overlay.className = 'modal-overlay';
        
        const content = document.createElement('div');
        content.className = 'modal-content';
        
        content.innerHTML = `
          <h3>🌳 Arbre-cœur de la Dryade</h3>
          <p>Choisissez la caractéristique qui bénéficiera de +1 niveau de dé grâce à votre objet en arbre-cœur :</p>
          <div class="modal-buttons">
            <button class="modal-btn" data-attr="force">Force</button>
            <button class="modal-btn" data-attr="dex">Dextérité</button>
            <button class="modal-btn" data-attr="emp">Charisme</button>
            <button class="modal-btn" data-attr="sag">Sagesse</button>
            <button class="modal-btn" data-attr="int">Intelligence</button>
          </div>
          <div style="margin-top:1rem;">
            <button class="modal-btn modal-btn-cancel" data-cancel="true">Annuler</button>
          </div>
        `;
        
        overlay.appendChild(content);
        document.body.appendChild(overlay);
        
        // Event listeners
        content.querySelectorAll('.modal-btn').forEach(btn => {
          btn.addEventListener('click', () => {
            const attr = btn.dataset.attr;
            const cancel = btn.dataset.cancel;
            
            overlay.remove();
            
            if (cancel) {
              callback(null);
            } else if (attr) {
              callback(attr);
            }
          });
        });
        
        // Cliquer sur l'overlay ferme le popup
        overlay.addEventListener('click', (e) => {
          if (e.target === overlay) {
            overlay.remove();
            callback(null);
          }
        });
      }
      
      // Applique le bonus de caractéristique choisi pour la Dryade
      function applyDryadeBonus(attr) {
        if (!attr) return;
        dryadeChosenAttr = attr;
        applyAttrModifier(attr, 1);
      }
      
      // Retire le bonus de caractéristique de la Dryade
      function removeDryadeBonus() {
        if (dryadeChosenAttr) {
          applyAttrModifier(dryadeChosenAttr, -1);
          dryadeChosenAttr = null;
        }
      }
      
      function selectRaceFromRef(raceId) {
        const race = characterData.races.find(r => r.id === raceId);
        if (!race) return;
        
        // Détecter la race actuellement sur la fiche
        const previousRaceId = detectCurrentRaceFromSheet();
        
        // Si c'est la même race, ne rien faire
        if (previousRaceId === raceId) {
          showNotification(`ℹ️ "${race.name}" est déjà sélectionnée`, '#3498db');
          return;
        }
        
        // Fonction pour finaliser le changement de race
        function finalizeRaceChange(dryadeAttrChoice = null) {
          // Retirer les bonus de l'ancienne race
          if (previousRaceId) {
            removeRaceBonuses(previousRaceId);
            removeRaceCompBonuses(previousRaceId);
            
            // Si l'ancienne race était Dryade, retirer son bonus
            if (previousRaceId === 'dryade') {
              removeDryadeBonus();
            }
          }
          
          // Appliquer les bonus de caractéristiques de la nouvelle race
          applyRaceAttrBonuses(raceId);
          
          // Appliquer les bonus de compétences de la nouvelle race
          applyRaceCompBonuses(raceId);
          
          // Si c'est une Dryade, appliquer le bonus choisi
          if (raceId === 'dryade' && dryadeAttrChoice) {
            applyDryadeBonus(dryadeAttrChoice);
          }
          
          // Update race field on sheet
          const raceField = document.getElementById('race');
          if (raceField) {
            raceField.value = race.name;
          }
          
          // Update bonus de race section
          updateBonusDeRaceSection(race);
          
          // Recalculer PV/PF si possible
          recalculatePVPF();
          
          // Re-render the races reference to update selection
          renderReferenceContent('races');
          
          // Construire le message de notification
          let details = [];
          
          // Détails des bonus de carac retirés
          const oldAttrBonuses = previousRaceId ? raceAttrBonuses[previousRaceId] : null;
          if (oldAttrBonuses) {
            for (const [attr, val] of Object.entries(oldAttrBonuses)) {
              const sign = val > 0 ? '+' : '';
              details.push(`${sign}${val} ${attr.toUpperCase()} retiré`);
            }
          }
          if (previousRaceId === 'dryade' && dryadeChosenAttr === null) {
            details.push(`+1 carac Dryade retiré`);
          }
          
          // Détails des bonus de carac appliqués
          const newAttrBonuses = raceAttrBonuses[raceId];
          if (newAttrBonuses) {
            for (const [attr, val] of Object.entries(newAttrBonuses)) {
              const sign = val > 0 ? '+' : '';
              details.push(`${sign}${val} ${attr.toUpperCase()} appliqué`);
            }
          }
          if (raceId === 'dryade' && dryadeAttrChoice) {
            details.push(`+1 ${dryadeAttrChoice.toUpperCase()} (arbre-cœur)`);
          }
          
          // Détails des bonus de compétences
          const oldCompBonuses = previousRaceId ? raceCompBonuses[previousRaceId] : null;
          if (oldCompBonuses) {
            for (const [comp, val] of Object.entries(oldCompBonuses)) {
              const compName = characterData.competences.find(c => c.id === comp)?.name || comp;
              details.push(`${val > 0 ? '+' : ''}${val} ${compName} retiré`);
            }
          }
          
          const newCompBonuses = raceCompBonuses[raceId];
          if (newCompBonuses) {
            for (const [comp, val] of Object.entries(newCompBonuses)) {
              const compName = characterData.competences.find(c => c.id === comp)?.name || comp;
              details.push(`${val > 0 ? '+' : ''}${val} ${compName}`);
            }
          }
          
          const detailStr = details.length > 0 ? ` (${details.join(', ')})` : '';
          showNotification(`✅ Race "${race.name}" sélectionnée${detailStr}`, '#27ae60');
        }
        
        // Si c'est une Dryade, afficher le popup pour choisir la caractéristique
        if (raceId === 'dryade') {
          showDryadeAttrPopup((chosenAttr) => {
            if (chosenAttr) {
              finalizeRaceChange(chosenAttr);
            } else {
              showNotification(`❌ Sélection de la Dryade annulée`, '#e74c3c');
            }
          });
        } else {
          finalizeRaceChange();
        }
      }
      
      // Met à jour la section "Bonus de race" sur la fiche
      function updateBonusDeRaceSection(race) {
        // Chercher dans les sections .section ou .half-section
        const allSections = document.querySelectorAll('.section, .half-section');
        allSections.forEach(section => {
          const h3 = section.querySelector('h3');
          if (h3 && h3.textContent.includes('Bonus de race')) {
            const list = section.querySelector('.abilities-list');
            if (list) {
              const allTraits = [];
              if (race.bonuses) {
                race.bonuses.forEach(b => allTraits.push(formatTraitRef(b)));
              }
              if (race.maluses && race.maluses.length > 0) {
                race.maluses.forEach(m => allTraits.push(formatTraitRef(m)));
              }
              list.innerHTML = allTraits.join('');
            }
          }
        });
      }
      
      // Recalcule PV et PF
      function recalculatePVPF() {
        const forceAttr = getSheetAttribute('force');
        const intAttr = getSheetAttribute('int');
        const level = parseInt(document.getElementById('level')?.value) || 1;
        
        // Valeur totale = dé + bonus extra
        const forceValue = forceAttr.die + forceAttr.bonus;
        const intValue = intAttr.die + intAttr.bonus;
        
        // PV = FOR×2 + INT×2 + 10 + Niveau
        const pv = (forceValue * 2) + (intValue * 2) + 10 + level;
        // PF = PV
        const pf = pv;
        
        const pvMaxField = document.getElementById('pv-max');
        const pvCurrentField = document.getElementById('pv-current');
        const pfMaxField = document.getElementById('pf-max');
        const pfCurrentField = document.getElementById('pf-current');
        
        if (pvMaxField) pvMaxField.value = pv;
        if (pvCurrentField) pvCurrentField.value = pv;
        if (pfMaxField) pfMaxField.value = pf;
        if (pfCurrentField) pfCurrentField.value = pf;
      }
      
      function selectClassFromRef(classId) {
        const cls = characterData.classes.find(c => c.id === classId);
        if (!cls) return;
        
        // Update class field on sheet
        const classField = document.getElementById('class');
        if (classField) {
          classField.value = cls.name;
        }
        
        // Re-render the classes reference to update selection
        renderReferenceContent('classes');
        
        showNotification(`✅ Classe "${cls.name}" sélectionnée - Les avantages de classe ont été mis à jour`, '#27ae60');
      }
      
      // Expose functions globally for onclick handlers
      window.toggleAdvantageOnSheet = toggleAdvantageOnSheet;
      window.adjustCompetenceOnSheet = adjustCompetenceOnSheet;
      window.selectRaceFromRef = selectRaceFromRef;
      window.selectClassFromRef = selectClassFromRef;
      window.addCustomAdvantageToSheet = addCustomAdvantageToSheet;
      window.addSessionAdvantageToSheet = addSessionAdvantageToSheet;
      
      // Initialiser le panneau de référence
      initReferencePanel();
    })();
  </script>